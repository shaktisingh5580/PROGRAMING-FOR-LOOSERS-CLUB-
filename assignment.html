<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PFL - Assignments Hub</title>
  <link rel="icon" href="HummingBird (1).png" type="image/x-icon" />
  <link rel="manifest" href="manifest.json" />
  
  <!-- Tailwind CSS for the new navigation bar -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- CSS for the new Anime Navigation Bar -->
  <style>
      @keyframes shine {
          0% { transform: translateX(-100%); }
          50% { transform: translateX(100%); }
          100% { transform: translateX(-100%); }
      }
      
      @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-12px); }
      }
      
      @keyframes bounce {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(8px); }
      }
      
      @keyframes glow {
          0%, 100% { opacity: 0.3; transform: scale(1); }
          50% { opacity: 0.5; transform: scale(1.03); }
      }
      
      @keyframes sparkle {
          0% { opacity: 0; transform: scale(0) rotate(0deg); }
          50% { opacity: 1; transform: scale(1) rotate(180deg); }
          100% { opacity: 0; transform: scale(0) rotate(360deg); }
      }
      
      @keyframes blink {
          0%, 90%, 100% { transform: scaleY(1); }
          95% { transform: scaleY(0.2); }
      }
      
      .anime-nav {
          backdrop-filter: blur(16px);
          -webkit-backdrop-filter: blur(16px);
      }
      
      .glow-effect {
          animation: glow 2s ease-in-out infinite;
      }
      
      .shine-effect {
          animation: shine 3s ease-in-out infinite;
      }
      
      .float-animation {
          animation: float 2s ease-in-out infinite;
      }
      
      .bounce-animation {
          animation: bounce 1s ease-in-out infinite 0.5s;
      }
      
      .sparkle-animation {
          animation: sparkle 0.6s ease-in-out;
      }
      
      .blink-animation {
          animation: blink 3s ease-in-out infinite;
      }
      
      .mascot-container {
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .nav-item {
          transition: all 0.3s ease;
      }
      
      .nav-item:hover {
          transform: scale(1.05);
      }
      
      .mobile-icon {
          transition: transform 0.2s ease;
      }
      
      .mobile-icon:hover {
          transform: scale(1.2);
      }
      
      .mobile-icon:active {
          transform: scale(0.9);
      }
  </style>

  <!-- Original CSS for the page content -->
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f0f10;
      --elev: #151517;
      --elev-2: #1b1b1e;
      --muted: #d9d9db;
      --soft: #a9a9ad;
      --line: #2a2a2e;
      --accent: #ffffff;
      --ok: #43d17a;
      --warn: #e7c74f;
      --danger: #ff5d5d;
      --primary: #4f46e5;
      --primary-hover: #4338ca;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    /* Using the new nav's body background for consistency */
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
      color: var(--muted);
      line-height: 1.6;
      min-height: 100vh;
      background-color: #000; /* Fallback */
    }
    
    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem 0.5rem;
      }
    }
    
    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--accent), var(--soft));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .page-subtitle {
      color: var(--soft);
      font-size: 1.1rem;
    }
    
    @media (max-width: 768px) {
      .page-title {
        font-size: 2rem;
      }
      
      .page-subtitle {
        font-size: 1rem;
      }
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white;
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
    }
    
    .btn-outline {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--line);
    }
    
    .btn-outline:hover {
      background: var(--elev);
      border-color: var(--primary);
      color: var(--accent);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 768px) {
      .btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
    }
    
    /* Mobile Filters Toggle */
    .mobile-filters-toggle {
      display: none;
      background: var(--elev-2);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mobile-filters-toggle:hover {
      background: var(--elev);
      border-color: var(--primary);
    }
    
    .mobile-filters-toggle .toggle-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      color: var(--accent);
    }
    
    .mobile-filters-toggle .toggle-icon {
      transition: transform 0.2s;
    }
    
    .mobile-filters-toggle.collapsed .toggle-icon {
      transform: rotate(180deg);
    }
    
    @media (max-width: 768px) {
      .mobile-filters-toggle {
        display: block;
      }
    }
    
    /* Filters Section */
    .filters-section {
      background: var(--elev-2);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }
    
    .filters-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      font-weight: 600;
      color: var(--accent);
    }
    
    .filters-grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    @media (min-width: 768px) {
      .filters-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    
    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filter-field label {
      font-weight: 500;
      color: var(--soft);
      font-size: 0.9rem;
    }
    
    .filter-field input,
    .filter-field select {
      padding: 0.75rem;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--elev);
      color: var(--muted);
      font-size: 1rem;
      transition: all 0.2s;
      outline: none;
    }
    
    .filter-field input:focus,
    .filter-field select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      background: var(--bg);
    }
    
    .filter-field input::placeholder {
      color: var(--soft);
    }
    
    .filter-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .filters-section {
        padding: 1rem;
        max-height: 0;
        opacity: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
      }
      
      .filters-section.expanded {
        max-height: 1000px;
        opacity: 1;
        margin-bottom: 2rem;
        padding: 1rem;
      }
      
      .filter-actions {
        flex-direction: column;
      }
      
      .filter-actions .btn {
        width: 100%;
      }
    }
    
    /* Upload Button */
    .upload-section {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .upload-btn {
      background: linear-gradient(135deg, var(--ok), #2dd4bf);
      color: white;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(67, 209, 122, 0.3);
    }
    
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(67, 209, 122, 0.4);
    }
    
    /* Assignments Grid */
    .assignments-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }

    @media (max-width: 768px) {
      .assignments-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
    }
    
    @media (max-width: 480px) {
      .assignments-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
    
    /* Assignment Cards */
    .assignment-card {
      background: var(--elev-2);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .assignment-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
      border-color: var(--primary);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .card-title-meta {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex-grow: 1; /* Allow title to take space */
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
      line-height: 1.3;
      padding-right: 0.5rem; /* Space for buttons */
    }
    
    .card-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--soft);
    }
    
    .uploader-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .uploader-link:hover {
      color: var(--primary-hover);
      text-decoration: underline;
    }

    .card-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0; /* Prevent buttons from shrinking */
    }

    .btn-icon {
        background: transparent;
        border: none;
        color: var(--soft);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: var(--elev);
        color: var(--accent);
    }

    .btn-icon.edit-btn:hover { color: var(--warn); }
    .btn-icon.delete-btn:hover { color: var(--danger); }
    
    .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .card-info {
      display: grid;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-label {
      color: var(--soft);
      font-weight: 500;
    }
    
    .info-value {
      color: var(--muted);
      font-weight: 600;
    }
    
    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .keyword-tag {
      background: rgba(79, 70, 229, 0.1);
      color: var(--primary);
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
      border: 1px solid rgba(79, 70, 229, 0.2);
    }
    
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--line);
    }
    
    .vote-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .vote-btn {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--soft);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }
    
    .vote-btn:hover {
      background: var(--elev);
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(1.1);
    }
    
    .vote-btn.voted {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .vote-count {
      font-weight: 600;
      color: var(--muted);
      min-width: 2ch;
      text-align: center;
    }
    
    .view-btn {
      background: var(--primary);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .view-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    /* Mobile assignment cards - smaller for 2x2 */
    @media (max-width: 768px) {
      .assignment-card {
        padding: 0.75rem;
        font-size: 0.85rem;
      }
      
      .card-title {
        font-size: 0.95rem;
        line-height: 1.2;
      }
      
      .card-meta {
        font-size: 0.7rem;
      }
      
      .info-item {
        font-size: 0.8rem;
      }
      
      .keyword-tag {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
      }
      
      .card-footer {
        padding-top: 0.75rem;
        flex-direction: row;
        gap: 0.5rem;
      }
      
      .vote-btn {
        width: 32px;
        height: 32px;
      }
      
      .view-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }
    
    @media (max-width: 480px) {
      .assignment-card {
        padding: 1rem;
      }
      
      .card-footer {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
      }
      
      .vote-section {
        justify-content: center;
      }
      
      .view-btn {
        text-align: center;
        padding: 0.75rem;
      }
    }
    
    /* Loading and Empty States */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4rem 0;
      grid-column: 1 / -1;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--line);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      grid-column: 1 / -1;
      color: var(--soft);
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .empty-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--muted);
    }
    
    .empty-description {
      font-size: 0.9rem;
    }
    
    /* Icons */
    .icon {
      width: 1.2em;
      height: 1.2em;
      display: inline-block;
    }
    
    /* Modal Styles */
    dialog {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--elev-2);
      color: var(--muted);
      padding: 0;
      max-width: 500px;
      width: calc(100% - 2rem);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
    }
    
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 1.1rem;
      background: var(--elev);
      border-radius: 16px 16px 0 0;
    }
    
    .modal-body {
      padding: 1.5rem;
      display: grid;
      gap: 1rem;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      background: var(--elev);
      border-radius: 0 0 16px 16px;
    }
    
    .form-field {
      display: grid;
      gap: 0.5rem;
    }
    
    .form-field label {
      color: var(--soft);
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 0.75rem;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--elev);
      color: var(--muted);
      font-size: 1rem;
      transition: all 0.2s;
      outline: none;
      font-family: inherit;
    }

    .form-field select[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      background: var(--bg);
    }
    
    .form-field input::placeholder,
    .form-field textarea::placeholder {
      color: var(--soft);
    }
    
    .form-hint {
      font-size: 0.8rem;
      color: var(--soft);
      margin-top: 0.25rem;
    }
    
    .message {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 1rem;
    }
    
    .message.success {
      background: rgba(67, 209, 122, 0.1);
      color: var(--ok);
      border: 1px solid rgba(67, 209, 122, 0.2);
    }
    
    .message.error {
      background: rgba(255, 93, 93, 0.1);
      color: var(--danger);
      border: 1px solid rgba(255, 93, 93, 0.2);
    }
    
    @media (max-width: 768px) {
      dialog {
        width: calc(100% - 1rem);
        max-height: 95vh;
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-footer .btn {
        width: 100%;
      }
    }
    
    /* Profile Modal */
    .profile-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--ok));
      color: white;
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    
    .profile-info {
      display: grid;
      gap: 0.75rem;
    }
    
    .profile-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--line);
    }
    
    .profile-field:last-child {
      border-bottom: none;
    }
    
    .profile-field .label {
      color: var(--soft);
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .profile-field .value {
      color: var(--muted);
      font-weight: 600;
    }
    
    .profile-links {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
      justify-content: center;
    }
    
    .profile-link {
      padding: 0.5rem 1rem;
      border: 1px solid var(--line);
      border-radius: 20px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
      background: var(--elev);
    }
    
    .profile-link:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }
    
    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Focus styles */
    .btn:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Hidden utility */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="min-h-screen bg-black">
  <!-- NEW: Fixed Anime Navigation -->
  <div class="fixed top-5 left-0 right-0 z-50">
      <div class="flex justify-center pt-6">
          <div class="relative w-fit">
              <div class="anime-nav flex items-center gap-3 bg-gray-900/80 border border-gray-700/50 py-2 px-2 rounded-full shadow-2xl relative">
                  
                  <!-- Home -->
                  <a href="index.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="Home">
                      <!-- Changed from hidden md:inline to always show text on desktop, hide only on mobile -->
                      <span class="hidden sm:inline relative">Home</span>
                      <svg class="sm:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                      </svg>
                  </a>
                  
                  <!-- Chat -->
                  <a href="chat.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="Chat">
                      <!-- Changed from hidden md:inline to always show text on desktop, hide only on mobile -->
                      <span class="hidden sm:inline relative">Chat</span>
                      <svg class="sm:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                      </svg>
                  </a>
                  
                  <!-- Assignments (Active Page) -->
                  <a href="assignment.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-white active-tab" data-tab="Assignments">
                      <!-- Changed from hidden md:inline to always show text on desktop, hide only on mobile -->
                      <span class="hidden sm:inline relative">Assignments</span>
                      <svg class="sm:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                  </a>
                  
                  <!-- Profile -->
                  <a href="profile.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="Profile">
                      <!-- Changed from hidden md:inline to always show text on desktop, hide only on mobile -->
                      <span class="hidden sm:inline relative">Profile</span>
                      <svg class="sm:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                      </svg>
                  </a>

                  <!-- PYQ's -->
                  <a href="pyqs.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="PYQs">
                      <!-- Changed from hidden md:inline to always show text on desktop, hide only on mobile -->
                      <span class="hidden sm:inline relative">PYQ's</span>
                      <svg class="sm:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                      </svg>
                  </a>
                  
                  <!-- Active Tab Glow Effect -->
                  <div class="glow-container absolute top-0 left-0 rounded-full -z-10 overflow-hidden opacity-0"></div>
                  
                  <!-- Hover Effect -->
                  <div class="hover-effect absolute top-0 left-0 bg-white/5 rounded-full -z-10 opacity-0 transition-opacity duration-300"></div>
              </div>
          </div>
      </div>
  </div>
  
  <!-- Anime Mascot -->
  <div class="mascot-container absolute top-0 left-1/2 transform -translate-x-1/2 pointer-events-none z-[60] opacity-0" style="top: 35px;">
      <div class="relative w-12 h-12">
          <!-- Main Head -->
          <div class="mascot-head absolute w-10 h-10 bg-white rounded-full left-1/2 transform -translate-x-1/2 float-animation shadow-lg">
              <!-- Left Eye -->
              <div class="mascot-eye-left absolute transition-all duration-300" style="left: 20%; top: 35%;">
                  <div class="w-3 h-3 bg-black rounded-full relative blink-animation">
                      <!-- Eye shine -->
                      <div class="absolute w-1 h-1 bg-white rounded-full" style="top: 20%; right: 20%;"></div>
                      <div class="absolute w-0.5 h-0.5 bg-white rounded-full" style="bottom: 30%; left: 30%;"></div>
                  </div>
              </div>
              
              <!-- Right Eye -->
              <div class="mascot-eye-right absolute transition-all duration-300" style="right: 20%; top: 35%;">
                  <div class="w-3 h-3 bg-black rounded-full relative blink-animation">
                      <!-- Eye shine -->
                      <div class="absolute w-1 h-1 bg-white rounded-full" style="top: 20%; left: 20%;"></div>
                      <div class="absolute w-0.5 h-0.5 bg-white rounded-full" style="bottom: 30%; right: 30%;"></div>
                  </div>
              </div>
              
              <!-- Mouth -->
              <div class="mascot-mouth absolute left-1/2 transform -translate-x-1/2 transition-all duration-300 opacity-0" style="top: 60%;">
                  <div class="w-4 h-2 border-2 border-black border-t-0 rounded-b-full"></div>
              </div>
              
              <!-- Sparkles -->
              <div class="sparkle-1 absolute -top-1 -right-1 w-2 h-2 text-yellow-300 opacity-0 transition-all duration-300">✨</div>
              <div class="sparkle-2 absolute -top-2 left-0 w-2 h-2 text-yellow-300 opacity-0 transition-all duration-300">✨</div>
              <div class="sparkle-3 absolute -bottom-1 -left-1 w-2 h-2 text-blue-300 opacity-0 transition-all duration-300">💫</div>
          </div>
          
          <!-- Speech Bubble Tail -->
          <div class="absolute -bottom-1 left-1/2 w-4 h-4 transform -translate-x-1/2 bounce-animation">
              <div class="w-full h-full bg-white rotate-45 transform origin-center shadow-lg"></div>
          </div>
      </div>
  </div>


  <!-- Main Content - Added pt-32 for padding below fixed nav -->
  <main class="container pt-32">
    <div class="page-header">
      <h1 class="page-title">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Assignments Hub
      </h1>
      <p class="page-subtitle">Share, discover, and vote on the best programming assignments</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <button id="upload-btn" class="btn upload-btn">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        Upload Assignment
      </button>
    </div>

    <!-- Mobile Filters Toggle -->
    <div class="mobile-filters-toggle collapsed" id="mobile-filters-toggle">
      <div class="toggle-content">
        <span>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
          </svg>
          Filter & Search
        </span>
        <svg class="toggle-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" id="filters-section">
      <div class="filters-header">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
        </svg>
        Filter & Search
      </div>
      
      <div class="filters-grid">
        <div class="filter-field">
          <label for="search-input">Search Assignments</label>
          <input 
            type="text" 
            id="search-input" 
            placeholder="Search by title, subject, or keywords..."
          />
        </div>
        
        <div class="filter-field">
          <label for="semester-filter">Semester</label>
          <select id="semester-filter">
            <option value="">All Semesters</option>
          </select>
        </div>
        
        <div class="filter-field">
          <label for="subject-filter">Subject</label>
          <select id="subject-filter">
            <option value="">All Subjects</option>
          </select>
        </div>
        
        <div class="filter-field">
            <label for="branch-filter">Branch</label>
            <select id="branch-filter">
              <option value="">All Branches</option>
            </select>
        </div>
        
        <div class="filter-field">
          <label for="sort-select">Sort By</label>
          <select id="sort-select">
            <option value="uploadDate_desc">Newest First</option>
            <option value="votes_desc">Most Voted</option>
            <option value="uploadDate_asc">Oldest First</option>
          </select>
        </div>
      </div>
      
      <div class="filter-actions">
        <button id="apply-filters-btn" class="btn btn-primary">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          Apply Filters
        </button>
        <button id="reset-filters-btn" class="btn btn-outline">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Reset
        </button>
      </div>
    </div>

    <!-- Assignments Grid -->
    <div id="assignments-grid" class="assignments-grid">
      <div class="loading-container">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </main>

  <!-- Upload Modal -->
  <dialog id="upload-modal">
    <form method="dialog" id="upload-form">
      <div class="modal-header">
        <strong>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Assignment
        </strong>
        <button class="btn btn-outline" value="cancel">Close</button>
      </div>
      <div class="modal-body">
        <div class="form-field">
          <label for="assignment-title">Assignment Title *</label>
          <input type="text" id="assignment-title" placeholder="e.g., Data Structures Lab 1" required maxlength="100"/>
        </div>
        <div class="form-field">
          <label for="subject">Subject *</label>
          <input type="text" id="subject" placeholder="e.g., Computer Science" required maxlength="50"/>
        </div>
        <div class="form-field">
          <label for="semester">Semester *</label>
          <select id="semester" required>
            <option value="">Select Semester</option>
            <option value="1">1st Semester</option>
            <option value="2">2nd Semester</option>
            <option value="3">3rd Semester</option>
            <option value="4">4th Semester</option>
            <option value="5">5th Semester</option>
            <option value="6">6th Semester</option>
            <option value="7">7th Semester</option>
            <option value="8">8th Semester</option>
          </select>
        </div>
        <div class="form-field">
            <label for="branch">Branch *</label>
            <select id="branch" required>
                <!-- Options populated by JS -->
            </select>
        </div>
        <div class="form-field">
          <label for="assignment-number">Assignment Number</label>
          <input type="text" id="assignment-number" placeholder="e.g., 1, 2, Lab-1" maxlength="20"/>
        </div>
        <div class="form-field">
          <label for="drive-link">Google Drive Link *</label>
          <input type="url" id="drive-link" placeholder="https://drive.google.com/..." required/>
          <div class="form-hint">Make sure the link is publicly accessible</div>
        </div>
        <div class="form-field">
          <label for="keywords">Keywords (comma-separated)</label>
          <input type="text" id="keywords" placeholder="e.g., arrays, sorting, algorithms" maxlength="200"/>
          <div class="form-hint">Help others find your assignment</div>
        </div>
        <div id="upload-message" class="message" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" id="submit-upload">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Assignment
        </button>
        <button type="button" class="btn btn-outline" id="cancel-upload">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Edit Modal -->
  <dialog id="edit-modal">
    <form method="dialog" id="edit-form">
      <div class="modal-header">
        <strong>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
          Edit Assignment
        </strong>
        <button class="btn btn-outline" value="cancel">Close</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-assignment-id">
        <div class="form-field"><label for="edit-assignment-title">Assignment Title *</label><input type="text" id="edit-assignment-title" required maxlength="100" /></div>
        <div class="form-field"><label for="edit-subject">Subject *</label><input type="text" id="edit-subject" required maxlength="50" /></div>
        <div class="form-field">
          <label for="edit-semester">Semester *</label>
          <select id="edit-semester" required>
            <option value="">Select Semester</option>
            <option value="1">1st Semester</option><option value="2">2nd Semester</option><option value="3">3rd Semester</option><option value="4">4th Semester</option>
            <option value="5">5th Semester</option><option value="6">6th Semester</option><option value="7">7th Semester</option><option value="8">8th Semester</option>
          </select>
        </div>
        <div class="form-field">
            <label for="edit-branch">Branch *</label>
            <select id="edit-branch" required></select>
        </div>
        <div class="form-field"><label for="edit-assignment-number">Assignment Number</label><input type="text" id="edit-assignment-number" maxlength="20" /></div>
        <div class="form-field"><label for="edit-drive-link">Google Drive Link *</label><input type="url" id="edit-drive-link" required /></div>
        <div class="form-field"><label for="edit-keywords">Keywords (comma-separated)</label><input type="text" id="edit-keywords" maxlength="200" /></div>
        <div id="edit-message" class="message" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" id="submit-update">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
            Save Changes
        </button>
        <button type="button" class="btn btn-outline" id="cancel-edit">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Profile Modal -->
  <dialog id="profile-modal">
    <form method="dialog">
      <div class="modal-header"><strong id="profile-modal-title">User Profile</strong><button class="btn btn-outline" value="cancel">Close</button></div>
      <div class="modal-body">
        <div class="profile-avatar" id="profile-avatar"></div>
        <div class="profile-info" id="profile-info"></div>
      </div>
    </form>
  </dialog>


  <!-- NEW: JavaScript for the Anime Navigation Bar (CORRECTED) -->
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          const navItems = document.querySelectorAll('.nav-item');
          const mascotContainer = document.querySelector('.mascot-container');
          const glowContainer = document.querySelector('.glow-container');
          const hoverEffect = document.querySelector('.hover-effect');
          
          const mouth = document.querySelector('.mascot-mouth');
          const leftEye = document.querySelector('.mascot-eye-left div');
          const rightEye = document.querySelector('.mascot-eye-right div');
          
          let activeTab = document.querySelector('.nav-item.active-tab')?.dataset.tab || 'Home';
          
          // Function to move the mascot and glow effect
          function updateActiveElementPosition() {
              const activeItem = document.querySelector(`[data-tab="${activeTab}"]`);
              if (activeItem) {
                  const rect = activeItem.getBoundingClientRect();
                  const containerRect = activeItem.closest('.anime-nav').getBoundingClientRect();
                  
                  // Center mascot above the active item
                  const mascotLeft = rect.left + rect.width / 2;
                  mascotContainer.style.left = `${mascotLeft}px`;
                  mascotContainer.style.opacity = '1';
                  
                  // Position glow effect under the active item
                  glowContainer.style.left = `${rect.left - containerRect.left}px`;
                  glowContainer.style.width = `${rect.width}px`;
                  glowContainer.style.height = `${rect.height}px`; // FIX: Added height
                  glowContainer.style.opacity = '1';
              }
          }
          
          // Handle navigation clicks
          navItems.forEach(item => {
              // Click redirects to the href, so we just manage visuals on hover
              item.addEventListener('mouseenter', function() {
                  const tabName = this.dataset.tab;
                  if (tabName !== activeTab) {
                      const rect = this.getBoundingClientRect();
                      const containerRect = this.closest('.anime-nav').getBoundingClientRect();
                      hoverEffect.style.left = `${rect.left - containerRect.left}px`;
                      hoverEffect.style.width = `${rect.width}px`;
                      hoverEffect.style.height = `${rect.height}px`; // FIX: Added height
                      hoverEffect.style.opacity = '1';
                  }
              });
              
              item.addEventListener('mouseleave', function() {
                  hoverEffect.style.opacity = '0';
              });
          });
          
          // Handle window resize to keep mascot in place
          window.addEventListener('resize', updateActiveElementPosition);
          
          // Initial position setup after a short delay for rendering
          setTimeout(() => {
              updateActiveElementPosition();
          }, 100);
      });
  </script>

  <!-- Original Page JavaScript Logic (Preserved) -->
  <script type="module">
    // NOTE: Ensure you have a `js/auth.js` file that exports these functions.
    // This is a placeholder for your actual auth setup.
    // Example `js/auth.js` would initialize Firebase and export auth, db, etc.
    import { auth, db, initAuth, signOutUser, redirectToLogin } from './js/auth.js'; 
    import {
      collection, addDoc, getDocs, query, orderBy, serverTimestamp,
      doc, getDoc as getFirestoreDoc, updateDoc, deleteDoc, increment, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- DOM Elements ---
    const assignmentsGrid = document.getElementById('assignments-grid');
    const userAvatar = document.getElementById('user-avatar'); // Note: This is from the old header. It won't be visible.
    const userName = document.getElementById('user-name'); // This also won't be visible.
    const logoutBtn = document.getElementById('logout-btn'); // This won't be visible.
    const loginLink = document.getElementById('login-link'); // This won't be visible.
    const searchInput = document.getElementById('search-input');
    const semesterFilter = document.getElementById('semester-filter');
    const subjectFilter = document.getElementById('subject-filter');
    const branchFilter = document.getElementById('branch-filter');
    const sortSelect = document.getElementById('sort-select');
    const applyFiltersBtn = document.getElementById('apply-filters-btn');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    const mobileFiltersToggle = document.getElementById('mobile-filters-toggle');
    const filtersSection = document.getElementById('filters-section');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadModal = document.getElementById('upload-modal');
    const uploadForm = document.getElementById('upload-form');
    const submitUpload = document.getElementById('submit-upload');
    const cancelUpload = document.getElementById('cancel-upload');
    const uploadMessage = document.getElementById('upload-message');
    const assignmentTitleEl = document.getElementById('assignment-title');
    const subjectEl = document.getElementById('subject');
    const semesterEl = document.getElementById('semester');
    const branchEl = document.getElementById('branch');
    const assignmentNumberEl = document.getElementById('assignment-number');
    const driveLinkEl = document.getElementById('drive-link');
    const keywordsEl = document.getElementById('keywords');
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const cancelEdit = document.getElementById('cancel-edit');
    const editMessage = document.getElementById('edit-message');
    const editAssignmentIdEl = document.getElementById('edit-assignment-id');
    const editAssignmentTitleEl = document.getElementById('edit-assignment-title');
    const editSubjectEl = document.getElementById('edit-subject');
    const editSemesterEl = document.getElementById('edit-semester');
    const editBranchEl = document.getElementById('edit-branch');
    const editAssignmentNumberEl = document.getElementById('edit-assignment-number');
    const editDriveLinkEl = document.getElementById('edit-drive-link');
    const editKeywordsEl = document.getElementById('edit-keywords');
    const profileModal = document.getElementById('profile-modal');
    const profileModalTitle = document.getElementById('profile-modal-title');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileInfo = document.getElementById('profile-info');

    // --- Global State & Constants ---
    let allAssignments = [];
    let userNamesCache = {};
    let currentUser = null;
    let currentProfile = null;
    let isInitialLoad = true;
    const profileCache = new Map();
    const BRANCHES = ['AI ML', 'Data Science', 'Computer Science', 'EC', 'Electrical', 'IT'];

    // --- Conditional Branch Logic ---
    const setupBranchDropdown = (semesterSelect, branchSelect) => {
        const semester = parseInt(semesterSelect.value, 10);
        if (semester >= 3) {
            branchSelect.innerHTML = `<option value="">Select Branch</option>`;
            BRANCHES.forEach(b => branchSelect.add(new Option(b, b)));
            branchSelect.disabled = false;
            branchSelect.required = true;
        } else {
            branchSelect.innerHTML = `<option value="Common" selected>Common for All Branches</option>`;
            branchSelect.disabled = true;
            branchSelect.required = false;
        }
    };
    
    semesterEl.addEventListener('change', () => setupBranchDropdown(semesterEl, branchEl));
    editSemesterEl.addEventListener('change', () => setupBranchDropdown(editSemesterEl, editBranchEl));

    // --- Core Functions ---
    async function fetchAssignments() {
      assignmentsGrid.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div></div>`;
      try {
        const q = query(collection(db, "assignments"), orderBy("uploadDate", "desc"));
        const snapshot = await getDocs(q);
        allAssignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateAllFilters();
        applyCurrentFilters();
      } catch (error) {
        console.error("Error fetching assignments:", error);
        assignmentsGrid.innerHTML = `<div class="empty-state"><h3>Error loading data</h3><p>Please check your connection and try again.</p></div>`;
      }
    }

    async function renderAssignments(assignmentsToRender) {
      assignmentsGrid.innerHTML = '';
      if (assignmentsToRender.length === 0) {
        assignmentsGrid.innerHTML = `<div class="empty-state"><div class="empty-icon">📁</div><div class="empty-title">No assignments found</div><div class="empty-description">Try adjusting your filters or be the first to upload!</div></div>`;
        return;
      }

      const uploaderIds = [...new Set(assignmentsToRender.map(a => a.uploaderId))];
      await Promise.all(uploaderIds.map(id => fetchUploaderName(id)));

      for (const assignment of assignmentsToRender) {
        const card = document.createElement('div');
        card.className = 'assignment-card';
        const uploadDate = assignment.uploadDate?.toDate ? assignment.uploadDate.toDate().toLocaleDateString() : 'N/A';
        const uploaderName = userNamesCache[assignment.uploaderId] || 'Anonymous';
        const userHasVoted = currentUser && assignment.votedBy?.includes(currentUser.uid);
        const isOwner = currentUser && currentUser.uid === assignment.uploaderId;

        let cardActionsHTML = '';
        if (isOwner) {
            cardActionsHTML = `
                <div class="card-actions">
                    <button class="btn-icon edit-btn" data-id="${assignment.id}" title="Edit"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                    <button class="btn-icon delete-btn" data-id="${assignment.id}" data-title="${assignment.assignmentTitle}" title="Delete"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>`;
        }
        
        const branchInfo = (assignment.branch && assignment.branch !== 'Common') 
            ? `<div class="info-item"><span class="info-label">Branch</span><span class="info-value">${assignment.branch}</span></div>` : '';

        card.innerHTML = `
          <div class="card-header">
            <div class="card-title-meta">
              <div class="card-title">${assignment.assignmentTitle || 'Untitled'}</div>
              <div class="card-meta">
                <span class="uploader-link" data-uid="${assignment.uploaderId}">${uploaderName}</span> • <span>${uploadDate}</span>
              </div>
            </div>
            ${cardActionsHTML}
          </div>
          <div class="card-body">
            <div class="card-info">
              <div class="info-item"><span class="info-label">Subject</span><span class="info-value">${assignment.subject || 'N/A'}</span></div>
              ${branchInfo}
              <div class="info-item"><span class="info-label">Semester</span><span class="info-value">${getOrdinalSuffix(assignment.semester)}</span></div>
              ${assignment.assignmentNumber ? `<div class="info-item"><span class="info-label">Asgn. No.</span><span class="info-value">${assignment.assignmentNumber}</span></div>` : ''}
            </div>
            ${assignment.keywords?.length > 0 ? `<div class="keywords">${assignment.keywords.map(k => `<span class="keyword-tag">${k}</span>`).join('')}</div>` : ''}
          </div>
          <div class="card-footer">
            <div class="vote-section">
              <button class="vote-btn ${userHasVoted ? 'voted' : ''}" data-assignment-id="${assignment.id}"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg></button>
              <span class="vote-count">${assignment.votes || 0}</span>
            </div>
            <a href="${assignment.driveLink || '#'}" target="_blank" rel="noopener noreferrer" class="view-btn"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg> View Assignment</a>
          </div>`;
        assignmentsGrid.appendChild(card);
      }
    }

    async function handleUploadSubmit(e) {
      e.preventDefault();
      if (!currentUser) return showMessage(uploadMessage, 'Please sign in to upload.');

      const assignmentData = {
        assignmentTitle: assignmentTitleEl.value.trim(), subject: subjectEl.value.trim(),
        semester: semesterEl.value, branch: branchEl.value,
        assignmentNumber: assignmentNumberEl.value.trim(), driveLink: driveLinkEl.value.trim(),
        keywords: keywordsEl.value.trim().split(',').map(k => k.trim()).filter(Boolean),
        uploaderId: currentUser.uid, uploaderEmail: currentUser.email,
        uploadDate: serverTimestamp(), votes: 0, votedBy: []
      };

      if (!assignmentData.assignmentTitle || !assignmentData.subject || !assignmentData.semester || !assignmentData.branch || !assignmentData.driveLink) {
        return showMessage(uploadMessage, 'Please fill in all required fields.');
      }
      if (assignmentData.semester >= 3 && !BRANCHES.includes(assignmentData.branch)) {
          return showMessage(uploadMessage, 'Please select a valid branch for this semester.');
      }

      const originalText = submitUpload.innerHTML;
      submitUpload.innerHTML = '<div class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></div> Uploading...';
      submitUpload.disabled = true;

      try {
        await addDoc(collection(db, 'assignments'), assignmentData);
        showMessage(uploadMessage, 'Assignment uploaded successfully!', false);
        setTimeout(() => { uploadModal.close(); fetchAssignments(); }, 1500);
      } catch (error) {
        console.error('Error uploading:', error);
        showMessage(uploadMessage, 'Failed to upload. Please try again.');
      } finally {
        submitUpload.innerHTML = originalText;
        submitUpload.disabled = false;
      }
    }

    function handleEditClick(assignmentId) {
        const assignment = allAssignments.find(a => a.id === assignmentId);
        if (!assignment) return;
        hideMessage(editMessage);
        editAssignmentIdEl.value = assignment.id;
        editAssignmentTitleEl.value = assignment.assignmentTitle || '';
        editSubjectEl.value = assignment.subject || '';
        editSemesterEl.value = assignment.semester || '';
        setupBranchDropdown(editSemesterEl, editBranchEl);
        editBranchEl.value = assignment.branch || '';
        editAssignmentNumberEl.value = assignment.assignmentNumber || '';
        editDriveLinkEl.value = assignment.driveLink || '';
        editKeywordsEl.value = (assignment.keywords || []).join(', ');
        editModal.showModal();
    }

    async function handleUpdateSubmit(e) {
        e.preventDefault();
        const assignmentId = editAssignmentIdEl.value;
        const submitBtn = document.getElementById('submit-update');
        const updatedData = {
            assignmentTitle: editAssignmentTitleEl.value.trim(), subject: editSubjectEl.value.trim(),
            semester: editSemesterEl.value, branch: editBranchEl.value,
            assignmentNumber: editAssignmentNumberEl.value.trim(), driveLink: editDriveLinkEl.value.trim(),
            keywords: editKeywordsEl.value.trim().split(',').map(k => k.trim()).filter(Boolean)
        };

        if (!updatedData.assignmentTitle || !updatedData.subject || !updatedData.semester || !updatedData.branch || !updatedData.driveLink) {
            return showMessage(editMessage, 'Please fill in all required fields.');
        }
        if (updatedData.semester >= 3 && !BRANCHES.includes(updatedData.branch)) {
          return showMessage(editMessage, 'Please select a valid branch for this semester.');
        }
        
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></div> Saving...';
        submitBtn.disabled = true;

        try {
            await updateDoc(doc(db, 'assignments', assignmentId), updatedData);
            showMessage(editMessage, 'Update successful!', false);
            setTimeout(() => { editModal.close(); fetchAssignments(); }, 1500);
        } catch(error) {
            console.error("Error updating:", error);
            showMessage(editMessage, 'Failed to update. Please try again.');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    async function handleDeleteClick(assignmentId, assignmentTitle) {
        if (!confirm(`Are you sure you want to delete "${assignmentTitle}"?`)) return;
        try {
            await deleteDoc(doc(db, "assignments", assignmentId));
            alert('Assignment deleted.');
            fetchAssignments();
        } catch (error) {
            console.error("Error deleting:", error);
            alert('Failed to delete. Please try again.');
        }
    }

    async function handleVote(assignmentId) {
        if (!currentUser) return redirectToLogin();
        const assignmentRef = doc(db, "assignments", assignmentId);
        const voteButton = document.querySelector(`.vote-btn[data-assignment-id="${assignmentId}"]`);
        voteButton.disabled = true;
        try {
            const docSnap = await getFirestoreDoc(assignmentRef);
            if (!docSnap.exists()) throw new Error("Assignment not found");
            const hasVoted = (docSnap.data().votedBy || []).includes(currentUser.uid);
            await updateDoc(assignmentRef, {
                votes: increment(hasVoted ? -1 : 1),
                votedBy: hasVoted ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid)
            });
            const voteCountSpan = voteButton.nextElementSibling;
            voteCountSpan.textContent = parseInt(voteCountSpan.textContent) + (hasVoted ? -1 : 1);
            voteButton.classList.toggle('voted', !hasVoted);
        } catch (error) {
            console.error('Vote error:', error);
            fetchAssignments();
        } finally {
            voteButton.disabled = false;
        }
    }

    // --- Filtering and Sorting ---
    function populateAllFilters() {
      const getUniqueValues = key => [...new Set(allAssignments.map(a => a[key]).filter(Boolean))].sort();
      populateFilterDropdown(semesterFilter, getUniqueValues('semester').sort((a,b) => a-b), 'All Semesters');
      populateFilterDropdown(subjectFilter, getUniqueValues('subject'), 'All Subjects');
      populateFilterDropdown(branchFilter, getUniqueValues('branch'), 'All Branches');
    }

    function populateFilterDropdown(selectElement, items, defaultOptionText) {
      const currentValue = selectElement.value;
      selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
      items.forEach(item => selectElement.add(new Option(item, item)));
      selectElement.value = currentValue;
    }

    function applyCurrentFilters() {
      if (!allAssignments) return;
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedSemester = semesterFilter.value;
      const selectedSubject = subjectFilter.value;
      const selectedBranch = branchFilter.value;
      const sortByValue = sortSelect.value;

      let filtered = allAssignments.filter(a =>
        (searchTerm ? [a.assignmentTitle, a.subject, a.branch, ...(a.keywords || [])].join(' ').toLowerCase().includes(searchTerm) : true) &&
        (selectedSemester ? a.semester === selectedSemester : true) &&
        (selectedSubject ? a.subject === selectedSubject : true) &&
        (selectedBranch ? a.branch === selectedBranch : true)
      );

      filtered.sort((a, b) => {
        if (sortByValue === 'votes_desc') return (b.votes || 0) - (a.votes || 0);
        if (sortByValue === 'uploadDate_asc') return (a.uploadDate?.toMillis?.() || 0) - (b.uploadDate?.toMillis?.() || 0);
        return (b.uploadDate?.toMillis?.() || 0) - (a.uploadDate?.toMillis?.() || 0);
      });
      renderAssignments(filtered);
    }

    function resetAllFilters() {
      searchInput.value = '';
      semesterFilter.value = '';
      subjectFilter.value = '';
      branchFilter.value = '';
      sortSelect.value = 'uploadDate_desc';
      applyCurrentFilters();
    }
    
    // --- Utility & Helper Functions ---
    const getOrdinalSuffix = nStr => { const n=parseInt(nStr,10); if(isNaN(n))return typeof nStr==='string'?nStr:''; const s=["th","st","nd","rd"], v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]); };
    
    // This function no longer has elements to update in the DOM, but we keep it for state management.
    const updateAuthUI = () => { 
        if (currentUser) {
            console.log("User is logged in:", currentUser.email);
        } else {
            console.log("User is a guest.");
        }
    };

    const showMessage = (el,txt,err=true) => { el.textContent=txt; el.className=`message ${err?'error':'success'}`; el.style.display='block'; };
    const hideMessage = el => { el.style.display='none'; };
    const resetUploadForm = () => { uploadForm.reset(); hideMessage(uploadMessage); setupBranchDropdown(semesterEl, branchEl); };
    async function fetchUploaderName(uid) { if (!uid || userNamesCache[uid]) return; try { const p = await loadProfile(uid); userNamesCache[uid] = p?.name || 'Anonymous'; } catch (err) { userNamesCache[uid] = 'Anonymous'; } }
    async function loadProfile(uid) { if (profileCache.has(uid)) return profileCache.get(profileCache.has(uid)); try { const ref = doc(db, 'profiles', uid); const snap = await getFirestoreDoc(ref); if (snap.exists()) { const data = { id: snap.id, ...snap.data() }; profileCache.set(uid, data); return data; } return null; } catch (e) { return null; } }
    async function openProfileModal(uid) { try { const profile = await loadProfile(uid); if (!profile) return alert('Could not load user profile.'); profileModalTitle.textContent = profile.name || 'User Profile'; profileAvatar.textContent = profile.name ? profile.name[0].toUpperCase() : '?'; profileInfo.innerHTML = ''; const fields = [{label:'Name',value:profile.name||'N/A'},{label:'College',value:profile.college||'N/A'},{label:'Semester',value:profile.semester?getOrdinalSuffix(profile.semester):'N/A'}]; fields.forEach(f=>{const el=document.createElement('div');el.className='profile-field';el.innerHTML=`<span class="label">${f.label}</span><span class="value">${f.value}</span>`;profileInfo.appendChild(el)}); const links=document.createElement('div'); links.className='profile-links'; if (profile.instagram) links.innerHTML += `<a href="https://instagram.com/${profile.instagram}" target="_blank" rel="noopener noreferrer" class="profile-link">Instagram</a>`; if (profile.github) links.innerHTML += `<a href="${profile.github}" target="_blank" rel="noopener noreferrer" class="profile-link">GitHub</a>`; if (profile.linkedin) links.innerHTML += `<a href="${profile.linkedin}" target="_blank" rel="noopener noreferrer" class="profile-link">LinkedIn</a>`; if (links.children.length > 0) profileInfo.appendChild(links); profileModal.showModal(); } catch (e) { console.error('Error opening profile modal:', e); alert('Failed to open profile.'); } }

    // --- Event Listeners ---
    assignmentsGrid.addEventListener('click', (e) => {
        const voteBtn = e.target.closest('.vote-btn');
        if (voteBtn) return handleVote(voteBtn.dataset.assignmentId);
        const uploaderLink = e.target.closest('.uploader-link');
        if (uploaderLink) return openProfileModal(uploaderLink.dataset.uid);
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) return handleEditClick(editBtn.dataset.id);
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) return handleDeleteClick(deleteBtn.dataset.id, deleteBtn.dataset.title);
    });
    
    // Note: logoutBtn is no longer in the HTML, so this listener won't attach.
    // You'll need a new logout button or link in your profile page.
    if(logoutBtn) logoutBtn.addEventListener('click', signOutUser);
    
    applyFiltersBtn.addEventListener('click', applyCurrentFilters);
    resetFiltersBtn.addEventListener('click', resetAllFilters);
    sortSelect.addEventListener('change', applyCurrentFilters);
    mobileFiltersToggle.addEventListener('click', () => { mobileFiltersToggle.classList.toggle('collapsed'); filtersSection.classList.toggle('expanded'); });
    uploadBtn.addEventListener('click', () => { if (!currentUser) return redirectToLogin(); resetUploadForm(); uploadModal.showModal(); });
    uploadForm.addEventListener('submit', handleUploadSubmit);
    cancelUpload.addEventListener('click', () => uploadModal.close());
    editForm.addEventListener('submit', handleUpdateSubmit);
    cancelEdit.addEventListener('click', () => editModal.close());
    window.addEventListener('resize', () => { if (window.innerWidth > 768) { filtersSection.classList.remove('expanded'); mobileFiltersToggle.classList.add('collapsed'); } });

    // --- App Initialization ---
    initAuth({
      onAuthStateChanged: (user, profile) => {
        currentUser = user;
        currentProfile = profile;
        updateAuthUI();
        if (isInitialLoad) {
          fetchAssignments();
          isInitialLoad = false;
        } else {
          // Re-render assignments to update voted status or owner controls
          applyCurrentFilters();
        }
      }
    });

    if (window.innerWidth <= 768) { mobileFiltersToggle.classList.add('collapsed'); filtersSection.classList.remove('expanded'); }
    setupBranchDropdown(semesterEl, branchEl);
  </script>
</body>
</html>
