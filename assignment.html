<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>PFL - Assignments Hub</title>
  <link rel="icon" href="HummingBird (1).png" type="image/x-icon" />
  <link rel="manifest" href="manifest.json" />
  <style>
    /* Mobile-First CSS Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      color: #e0e0e0;
      font-size: 14px; /* Mobile base font size */
      background-color: #0c0c0c;
      padding-top: 60px; /* Mobile header height */
    }
    /* Desktop font size */
    @media (min-width: 768px) {
      body { font-size: 16px; padding-top: 80px; }
    }
    .container {
      width: 95%; /* More space on mobile */
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px; /* Reduced mobile padding */
      position: relative;
      z-index: 1;
    }
    @media (min-width: 768px) {
      .container { width: 90%; padding: 20px; }
    }
    /* Header */
    header {
      background-color: rgba(10, 10, 10, 0.95);
      padding: 0.5rem 0; /* Compact mobile header */
      position: fixed;
      width: 100%;
      top: 0; left: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    @media (min-width: 768px) { header { padding: 1.2rem 0; } }
    nav {
      display: flex; justify-content: space-between; align-items: center;
      width: 95%; max-width: 1200px; margin: 0 auto; padding: 0 10px;
    }
    @media (min-width: 768px) { nav { width: 90%; padding: 0 20px; } }
    .logo { font-size: 1.2rem; font-weight: bold; color: #fff; }
    @media (min-width: 768px) { .logo { font-size: 1.7rem; } }

    .header-nav-links { display: flex; gap: 8px; }
    .header-nav-links a {
      color: #ccc; text-decoration: none; font-size: 0.75rem;
      transition: color 0.3s ease, text-shadow 0.3s ease; padding: 4px 6px;
    }
    .header-nav-links a:hover { color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.7); }
    @media (min-width: 768px) {
      .header-nav-links { gap: 25px; }
      .header-nav-links a { font-size: 1rem; padding: 0; }
    }

    .user-auth-info { display: flex; align-items: center; color: #fff; gap: 6px; }
    .user-auth-info span {
      font-size: 0.7rem; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px;
    }
    @media (min-width: 768px) {
      .user-auth-info { gap: 15px; }
      .user-auth-info span { font-size: 0.9rem; max-width: 150px; }
    }

    /* Buttons */
    .btn, button[type='submit'], button[type='button'] {
      display: inline-block; padding: 0.4rem 0.6rem; border-radius: 20px;
      transition: all 0.3s ease; border: none; cursor: pointer;
      font-size: 0.75rem; font-weight: bold; text-align: center;
      background-color: #fff; color: #000; min-height: 32px;
    }
    @media (min-width: 768px) {
      .btn, button[type='submit'], button[type='button'] {
        padding: 0.7rem 1.5rem; font-size: 0.95rem; border-radius: 25px;
      }
    }
    .btn:hover, button[type='submit']:hover, button[type='button']:hover {
      background-color: #e0e0e0; transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn-secondary { background-color: #333; color: #fff; border: 1px solid #555; }
    .btn-secondary:hover { background-color: #444; border-color: #666; }
    button:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Typography */
    h1, h2, h3 { color: #fff; margin-bottom: 0.75rem; }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; text-align: center; }
    @media (min-width: 768px) { h1 { font-size: 2.5rem; margin-bottom: 1.5rem; } }

    /* Filters Bar */
    .filters-bar {
      background-color: rgba(20, 20, 20, 0.85);
      padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;
      display: flex; flex-direction: column; gap: 0.5rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
    }
    @media (min-width: 768px) {
      .filters-bar {
        padding: 1.5rem; margin-bottom: 2.5rem; display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.25rem; border-radius: 12px;
      }
    }
    .filters-bar input[type='text'], .filters-bar select {
      padding: 0.6rem; border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.15);
      background-color: rgba(30, 30, 30, 0.9); color: #fff; font-size: 0.8rem;
      transition: all 0.3s ease; width: 100%; min-height: 40px;
    }
    @media (min-width: 768px) { .filters-bar input[type='text'], .filters-bar select { padding: 0.85rem; font-size: 1rem; border-radius: 6px; } }
    .filters-bar input[type='text']::placeholder { color: rgba(255,255,255,0.5); }
    .filters-bar input[type='text']:focus, .filters-bar select:focus {
      outline: none; border-color: #a0cfff; background-color: rgba(40, 40, 40, 0.95); box-shadow: 0 0 0 3px rgba(160, 207, 255, 0.25);
    }
    .filters-bar .filter-buttons-container { display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: stretch; flex-wrap: wrap; }
    .filters-bar .filter-buttons-container .btn { flex: 1; min-width: 0; }
    @media (min-width: 768px) {
      .filters-bar .filter-buttons-container { grid-column: 1 / -1; margin-top: 1rem; gap: 1rem; justify-content: flex-start; }
      .filters-bar .filter-buttons-container .btn { flex: none; }
    }
    #applyFiltersBtn::before { content: 'üîç '; }
    #resetFiltersBtn::before { content: '‚Ü∫ '; }

    /* Grid */
    .assignments-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    @media (min-width: 768px) { .assignments-grid { grid-template-columns: repeat(4, 1fr); gap: 1.5rem; } }
    @media (min-width: 1200px) { .assignments-grid { gap: 2rem; } }

    /* Cards */
    .assignment-card {
      background-color: rgba(22, 22, 22, 0.9);
      padding: 0.75rem; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; justify-content: space-between;
      border: 1px solid rgba(255, 255, 255, 0.08); transition: transform 0.3s ease, box-shadow 0.3s ease;
      min-height: 280px;
    }
    @media (min-width: 768px) { .assignment-card { padding: 1.2rem; border-radius: 12px; min-height: 320px; } }
    .assignment-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.4); }
    .assignment-card h3 { font-size: 0.85rem; margin-bottom: 0.5rem; color: #a0cfff; word-break: break-word; line-height: 1.3; }
    @media (min-width: 768px) { .assignment-card h3 { font-size: 1.1rem; margin-bottom: 0.75rem; } }
    .assignment-card p { margin: 0.2rem 0; font-size: 0.7rem; opacity: 0.85; word-break: break-word; line-height: 1.4; }
    @media (min-width: 768px) { .assignment-card p { font-size: 0.85rem; margin: 0.3rem 0; } }
    .assignment-card p strong { opacity: 1; font-weight: 600; color: #f0f0f0; }
    .assignment-card .keywords { margin-top: 0.5rem; }
    .assignment-card .keywords span {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 0.15rem 0.3rem; border-radius: 8px; font-size: 0.6rem; margin-right: 0.2rem; display: inline-block; margin-bottom: 0.2rem; border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    @media (min-width: 768px) {
      .assignment-card .keywords { margin-top: 0.7rem; }
      .assignment-card .keywords span { padding: 0.25rem 0.5rem; font-size: 0.7rem; margin-right: 0.3rem; margin-bottom: 0.3rem; }
    }
    .assignment-card .uploader-name-link { color: #82c0ff; text-decoration: none; font-weight: bold; cursor: pointer; transition: color 0.2s, text-decoration 0.2s; }
    .assignment-card .uploader-name-link:hover { color: #baddff; text-decoration: underline; }

    .card-footer { display: flex; flex-direction: column; align-items: stretch; gap: 0.4rem; margin-top: 0.6rem; padding-top: 0.4rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
    @media (min-width: 768px) { .card-footer { flex-direction: column; gap: 0.6rem; padding-top: 0.6rem; } }
    .assignment-card .view-button { padding: 0.4rem 0.8rem; font-size: 0.75rem; width: 100%; text-align: center; order: 2; }
    @media (min-width: 768px) { .assignment-card .view-button { padding: 0.5rem 1rem; font-size: 0.8rem; order: 2; } }
    .assignment-card .view-button::after { content: ' ¬ª'; }

    .vote-section { display: flex; align-items: center; justify-content: center; gap: 0.4rem; order: 1; }
    .vote-btn {
      background: none; border: 1px solid #555; color: #ccc; padding: 0.3rem 0.5rem; font-size: 0.8rem; border-radius: 14px; cursor: pointer; line-height: 1; transition: all 0.2s ease; font-weight: bold; min-width: 30px; min-height: 28px;
    }
    @media (min-width: 768px) { .vote-btn { padding: 0.4rem 0.6rem; font-size: 0.85rem; border-radius: 16px; min-width: 32px; min-height: 30px; } }
    .vote-btn:hover { background-color: rgba(255,255,255,0.1); color: #fff; border-color: #777; transform: scale(1.05); }
    .vote-btn.voted { background-color: #a0cfff; color: #0c0c0c; border-color: #a0cfff; }
    .vote-btn.voted:hover { background-color: #82c0ff; }
    .vote-count { font-size: 0.8rem; font-weight: bold; color: #e0e0e0; min-width: 1.5ch; text-align: center; }
    @media (min-width: 768px) { .vote-count { font-size: 0.9rem; } }

    /* No Assignments Message */
    .no-assignments-message {
      text-align: center; padding: 1.5rem 1rem; opacity: 0.7; font-size: 0.9rem; color: #aaa;
      border: 2px dashed rgba(255,255,255,0.15); border-radius: 8px; margin: 1rem auto; grid-column: 1 / -1;
    }
    @media (min-width: 768px) { .no-assignments-message { padding: 4rem 2rem; font-size: 1.25rem; margin: 2rem auto; border-radius: 10px; } }
    .no-assignments-message::before { content: 'üìÅ'; font-size: 1.5rem; display: block; margin-bottom: 0.5rem; opacity: 0.5; }
    @media (min-width: 768px) { .no-assignments-message::before { font-size: 2.5rem; margin-bottom: 1rem; } }

    /* Loader */
    .loader-container { display: flex; justify-content: center; align-items: center; padding: 2rem 0; grid-column: 1 / -1; }
    @media (min-width: 768px) { .loader-container { padding: 4rem 0; } }
    .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-top: 4px solid #a0cfff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @media (min-width: 768px) { .loader { border-width: 6px; width: 60px; height: 60px; } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .assignment-card:hover { transform: none; }
      .btn:hover, button:hover { transform: none; }
    }
    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }
    /* High contrast */
    @media (prefers-contrast: high) { .assignment-card { border: 2px solid #fff; } .btn { border: 2px solid #000; } }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* Modal styles */
    dialog {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px; 
      background: rgba(22, 22, 22, 0.95);
      backdrop-filter: blur(10px);
      color: #e0e0e0;
      padding: 0; 
      max-width: 500px; 
      width: calc(100% - 24px);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
    }
    dialog::backdrop { 
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    .modal-header { 
      padding: 20px 24px; 
      border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      font-weight: 600;
      font-size: 1.1rem;
      background: rgba(30, 30, 30, 0.8);
      border-radius: 16px 16px 0 0;
    }
    .modal-body { 
      padding: 24px; 
      display: grid; 
      gap: 18px; 
    }
    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: rgba(15, 15, 15, 0.8);
      border-radius: 0 0 16px 16px;
    }
    .field { 
      display: grid; 
      gap: 8px; 
    }
    .field label { 
      color: #b0b0b0; 
      font-size: 14px; 
      font-weight: 600;
      margin-bottom: 4px;
    }
    .field input, .field select {
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(30, 30, 30, 0.9);
      color: #e0e0e0;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: #a0cfff;
      background: rgba(40, 40, 40, 0.95);
      box-shadow: 0 0 0 3px rgba(160, 207, 255, 0.25);
      transform: translateY(-1px);
    }
    .field input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    .field small {
      color: #999;
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.4;
    }

    /* Enhanced button styles for modal */
    .modal-footer .btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
      min-width: 100px;
    }
    .modal-footer .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    /* Success/Error message styling */
    .error {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
    }
    .success {
      color: #51cf66;
      background: rgba(81, 207, 102, 0.1);
      border: 1px solid rgba(81, 207, 102, 0.3);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
    }

    /* Profile modal styles */
    .profile-info {
      display: grid;
      gap: 12px;
    }
    .profile-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    .profile-field:last-child {
      border-bottom: none;
    }
    .profile-field .label {
      color: #999;
      font-size: 13px;
      font-weight: 500;
    }
    .profile-field .value {
      color: #e0e0e0;
      font-weight: 600;
    }
    .profile-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(160, 207, 255, 0.2), rgba(160, 207, 255, 0.1));
      border: 2px solid rgba(160, 207, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      color: #a0cfff;
      margin: 0 auto 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    .profile-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
      justify-content: center;
    }
    .profile-link {
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      color: #e0e0e0;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
      background: rgba(30, 30, 30, 0.6);
    }
    .profile-link:hover {
      background: rgba(160, 207, 255, 0.1);
      border-color: rgba(160, 207, 255, 0.3);
      color: #a0cfff;
      text-decoration: none;
      transform: translateY(-2px);
    }

    /* Loading state for submit button */
    .btn.loading {
      position: relative;
      color: transparent;
    }
    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      color: #000;
    }

    /* Responsive modal */
    @media (max-width: 768px) {
      dialog {
        width: calc(100% - 16px);
        max-height: 95vh;
      }
      .modal-header, .modal-body, .modal-footer {
        padding-left: 16px;
        padding-right: 16px;
      }
      .modal-footer {
        flex-direction: column;
      }
      .modal-footer .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav aria-label="Main">
      <div class="logo" aria-label="PFL Logo">PFL</div>
      <div class="header-nav-links" role="navigation" aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="chat.html">Chat</a>
        <a href="profile.html">Profile</a>
        <button id="uploadBtn" class="btn" type="button" style="display:none">Upload Assignment</button>
      </div>
      <div class="user-auth-info">
        <span id="assignmentUserEmail">Not logged in</span>
        <button id="assignmentLogoutBtn" class="btn btn-secondary hidden" type="button">Logout</button>
        <a href="login.html" id="assignmentLoginLink" class="btn" style="display:none">Login</a>
      </div>
    </nav>
  </header>

  <main class="container">
    <h1>Assignments Hub</h1>

    <div class="filters-bar" role="region" aria-label="Assignment filters">
      <input type="text" id="searchTerm" placeholder="Search assignments..." class="form-control" aria-label="Search assignments" />
      <select id="filterSemester" class="form-control" aria-label="Filter by semester">
        <option value="">All Semesters</option>
      </select>
      <select id="filterSubject" class="form-control" aria-label="Filter by subject">
        <option value="">All Subjects</option>
      </select>
      <input type="text" id="filterAssignmentNumber" placeholder="Assignment No." class="form-control" aria-label="Filter by assignment number" />
      <select id="sortBy" class="form-control" aria-label="Sort assignments">
        <option value="uploadDate_desc">Newest First</option>
        <option value="votes_desc">Most Voted</option>
        <option value="uploadDate_asc">Oldest First</option>
      </select>
      <div class="filter-buttons-container">
        <button id="applyFiltersBtn" class="btn" type="button">Apply Filters</button>
        <button id="resetFiltersBtn" class="btn btn-secondary" type="button">Reset</button>
      </div>
    </div>

    <div id="assignmentsGrid" class="assignments-grid" aria-live="polite" aria-busy="false">
      <!-- Assignments will be injected here -->
    </div>

    <!-- Upload Assignment Modal -->
    <dialog id="uploadModal">
      <form method="dialog" id="uploadForm">
        <div class="modal-header">
          <strong>Upload Assignment</strong>
          <button class="btn btn-secondary" value="cancel" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <div class="field">
            <label for="assignmentTitle">Assignment Title *</label>
            <input type="text" id="assignmentTitle" class="form-control" placeholder="e.g., Data Structures Lab 1" required maxlength="100" />
          </div>
          <div class="field">
            <label for="subject">Subject *</label>
            <input type="text" id="subject" class="form-control" placeholder="e.g., Computer Science" required maxlength="50" />
          </div>
          <div class="field">
            <label for="semester">Semester *</label>
            <select id="semester" class="form-control" required>
              <option value="">Select Semester</option>
              <option value="1">1st Semester</option>
              <option value="2">2nd Semester</option>
              <option value="3">3rd Semester</option>
              <option value="4">4th Semester</option>
              <option value="5">5th Semester</option>
              <option value="6">6th Semester</option>
              <option value="7">7th Semester</option>
              <option value="8">8th Semester</option>
            </select>
          </div>
          <div class="field">
            <label for="assignmentNumber">Assignment Number</label>
            <input type="text" id="assignmentNumber" class="form-control" placeholder="e.g., 1, 2, Lab-1" maxlength="20" />
          </div>
          <div class="field">
            <label for="driveLink">Google Drive Link *</label>
            <input type="url" id="driveLink" class="form-control" placeholder="https://drive.google.com/..." required />
            <small style="color: var(--soft); font-size: 0.8rem;">Make sure the link is publicly accessible</small>
          </div>
          <div class="field">
            <label for="keywords">Keywords (comma-separated)</label>
            <input type="text" id="keywords" class="form-control" placeholder="e.g., arrays, sorting, algorithms" maxlength="200" />
            <small style="color: var(--soft); font-size: 0.8rem;">Help others find your assignment</small>
          </div>
          <div id="uploadMessage" class="error" style="display: none; margin-top: 10px;"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn" id="submitUpload">Upload Assignment</button>
          <button type="button" class="btn btn-secondary" id="cancelUpload">Cancel</button>
        </div>
      </form>
    </dialog>

    <!-- Profile Modal -->
    <dialog id="profile-modal">
      <form method="dialog">
        <div class="modal-header">
          <strong id="profile-modal-title">User Profile</strong>
          <button class="btn btn-secondary" value="cancel" aria-label="Close">Close</button>
        </div>
        <div class="modal-body" id="profile-modal-body">
          <div class="profile-avatar" id="profile-avatar"></div>
          <div class="profile-info" id="profile-info"></div>
        </div>
      </form>
    </dialog>
  </main>

  <script type="module">
    import { auth, db, initAuth, signOutUser, redirectToLogin, requireAuth } from './js/auth.js';
    import {
      collection, addDoc, getDocs, query, orderBy, serverTimestamp,
      doc, getDoc as getFirestoreDoc, updateDoc, increment, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // DOM elements
    const assignmentUserEmailEl = document.getElementById('assignmentUserEmail');
    const assignmentLogoutBtnEl = document.getElementById('assignmentLogoutBtn');
    const assignmentLoginLinkEl = document.getElementById('assignmentLoginLink');
    const assignmentsGridEl = document.getElementById('assignmentsGrid');
    const searchTermInputEl = document.getElementById('searchTerm');
    const filterSemesterSelectEl = document.getElementById('filterSemester');
    const filterSubjectSelectEl = document.getElementById('filterSubject');
    const filterAssignmentNumberInputEl = document.getElementById('filterAssignmentNumber');
    const sortBySelectEl = document.getElementById('sortBy');
    const applyFiltersBtnEl = document.getElementById('applyFiltersBtn');
    const resetFiltersBtnEl = document.getElementById('resetFiltersBtn');

    // Global State
    let allAssignments = [];
    let userNamesCache = {};
    let currentUser = null;
    let currentProfile = null;

    const profileCache = new Map();

    // Profile Modal functionality
    async function loadProfile(uid) {
      if (profileCache.has(uid)) {
        return profileCache.get(uid);
      }
      try {
        const profileRef = doc(db, 'profiles', uid);
        const profileSnap = await getFirestoreDoc(profileRef);
        if (profileSnap.exists()) {
          const profileData = { id: profileSnap.id, ...profileSnap.data() };
          profileCache.set(uid, profileData);
          return profileData;
        } else {
          console.error('Profile not found');
          return null;
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        return null;
      }
    }

    const profileModal = document.getElementById('profile-modal');
    const profileModalTitle = document.getElementById('profile-modal-title');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileInfo = document.getElementById('profile-info');

    async function openProfileModal(uid) {
      try {
        const profile = await loadProfile(uid);
        if (!profile) {
          alert('Could not load profile.');
          return;
        }

        profileModalTitle.textContent = profile.name || 'User Profile';
        profileAvatar.textContent = profile.name ? profile.name[0].toUpperCase() : '?';

        profileInfo.innerHTML = '';
        
        // Create profile fields
        const fields = [
          { label: 'Name', value: profile.name || 'N/A' },
          { label: 'College', value: profile.college || 'N/A' },
          { label: 'Semester', value: profile.semester ? getOrdinalSuffix(profile.semester) : 'N/A' }
        ];

        fields.forEach(field => {
          const fieldEl = document.createElement('div');
          fieldEl.className = 'profile-field';
          fieldEl.innerHTML = `
            <span class="label">${field.label}</span>
            <span class="value">${field.value}</span>
          `;
          profileInfo.appendChild(fieldEl);
        });

        // Add social links
        const links = document.createElement('div');
        links.className = 'profile-links';
        
        if (profile.instagram) {
          const instagramLink = document.createElement('a');
          instagramLink.className = 'profile-link';
          instagramLink.href = `https://instagram.com/${profile.instagram}`;
          instagramLink.target = '_blank';
          instagramLink.rel = 'noopener noreferrer';
          instagramLink.textContent = 'Instagram';
          links.appendChild(instagramLink);
        }
        
        if (profile.github) {
          const githubLink = document.createElement('a');
          githubLink.className = 'profile-link';
          githubLink.href = profile.github;
          githubLink.target = '_blank';
          githubLink.rel = 'noopener noreferrer';
          githubLink.textContent = 'GitHub';
          links.appendChild(githubLink);
        }
        
        if (profile.linkedin) {
          const linkedinLink = document.createElement('a');
          linkedinLink.className = 'profile-link';
          linkedinLink.href = profile.linkedin;
          linkedinLink.target = '_blank';
          linkedinLink.rel = 'noopener noreferrer';
          linkedinLink.textContent = 'LinkedIn';
          links.appendChild(linkedinLink);
        }

        if (links.children.length > 0) {
          profileInfo.appendChild(links);
        }

        profileModal.showModal();
      } catch (error) {
        console.error('Error opening profile modal:', error);
        alert('Failed to open profile.');
      }
    }

    // Utility functions
    function getOrdinalSuffix(nStr) {
      const n = parseInt(nStr);
      if (isNaN(n)) return typeof nStr === 'string' ? nStr : '';
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function updateAuthUI() {
      if (currentUser) {
        assignmentUserEmailEl.textContent = currentProfile?.name || currentUser.email;
        assignmentLoginLinkEl.style.display = 'none';
        assignmentLogoutBtnEl.classList.remove('hidden');
        uploadBtn.style.display = ''; // Show upload button
      } else {
        assignmentUserEmailEl.textContent = 'Not logged in';
        assignmentLoginLinkEl.style.display = '';
        assignmentLogoutBtnEl.classList.add('hidden');
        uploadBtn.style.display = 'none'; // Hide upload button
      }
    }

    // Upload functionality
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadModal = document.getElementById('uploadModal');
    const uploadForm = document.getElementById('uploadForm');
    const submitUpload = document.getElementById('submitUpload');
    const cancelUpload = document.getElementById('cancelUpload');
    const uploadMessage = document.getElementById('uploadMessage');

    // Form elements
    const assignmentTitleEl = document.getElementById('assignmentTitle');
    const subjectEl = document.getElementById('subject');
    const semesterEl = document.getElementById('semester');
    const assignmentNumberEl = document.getElementById('assignmentNumber');
    const driveLinkEl = document.getElementById('driveLink');
    const keywordsEl = document.getElementById('keywords');

    function showUploadMessage(text, isError = true) {
      uploadMessage.textContent = text;
      uploadMessage.className = isError ? 'error' : 'success';
      uploadMessage.style.display = 'block';
    }

    function hideUploadMessage() {
      uploadMessage.style.display = 'none';
    }

    function resetUploadForm() {
      uploadForm.reset();
      hideUploadMessage();
    }

    async function handleUploadSubmit(e) {
      e.preventDefault();
      hideUploadMessage();

      if (!currentUser) {
        showUploadMessage('Please sign in to upload assignments.');
        return;
      }

      const title = assignmentTitleEl.value.trim();
      const subject = subjectEl.value.trim();
      const semester = semesterEl.value;
      const assignmentNumber = assignmentNumberEl.value.trim();
      const driveLink = driveLinkEl.value.trim();
      const keywords = keywordsEl.value.trim();

      // Validation
      if (!title || !subject || !semester || !driveLink) {
        showUploadMessage('Please fill in all required fields.');
        return;
      }

      if (!driveLink.match(/^https?:\/\/.+/)) {
        showUploadMessage('Please enter a valid URL for the Google Drive link.');
        return;
      }

      // Parse keywords
      const keywordArray = keywords ? keywords.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];

      // Replace the existing loading logic in handleUploadSubmit function
      submitUpload.disabled = true;
      submitUpload.classList.add('loading');
      submitUpload.textContent = 'Uploading...';

      try {
        const assignmentData = {
          assignmentTitle: title,
          subject: subject,
          semester: semester,
          assignmentNumber: assignmentNumber || '',
          driveLink: driveLink,
          keywords: keywordArray,
          uploaderId: currentUser.uid,
          uploaderEmail: currentUser.email,
          uploadDate: serverTimestamp(),
          votes: 0,
          votedBy: []
        };

        await addDoc(collection(db, 'assignments'), assignmentData);
        
        showUploadMessage('Assignment uploaded successfully!', false);
        resetUploadForm();
        
        // Refresh assignments list
        setTimeout(() => {
          uploadModal.close();
          fetchAssignments();
        }, 1500);

      } catch (error) {
        console.error('Error uploading assignment:', error);
        showUploadMessage('Failed to upload assignment. Please try again.');
      } finally {
        // And in the finally block:
        submitUpload.disabled = false;
        submitUpload.classList.remove('loading');
        submitUpload.textContent = 'Upload Assignment';
      }
    }

    // Event listeners for upload functionality
    uploadBtn.addEventListener('click', () => {
      if (!currentUser) {
        redirectToLogin();
        return;
      }
      resetUploadForm();
      uploadModal.showModal();
    });

    uploadForm.addEventListener('submit', handleUploadSubmit);
    cancelUpload.addEventListener('click', () => {
      uploadModal.close();
    });

    // Assignment functions
    async function fetchAssignments() {
      assignmentsGridEl.setAttribute('aria-busy', 'true');
      assignmentsGridEl.innerHTML = '<div class="loader-container"><div class="loader" role="progressbar" aria-label="Loading assignments"></div></div>';
      try {
        const assignmentsQuery = query(collection(db, "assignments"), orderBy("uploadDate", "desc"));
        const snapshot = await getDocs(assignmentsQuery);
        allAssignments = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
        populateAllFilters();
        await renderAssignments(allAssignments);
      } catch (error) {
        console.error("Error fetching assignments:", error);
        assignmentsGridEl.innerHTML = `
          <div class="no-assignments-message">
            Could not load assignments.
            <div style="margin-top: 12px;">
              <button id="retryFetchBtn" class="btn btn-secondary" type="button">Retry</button>
            </div>
          </div>`;
        document.getElementById('retryFetchBtn')?.addEventListener('click', fetchAssignments);
      } finally {
        assignmentsGridEl.setAttribute('aria-busy', 'false');
      }
    }

    async function renderAssignments(assignmentsToRender) {
      assignmentsGridEl.innerHTML = '';
      if (!assignmentsToRender || assignmentsToRender.length === 0) {
        assignmentsGridEl.innerHTML = '<p class="no-assignments-message">No assignments found.</p>';
        return;
      }

      const uploaderNamePromises = assignmentsToRender.map(assignment =>
        fetchUploaderName(assignment.uploaderId, assignment.uploaderEmail || 'Anonymous')
      );
      let uploaderNames = [];
      try {
        uploaderNames = await Promise.all(uploaderNamePromises);
      } catch {
        uploaderNames = assignmentsToRender.map(a => a.uploaderEmail || 'Anonymous');
      }

      assignmentsToRender.forEach((assignment, index) => {
        const card = document.createElement('div');
        card.classList.add('assignment-card');

        const uploadDate = assignment.uploadDate?.toDate ? assignment.uploadDate.toDate().toLocaleDateString() : 'N/A';
        const uploaderName = uploaderNames[index] || 'Unknown';
        const userHasVoted = currentUser && Array.isArray(assignment.votedBy) && assignment.votedBy.includes(currentUser?.uid);

        card.innerHTML = `
          <div>
            <h3>${assignment.assignmentTitle || 'Untitled'}</h3>
            <p><strong>Uploader:</strong> <span class="uploader-name-link" onclick="openProfileModal('${assignment.uploaderId}')" style="cursor: pointer;">${uploaderName}</span></p>
            <p><strong>Subject:</strong> ${assignment.subject || 'N/A'}</p>
            <p><strong>Semester:</strong> ${getOrdinalSuffix(assignment.semester)}</p>
            ${assignment.assignmentNumber ? `<p><strong>Assignment No.:</strong> ${assignment.assignmentNumber}</p>` : ''}
            <p><strong>Uploaded:</strong> ${uploadDate}</p>
            ${assignment.keywords?.length > 0 ? `<div class="keywords">${assignment.keywords.map(k => `<span>${k}</span>`).join('')}</div>` : ''}
          </div>
          <div class="card-footer">
            <a href="${assignment.driveLink || '#'}" target="_blank" rel="noopener noreferrer" class="btn view-button">View Assignment</a>
            <div class="vote-section" data-assignment-id="${assignment.id}">
              <button class="vote-btn ${userHasVoted ? 'voted' : ''}" data-assignment-id="${assignment.id}" aria-label="Vote">‚ñ≤</button>
              <span class="vote-count">${assignment.votes || 0}</span>
            </div>
          </div>
        `;

        card.querySelector('.vote-btn')?.addEventListener('click', (event) => handleVote(assignment.id, event.currentTarget));
        assignmentsGridEl.appendChild(card);
      });
    }

    async function handleVote(assignmentId, voteButtonElement) {
      if (!currentUser) {
        redirectToLogin();
        return;
      }
      if (!assignmentId) return;

      const parent = voteButtonElement.closest('.vote-section');
      const voteCountSpan = parent?.querySelector('.vote-count');
      const originalVoted = voteButtonElement.classList.contains('voted');
      const originalCount = parseInt(voteCountSpan?.textContent || '0', 10);

      // Optimistic UI
      voteButtonElement.disabled = true;
      voteButtonElement.classList.toggle('voted');
      if (voteCountSpan) {
        voteCountSpan.textContent = String(originalCount + (originalVoted ? -1 : 1));
      }

      try {
        const assignmentRef = doc(db, "assignments", assignmentId);
        const docSnap = await getFirestoreDoc(assignmentRef);
        if (!docSnap.exists()) {
          throw new Error('This assignment no longer exists.');
        }
        const assignmentData = docSnap.data();
        const hasVoted = (assignmentData.votedBy || []).includes(currentUser.uid);
        const updatePayload = hasVoted
          ? { votes: increment(-1), votedBy: arrayRemove(currentUser.uid) }
          : { votes: increment(1), votedBy: arrayUnion(currentUser.uid) };
        await updateDoc(assignmentRef, updatePayload);
      } catch (error) {
        // Revert UI on failure
        voteButtonElement.classList.toggle('voted');
        if (voteCountSpan) {
          voteCountSpan.textContent = String(originalCount);
        }
      } finally {
        voteButtonElement.disabled = false;
      }
    }

    // Filtering and sorting
    function populateAllFilters() {
      const semesters = [...new Set(allAssignments.map(a => a.semester).filter(Boolean))].sort((a, b) => a - b);
      const subjects = [...new Set(allAssignments.map(a => a.subject).filter(Boolean))].sort();
      populateFilterDropdown(filterSemesterSelectEl, semesters, 'All Semesters');
      populateFilterDropdown(filterSubjectSelectEl, subjects, 'All Subjects');
    }

    function populateFilterDropdown(selectElement, items, defaultOptionText) {
      const currentValue = selectElement.value;
      selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
      items.forEach(item => selectElement.add(new Option(item, item)));
      selectElement.value = currentValue;
    }

    function applyCurrentFilters() {
      if (!allAssignments) return;

      const searchTerm = searchTermInputEl.value.toLowerCase().trim();
      const selectedSemester = filterSemesterSelectEl.value;
      const selectedSubject = filterSubjectSelectEl.value;
      const assignmentNumFilter = filterAssignmentNumberInputEl.value.toLowerCase().trim();
      const sortByValue = sortBySelectEl.value;

      let filtered = allAssignments.filter(a =>
        (searchTerm ? [a.assignmentTitle, a.subject, ...(a.keywords || [])].join(' ').toLowerCase().includes(searchTerm) : true) &&
        (selectedSemester ? a.semester === selectedSemester : true) &&
        (selectedSubject ? a.subject === selectedSubject : true) &&
        (assignmentNumFilter ? String(a.assignmentNumber || '').toLowerCase().includes(assignmentNumFilter) : true)
      );

      filtered.sort((a, b) => {
        if (sortByValue === 'votes_desc') return (b.votes || 0) - (a.votes || 0);
        if (sortByValue === 'uploadDate_asc') return (a.uploadDate?.toMillis?.() || 0) - (b.uploadDate?.toMillis?.() || 0);
        return (b.uploadDate?.toMillis?.() || 0) - (a.uploadDate?.toMillis?.() || 0);
      });

      renderAssignments(filtered);
    }

    function resetAllFilters() {
      searchTermInputEl.value = '';
      filterSemesterSelectEl.value = '';
      filterSubjectSelectEl.value = '';
      filterAssignmentNumberInputEl.value = '';
      sortBySelectEl.value = 'uploadDate_desc';
      applyCurrentFilters();
    }

    async function fetchUploaderName(uploaderId, fallbackName = 'Anonymous') {
      if (userNamesCache[uploaderId]) return userNamesCache[uploaderId];
      if (!uploaderId) return fallbackName;
      try {
        const userDocRef = doc(db, 'profiles', uploaderId);
        const docSnap = await getFirestoreDoc(userDocRef);
        if (docSnap.exists() && docSnap.data().name) {
          const displayName = docSnap.data().name;
          userNamesCache[uploaderId] = displayName;
          return displayName;
        }
        return fallbackName;
      } catch (err) {
        console.warn('fetchUploaderName failed:', err);
        return fallbackName;
      }
    }

    // Event listeners
    assignmentLogoutBtnEl.addEventListener('click', signOutUser);
    applyFiltersBtnEl.addEventListener('click', applyCurrentFilters);
    resetFiltersBtnEl.addEventListener('click', resetAllFilters);
    sortBySelectEl.addEventListener('change', applyCurrentFilters);

    // Initialize auth
    initAuth({
      onAuthStateChanged: (user, profile) => {
        currentUser = user;
        currentProfile = profile;
        updateAuthUI();
        applyCurrentFilters();
      }
    });

    // Initial load
    fetchAssignments();

    window.openProfileModal = openProfileModal;
  </script>
</body>
</html>
