<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PFL - Assignments Hub</title>
  <link rel="icon" href="HummingBird (1).png" type="image/x-icon" />
  <link rel="manifest" href="manifest.json" />
  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f0f10;
      --elev: #151517;
      --elev-2: #1b1b1e;
      --muted: #d9d9db;
      --soft: #a9a9ad;
      --line: #2a2a2e;
      --accent: #ffffff;
      --ok: #43d17a;
      --warn: #e7c74f;
      --danger: #ff5d5d;
      --primary: #4f46e5;
      --primary-hover: #4338ca;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
      background: var(--bg);
      color: var(--muted);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Header */
    header {
      background: var(--elev-2);
      border-bottom: 1px solid var(--line);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--ok));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .nav-links {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .nav-links a {
      color: var(--muted);
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.2s;
      white-space: nowrap;
      font-weight: 500;
    }
    
    .nav-links a:hover {
      background: var(--elev);
      color: var(--accent);
    }
    
    .nav-links a.active {
      background: var(--primary);
      color: white;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--ok));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    /* Notification Permission Banner */
    .notification-banner {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white;
      padding: 1rem;
      text-align: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    .notification-banner.show {
      transform: translateY(0);
    }

    .notification-banner-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .notification-banner-text {
      flex: 1;
      min-width: 200px;
    }

    .notification-banner-actions {
      display: flex;
      gap: 0.5rem;
    }

    .notification-banner .btn {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .notification-banner .btn-outline {
      border-color: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .notification-banner .btn-outline:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: white;
    }
    
    /* Mobile Navigation */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 0.75rem;
        padding: 0 0.5rem;
      }
      
      .nav-links {
        order: -1;
        width: 100%;
        justify-content: center;
        gap: 0.5rem;
      }
      
      .nav-links a {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .logo {
        font-size: 1.2rem;
      }
      
      .user-info {
        font-size: 0.8rem;
        gap: 0.5rem;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
      }

      .notification-banner-content {
        flex-direction: column;
        text-align: center;
      }
      
      .notification-banner-actions {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem 0.5rem;
      }
    }
    
    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--accent), var(--soft));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .page-subtitle {
      color: var(--soft);
      font-size: 1.1rem;
    }
    
    @media (max-width: 768px) {
      .page-title {
        font-size: 2rem;
      }
      
      .page-subtitle {
        font-size: 1rem;
      }
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white;
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
    }
    
    .btn-outline {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--line);
    }
    
    .btn-outline:hover {
      background: var(--elev);
      border-color: var(--primary);
      color: var(--accent);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 768px) {
      .btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
    }
    
    /* Mobile Filters Toggle */
    .mobile-filters-toggle {
      display: none;
      background: var(--elev-2);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mobile-filters-toggle:hover {
      background: var(--elev);
      border-color: var(--primary);
    }
    
    .mobile-filters-toggle .toggle-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      color: var(--accent);
    }
    
    .mobile-filters-toggle .toggle-icon {
      transition: transform 0.2s;
    }
    
    .mobile-filters-toggle.collapsed .toggle-icon {
      transform: rotate(180deg);
    }
    
    @media (max-width: 768px) {
      .mobile-filters-toggle {
        display: block;
      }
    }
    
    /* Filters Section */
    .filters-section {
      background: var(--elev-2);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }
    
    .filters-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      font-weight: 600;
      color: var(--accent);
    }
    
    .filters-grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    @media (min-width: 768px) {
      .filters-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    
    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filter-field label {
      font-weight: 500;
      color: var(--soft);
      font-size: 0.9rem;
    }
    
    .filter-field input,
    .filter-field select {
      padding: 0.75rem;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--elev);
      color: var(--muted);
      font-size: 1rem;
      transition: all 0.2s;
      outline: none;
    }
    
    .filter-field input:focus,
    .filter-field select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      background: var(--bg);
    }
    
    .filter-field input::placeholder {
      color: var(--soft);
    }
    
    .filter-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .filters-section {
        padding: 1rem;
        max-height: 0;
        opacity: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
      }
      
      .filters-section.expanded {
        max-height: 1000px;
        opacity: 1;
        margin-bottom: 2rem;
        padding: 1rem;
      }
      
      .filter-actions {
        flex-direction: column;
      }
      
      .filter-actions .btn {
        width: 100%;
      }
    }
    
    /* Upload Button */
    .upload-section {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .upload-btn {
      background: linear-gradient(135deg, var(--ok), #2dd4bf);
      color: white;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(67, 209, 122, 0.3);
    }
    
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(67, 209, 122, 0.4);
    }
    
    /* Assignments Grid */
    .assignments-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }

    @media (max-width: 768px) {
      .assignments-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
    }
    
    @media (max-width: 480px) {
      .assignments-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
    
    /* Assignment Cards */
    .assignment-card {
      background: var(--elev-2);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .assignment-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
      border-color: var(--primary);
    }
    
    .card-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
      line-height: 1.3;
    }
    
    .card-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--soft);
    }
    
    .uploader-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .uploader-link:hover {
      color: var(--primary-hover);
      text-decoration: underline;
    }
    
    .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .card-info {
      display: grid;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-label {
      color: var(--soft);
      font-weight: 500;
    }
    
    .info-value {
      color: var(--muted);
      font-weight: 600;
    }
    
    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .keyword-tag {
      background: rgba(79, 70, 229, 0.1);
      color: var(--primary);
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
      border: 1px solid rgba(79, 70, 229, 0.2);
    }
    
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--line);
    }
    
    .vote-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .vote-btn {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--soft);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }
    
    .vote-btn:hover {
      background: var(--elev);
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(1.1);
    }
    
    .vote-btn.voted {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .vote-count {
      font-weight: 600;
      color: var(--muted);
      min-width: 2ch;
      text-align: center;
    }
    
    .view-btn {
      background: var(--primary);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .view-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    /* Mobile assignment cards - smaller for 2x2 */
    @media (max-width: 768px) {
      .assignment-card {
        padding: 0.75rem;
        font-size: 0.85rem;
      }
      
      .card-title {
        font-size: 0.95rem;
        line-height: 1.2;
      }
      
      .card-meta {
        font-size: 0.7rem;
      }
      
      .info-item {
        font-size: 0.8rem;
      }
      
      .keyword-tag {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
      }
      
      .card-footer {
        padding-top: 0.75rem;
        flex-direction: row;
        gap: 0.5rem;
      }
      
      .vote-btn {
        width: 32px;
        height: 32px;
      }
      
      .view-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }
    
    @media (max-width: 480px) {
      .assignment-card {
        padding: 1rem;
      }
      
      .card-footer {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
      }
      
      .vote-section {
        justify-content: center;
      }
      
      .view-btn {
        text-align: center;
        padding: 0.75rem;
      }
    }
    
    /* Loading and Empty States */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4rem 0;
      grid-column: 1 / -1;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--line);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      grid-column: 1 / -1;
      color: var(--soft);
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .empty-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--muted);
    }
    
    .empty-description {
      font-size: 0.9rem;
    }
    
    /* Icons */
    .icon {
      width: 1.2em;
      height: 1.2em;
      display: inline-block;
    }
    
    /* Modal Styles */
    dialog {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--elev-2);
      color: var(--muted);
      padding: 0;
      max-width: 500px;
      width: calc(100% - 2rem);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
    }
    
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 1.1rem;
      background: var(--elev);
      border-radius: 16px 16px 0 0;
    }
    
    .modal-body {
      padding: 1.5rem;
      display: grid;
      gap: 1rem;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      background: var(--elev);
      border-radius: 0 0 16px 16px;
    }
    
    .form-field {
      display: grid;
      gap: 0.5rem;
    }
    
    .form-field label {
      color: var(--soft);
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 0.75rem;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--elev);
      color: var(--muted);
      font-size: 1rem;
      transition: all 0.2s;
      outline: none;
      font-family: inherit;
    }
    
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      background: var(--bg);
    }
    
    .form-field input::placeholder,
    .form-field textarea::placeholder {
      color: var(--soft);
    }
    
    .form-hint {
      font-size: 0.8rem;
      color: var(--soft);
      margin-top: 0.25rem;
    }
    
    .message {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 1rem;
    }
    
    .message.success {
      background: rgba(67, 209, 122, 0.1);
      color: var(--ok);
      border: 1px solid rgba(67, 209, 122, 0.2);
    }
    
    .message.error {
      background: rgba(255, 93, 93, 0.1);
      color: var(--danger);
      border: 1px solid rgba(255, 93, 93, 0.2);
    }
    
    @media (max-width: 768px) {
      dialog {
        width: calc(100% - 1rem);
        max-height: 95vh;
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 1rem;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-footer .btn {
        width: 100%;
      }
    }
    
    /* Profile Modal */
    .profile-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--ok));
      color: white;
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    
    .profile-info {
      display: grid;
      gap: 0.75rem;
    }
    
    .profile-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--line);
    }
    
    .profile-field:last-child {
      border-bottom: none;
    }
    
    .profile-field .label {
      color: var(--soft);
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .profile-field .value {
      color: var(--muted);
      font-weight: 600;
    }
    
    .profile-links {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
      justify-content: center;
    }
    
    .profile-link {
      padding: 0.5rem 1rem;
      border: 1px solid var(--line);
      border-radius: 20px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
      background: var(--elev);
    }
    
    .profile-link:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }
    
    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Focus styles */
    .btn:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Hidden utility */
    .hidden {
      display: none !important;
    }

    .notification-toggle-btn {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--line);
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .notification-toggle-btn:hover {
      background: var(--elev);
      border-color: var(--primary);
      color: var(--accent);
    }

    .notification-toggle-btn.enabled {
      background: var(--ok);
      border-color: var(--ok);
      color: white;
    }

    .notification-toggle-btn.enabled:hover {
      background: #22c55e;
      border-color: #22c55e;
    }

    @media (max-width: 768px) {
      .notification-toggle-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
      }
      
      .notification-toggle-btn .icon {
        width: 1em;
        height: 1em;
      }
    }
  </style>
</head>
<body>
  <!-- Notification Permission Banner -->
  <div class="notification-banner" id="notification-banner">
    <div class="notification-banner-content">
      <div class="notification-banner-text">
        <strong>📢 Stay Updated!</strong> Get notified when new assignments for your semester are uploaded.
      </div>
      <div class="notification-banner-actions">
        <button class="btn btn-primary" id="enable-notifications">Enable Notifications</button>
        <button class="btn btn-outline" id="dismiss-banner">Maybe Later</button>
      </div>
    </div>
  </div>

  <header>
    <div class="header-content">
      <div class="logo">PFL</div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="chat.html">Chat</a>
        <a href="assignments.html" class="active">Assignments</a>
        <a href="profile.html">Profile</a>
        <a href="pyqs.html">PYQ's</a>
      </nav>
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">?</div>
        <span id="user-name">Guest</span>
        <button id="notification-toggle-btn" class="btn btn-outline hidden" title="Toggle Push Notifications">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
          </svg>
          <span id="notification-status">Enable</span>
        </button>
        <button id="logout-btn" class="btn btn-outline hidden">Sign Out</button>
        <a href="login.html" id="login-link" class="btn btn-primary" style="display:none">Sign In</a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-header">
      <h1 class="page-title">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Assignments Hub
      </h1>
      <p class="page-subtitle">Share, discover, and vote on the best programming assignments</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <button id="upload-btn" class="btn upload-btn">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        Upload Assignment
      </button>
    </div>

    <!-- Mobile Filters Toggle -->
    <div class="mobile-filters-toggle collapsed" id="mobile-filters-toggle">
      <div class="toggle-content">
        <span>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
          </svg>
          Filter & Search
        </span>
        <svg class="toggle-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" id="filters-section">
      <div class="filters-header">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
        </svg>
        Filter & Search
      </div>
      
      <div class="filters-grid">
        <div class="filter-field">
          <label for="search-input">Search Assignments</label>
          <input 
            type="text" 
            id="search-input" 
            placeholder="Search by title, subject, or keywords..."
          />
        </div>
        
        <div class="filter-field">
          <label for="semester-filter">Semester</label>
          <select id="semester-filter">
            <option value="">All Semesters</option>
          </select>
        </div>
        
        <div class="filter-field">
          <label for="subject-filter">Subject</label>
          <select id="subject-filter">
            <option value="">All Subjects</option>
          </select>
        </div>
        
        <div class="filter-field">
          <label for="assignment-number-filter">Assignment No.</label>
          <input 
            type="text" 
            id="assignment-number-filter" 
            placeholder="e.g., 1, Lab-2"
          />
        </div>
        
        <div class="filter-field">
          <label for="sort-select">Sort By</label>
          <select id="sort-select">
            <option value="uploadDate_desc">Newest First</option>
            <option value="votes_desc">Most Voted</option>
            <option value="uploadDate_asc">Oldest First</option>
          </select>
        </div>
      </div>
      
      <div class="filter-actions">
        <button id="apply-filters-btn" class="btn btn-primary">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          Apply Filters
        </button>
        <button id="reset-filters-btn" class="btn btn-outline">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Reset
        </button>
      </div>
    </div>

    <!-- Assignments Grid -->
    <div id="assignments-grid" class="assignments-grid">
      <div class="loading-container">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </main>

  <!-- Upload Modal -->
  <dialog id="upload-modal">
    <form method="dialog" id="upload-form">
      <div class="modal-header">
        <strong>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Assignment
        </strong>
        <button class="btn btn-outline" value="cancel">Close</button>
      </div>
      <div class="modal-body">
        <div class="form-field">
          <label for="assignment-title">Assignment Title *</label>
          <input 
            type="text" 
            id="assignment-title" 
            placeholder="e.g., Data Structures Lab 1" 
            required 
            maxlength="100" 
          />
        </div>
        
        <div class="form-field">
          <label for="subject">Subject *</label>
          <input 
            type="text" 
            id="subject" 
            placeholder="e.g., Computer Science" 
            required 
            maxlength="50" 
          />
        </div>
        
        <div class="form-field">
          <label for="semester">Semester *</label>
          <select id="semester" required>
            <option value="">Select Semester</option>
            <option value="1">1st Semester</option>
            <option value="2">2nd Semester</option>
            <option value="3">3rd Semester</option>
            <option value="4">4th Semester</option>
            <option value="5">5th Semester</option>
            <option value="6">6th Semester</option>
            <option value="7">7th Semester</option>
            <option value="8">8th Semester</option>
          </select>
        </div>
        
        <div class="form-field">
          <label for="assignment-number">Assignment Number</label>
          <input 
            type="text" 
            id="assignment-number" 
            placeholder="e.g., 1, 2, Lab-1" 
            maxlength="20" 
          />
        </div>
        
        <div class="form-field">
          <label for="drive-link">Google Drive Link *</label>
          <input 
            type="url" 
            id="drive-link" 
            placeholder="https://drive.google.com/..." 
            required 
          />
          <div class="form-hint">Make sure the link is publicly accessible</div>
        </div>
        
        <div class="form-field">
          <label for="keywords">Keywords (comma-separated)</label>
          <input 
            type="text" 
            id="keywords" 
            placeholder="e.g., arrays, sorting, algorithms" 
            maxlength="200" 
          />
          <div class="form-hint">Help others find your assignment</div>
        </div>
        
        <div id="upload-message" class="message" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" id="submit-upload">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Assignment
        </button>
        <button type="button" class="btn btn-outline" id="cancel-upload">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Profile Modal -->
  <dialog id="profile-modal">
    <form method="dialog">
      <div class="modal-header">
        <strong id="profile-modal-title">User Profile</strong>
        <button class="btn btn-outline" value="cancel">Close</button>
      </div>
      <div class="modal-body">
        <div class="profile-avatar" id="profile-avatar"></div>
        <div class="profile-info" id="profile-info"></div>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { auth, db, initAuth, signOutUser, redirectToLogin, requireAuth } from './js/auth.js';
    import {
      collection, addDoc, getDocs, query, orderBy, serverTimestamp,
      doc, getDoc as getFirestoreDoc, updateDoc, increment, arrayUnion, arrayRemove, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // OneSignal Configuration
    const ONESIGNAL_APP_ID = '0257af89-d319-4e08-9af3-cb483d8f9a69';
    const ONESIGNAL_REST_API_KEY = 'os_v2_app_ajl27cotdfhargxtzned3d42nfmkapdbrafulyn25uznfsx74htj45o2gt6mfuocaldgrlaijzcopj6sknda7ayls6jkn4av4bplhca';
    const SITE_URL = 'https://shaktisingh5580.github.io/PROGRAMING-FOR-LOOSERS-CLUB-/';

    // OneSignal state management
    let oneSignalInitialized = false;
    let oneSignalReady = false;

    // Wait for OneSignal to be available
    function waitForOneSignal(maxAttempts = 50) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        
        const checkOneSignal = () => {
          attempts++;
          
          if (typeof OneSignal !== 'undefined') {
            resolve(OneSignal);
          } else if (attempts >= maxAttempts) {
            reject(new Error('OneSignal SDK failed to load'));
          } else {
            setTimeout(checkOneSignal, 200);
          }
        };
        
        checkOneSignal();
      });
    }

    // Initialize OneSignal with proper error handling
    async function initializeOneSignal() {
      if (oneSignalInitialized) {
        console.log('OneSignal already initialized');
        return;
      }

      try {
        console.log('Waiting for OneSignal SDK...');
        await waitForOneSignal();
        
        console.log('Initializing OneSignal...');
        
        await OneSignal.init({
          appId: ONESIGNAL_APP_ID,
          allowLocalhostAsSecureOrigin: true,
          notifyButton: { enable: false }
        });

        oneSignalInitialized = true;
        oneSignalReady = true;
        
        console.log('OneSignal initialized successfully');

        // Set up event listeners
        OneSignal.on('subscriptionChange', function(isSubscribed) {
          console.log('OneSignal subscription changed:', isSubscribed);
          if (isSubscribed && currentUser && currentProfile) {
            tagUserWithSemester();
          }
        });

        // Check existing subscription
        const isEnabled = await OneSignal.isPushNotificationsEnabled();
        if (isEnabled && currentUser && currentProfile) {
          await tagUserWithSemester();
        } else if (currentUser && currentProfile && !localStorage.getItem('notificationBannerDismissed')) {
          showNotificationBanner();
        }

      } catch (error) {
        console.error('OneSignal initialization failed:', error);
        oneSignalInitialized = false;
        oneSignalReady = false;
      }
    }

    // DOM elements
    const userAvatar = document.getElementById('user-avatar');
    const userName = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    const loginLink = document.getElementById('login-link');
    const assignmentsGrid = document.getElementById('assignments-grid');
    const searchInput = document.getElementById('search-input');
    const semesterFilter = document.getElementById('semester-filter');
    const subjectFilter = document.getElementById('subject-filter');
    const assignmentNumberFilter = document.getElementById('assignment-number-filter');
    const sortSelect = document.getElementById('sort-select');
    const applyFiltersBtn = document.getElementById('apply-filters-btn');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');

    // Mobile filters toggle
    const mobileFiltersToggle = document.getElementById('mobile-filters-toggle');
    const filtersSection = document.getElementById('filters-section');

    // Notification elements
    const notificationBanner = document.getElementById('notification-banner');
    const enableNotificationsBtn = document.getElementById('enable-notifications');
    const dismissBannerBtn = document.getElementById('dismiss-banner');
    const notificationToggleBtn = document.getElementById('notification-toggle-btn');
    const notificationStatus = document.getElementById('notification-status');

    // Upload elements
    const uploadBtn = document.getElementById('upload-btn');
    const uploadModal = document.getElementById('upload-modal');
    const uploadForm = document.getElementById('upload-form');
    const submitUpload = document.getElementById('submit-upload');
    const cancelUpload = document.getElementById('cancel-upload');
    const uploadMessage = document.getElementById('upload-message');

    // Form elements
    const assignmentTitleEl = document.getElementById('assignment-title');
    const subjectEl = document.getElementById('subject');
    const semesterEl = document.getElementById('semester');
    const assignmentNumberEl = document.getElementById('assignment-number');
    const driveLinkEl = document.getElementById('drive-link');
    const keywordsEl = document.getElementById('keywords');

    // Profile modal elements
    const profileModal = document.getElementById('profile-modal');
    const profileModalTitle = document.getElementById('profile-modal-title');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileInfo = document.getElementById('profile-info');

    // Global State
    let allAssignments = [];
    let userNamesCache = {};
    let currentUser = null;
    let currentProfile = null;
    let notificationPreferences = null;
    const profileCache = new Map();

    // Debug function to check Firebase connection
    async function testFirebaseConnection() {
      try {
        console.log('Testing Firebase connection...');
        console.log('Auth object:', auth);
        console.log('DB object:', db);
        
        // Test a simple query
        const testQuery = query(collection(db, 'assignments'));
        const testSnapshot = await getDocs(testQuery);
        console.log('Firebase connection successful. Documents found:', testSnapshot.size);
        return true;
      } catch (error) {
        console.error('Firebase connection failed:', error);
        return false;
      }
    }

    // Assignment functions
    async function fetchAssignments() {
      console.log('Starting fetchAssignments...');
      
      assignmentsGrid.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <div style="margin-left: 1rem;">Loading assignments...</div>
        </div>
      `;
      
      try {
        // Test Firebase connection first
        const connectionOk = await testFirebaseConnection();
        if (!connectionOk) {
          throw new Error('Firebase connection failed');
        }

        console.log('Fetching assignments from Firestore...');
        const assignmentsRef = collection(db, "assignments");
        const assignmentsQuery = query(assignmentsRef, orderBy("uploadDate", "desc"));
        const snapshot = await getDocs(assignmentsQuery);
        
        console.log('Raw snapshot:', snapshot);
        console.log('Number of documents:', snapshot.size);
        
        allAssignments = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          console.log('Document data:', data);
          allAssignments.push({ 
            id: docSnap.id, 
            ...data 
          });
        });
        
        console.log('All assignments loaded:', allAssignments);
        
        populateAllFilters();
        await renderAssignments(allAssignments);
        
      } catch (error) {
        console.error("Error fetching assignments:", error);
        
        // Show detailed error message
        assignmentsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⚠️</div>
            <div class="empty-title">Could not load assignments</div>
            <div class="empty-description">
              Error: ${error.message}<br>
              Please check the console for more details.
            </div>
            <button class="btn btn-primary" onclick="window.fetchAssignments()" style="margin-top: 1rem;">
              Retry
            </button>
          </div>
        `;
      }
    }

    async function renderAssignments(assignmentsToRender) {
      console.log('Rendering assignments:', assignmentsToRender);
      
      assignmentsGrid.innerHTML = '';
      
      if (!assignmentsToRender || assignmentsToRender.length === 0) {
        assignmentsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📁</div>
            <div class="empty-title">No assignments found</div>
            <div class="empty-description">
              ${allAssignments.length === 0 
                ? 'Be the first to upload an assignment!' 
                : 'Try adjusting your filters to see more results.'
              }
            </div>
          </div>
        `;
        return;
      }

      // Fetch uploader names
      const uploaderNamePromises = assignmentsToRender.map(assignment =>
        fetchUploaderName(assignment.uploaderId, assignment.uploaderEmail || 'Anonymous')
      );
      
      let uploaderNames = [];
      try {
        uploaderNames = await Promise.all(uploaderNamePromises);
      } catch (error) {
        console.warn('Error fetching uploader names:', error);
        uploaderNames = assignmentsToRender.map(a => a.uploaderEmail || 'Anonymous');
      }

      assignmentsToRender.forEach((assignment, index) => {
        const card = document.createElement('div');
        card.classList.add('assignment-card');

        const uploadDate = assignment.uploadDate?.toDate ? 
          assignment.uploadDate.toDate().toLocaleDateString() : 
          (assignment.uploadDate ? new Date(assignment.uploadDate.seconds * 1000).toLocaleDateString() : 'N/A');
        
        const uploaderName = uploaderNames[index] || assignment.uploaderEmail || 'Unknown';
        const userHasVoted = currentUser && Array.isArray(assignment.votedBy) && assignment.votedBy.includes(currentUser.uid);

        card.innerHTML = `
          <div class="card-header">
            <div class="card-title">${escapeHtml(assignment.assignmentTitle || 'Untitled')}</div>
            <div class="card-meta">
              <span class="uploader-link" onclick="window.openProfileModal('${assignment.uploaderId}')">${escapeHtml(uploaderName)}</span>
              <span>•</span>
              <span>${uploadDate}</span>
            </div>
          </div>
          
          <div class="card-body">
            <div class="card-info">
              <div class="info-item">
                <span class="info-label">Subject</span>
                <span class="info-value">${escapeHtml(assignment.subject || 'N/A')}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Semester</span>
                <span class="info-value">${getOrdinalSuffix(assignment.semester)}</span>
              </div>
              ${assignment.assignmentNumber ? `
                <div class="info-item">
                  <span class="info-label">Assignment No.</span>
                  <span class="info-value">${escapeHtml(assignment.assignmentNumber)}</span>
                </div>
              ` : ''}
            </div>
            
            ${assignment.keywords?.length > 0 ? `
              <div class="keywords">
                ${assignment.keywords.map(k => `<span class="keyword-tag">${escapeHtml(k)}</span>`).join('')}
              </div>
            ` : ''}
          </div>
          
          <div class="card-footer">
            <div class="vote-section">
              <button class="vote-btn ${userHasVoted ? 'voted' : ''}" onclick="window.handleVote('${assignment.id}', this)" ${!currentUser ? 'disabled title="Sign in to vote"' : ''}>
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                </svg>
              </button>
              <span class="vote-count">${assignment.votes || 0}</span>
            </div>
            
            <a href="${assignment.driveLink || '#'}" target="_blank" rel="noopener noreferrer" class="view-btn">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
              View Assignment
            </a>
          </div>
        `;

        assignmentsGrid.appendChild(card);
      });
    }

    // Utility function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function handleVote(assignmentId, voteButtonElement) {
      if (!currentUser) {
        redirectToLogin();
        return;
      }
      if (!assignmentId) return;

      const voteSection = voteButtonElement.closest('.vote-section');
      const voteCountSpan = voteSection?.querySelector('.vote-count');
      const originalVoted = voteButtonElement.classList.contains('voted');
      const originalCount = parseInt(voteCountSpan?.textContent || '0', 10);

      // Optimistic UI update
      voteButtonElement.disabled = true;
      voteButtonElement.classList.toggle('voted');
      if (voteCountSpan) {
        voteCountSpan.textContent = String(originalCount + (originalVoted ? -1 : 1));
      }

      try {
        const assignmentRef = doc(db, "assignments", assignmentId);
        const docSnap = await getFirestoreDoc(assignmentRef);
        
        if (!docSnap.exists()) {
          throw new Error('This assignment no longer exists.');
        }
        
        const assignmentData = docSnap.data();
        const hasVoted = (assignmentData.votedBy || []).includes(currentUser.uid);
        
        const updatePayload = hasVoted
          ? { votes: increment(-1), votedBy: arrayRemove(currentUser.uid) }
          : { votes: increment(1), votedBy: arrayUnion(currentUser.uid) };
        
        await updateDoc(assignmentRef, updatePayload);
        
        console.log('Vote updated successfully');
        
      } catch (error) {
        console.error('Vote error:', error);
        
        // Revert UI on failure
        voteButtonElement.classList.toggle('voted');
        if (voteCountSpan) {
          voteCountSpan.textContent = String(originalCount);
        }
        
        alert('Failed to update vote. Please try again.');
      } finally {
        voteButtonElement.disabled = false;
      }
    }

    // Upload functions
    function showUploadMessage(text, isError = true) {
      uploadMessage.textContent = text;
      uploadMessage.className = `message ${isError ? 'error' : 'success'}`;
      uploadMessage.style.display = 'block';
    }

    function hideUploadMessage() {
      uploadMessage.style.display = 'none';
    }

    function resetUploadForm() {
      uploadForm.reset();
      hideUploadMessage();
    }

    async function handleUploadSubmit(e) {
      e.preventDefault();
      hideUploadMessage();

      if (!currentUser) {
        showUploadMessage('Please sign in to upload assignments.');
        return;
      }

      const title = assignmentTitleEl.value.trim();
      const subject = subjectEl.value.trim();
      const semester = semesterEl.value;
      const assignmentNumber = assignmentNumberEl.value.trim();
      const driveLink = driveLinkEl.value.trim();
      const keywords = keywordsEl.value.trim();

      // Validation
      if (!title || !subject || !semester || !driveLink) {
        showUploadMessage('Please fill in all required fields.');
        return;
      }

      if (!driveLink.match(/^https?:\/\/.+/)) {
        showUploadMessage('Please enter a valid URL for the Google Drive link.');
        return;
      }

      // Parse keywords
      const keywordArray = keywords ? keywords.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];

      // Show loading state
      const originalText = submitUpload.innerHTML;
      submitUpload.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></div> Uploading...';
      submitUpload.disabled = true;

      try {
        const assignmentData = {
          assignmentTitle: title,
          subject: subject,
          semester: semester,
          assignmentNumber: assignmentNumber || '',
          driveLink: driveLink,
          keywords: keywordArray,
          uploaderId: currentUser.uid,
          uploaderEmail: currentUser.email,
          uploadDate: serverTimestamp(),
          votes: 0,
          votedBy: []
        };

        console.log('Uploading assignment:', assignmentData);
        const docRef = await addDoc(collection(db, 'assignments'), assignmentData);
        console.log('Assignment uploaded with ID:', docRef.id);
        
        // Send notification
        try {
          const notificationResult = await sendNotificationToSemester({
            ...assignmentData,
            id: docRef.id
          });
          
          if (notificationResult.success) {
            showUploadMessage(`Assignment uploaded successfully! ${notificationResult.recipients || 0} users notified.`, false);
          } else {
            showUploadMessage('Assignment uploaded successfully! (Notification failed to send)', false);
          }
        } catch (notifError) {
          console.warn('Notification error:', notifError);
          showUploadMessage('Assignment uploaded successfully! (Notification failed to send)', false);
        }
        
        resetUploadForm();
        
        // Refresh assignments list
        setTimeout(() => {
          uploadModal.close();
          fetchAssignments();
        }, 1500);

      } catch (error) {
        console.error('Error uploading assignment:', error);
        showUploadMessage(`Failed to upload assignment: ${error.message}`);
      } finally {
        submitUpload.innerHTML = originalText;
        submitUpload.disabled = false;
      }
    }

    // Filtering and sorting functions
    function populateAllFilters() {
      const semesters = [...new Set(allAssignments.map(a => a.semester).filter(Boolean))].sort((a, b) => a - b);
      const subjects = [...new Set(allAssignments.map(a => a.subject).filter(Boolean))].sort();
      
      populateFilterDropdown(semesterFilter, semesters.map(s => ({ value: s, text: `${getOrdinalSuffix(s)} Semester` })), 'All Semesters');
      populateFilterDropdown(subjectFilter, subjects.map(s => ({ value: s, text: s })), 'All Subjects');
    }

    function populateFilterDropdown(selectElement, items, defaultOptionText) {
      const currentValue = selectElement.value;
      selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
      
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = typeof item === 'object' ? item.value : item;
        option.textContent = typeof item === 'object' ? item.text : item;
        selectElement.appendChild(option);
      });
      
      selectElement.value = currentValue;
    }

    function applyCurrentFilters() {
      if (!allAssignments || allAssignments.length === 0) {
        console.log('No assignments to filter');
        return;
      }

      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedSemester = semesterFilter.value;
      const selectedSubject = subjectFilter.value;
      const assignmentNumFilter = assignmentNumberFilter.value.toLowerCase().trim();
      const sortByValue = sortSelect.value;

      console.log('Applying filters:', { searchTerm, selectedSemester, selectedSubject, assignmentNumFilter, sortByValue });

      let filtered = allAssignments.filter(a => {
        const matchesSearch = !searchTerm || [
          a.assignmentTitle || '',
          a.subject || '',
          ...(a.keywords || [])
        ].join(' ').toLowerCase().includes(searchTerm);
        
        const matchesSemester = !selectedSemester || String(a.semester) === selectedSemester;
        const matchesSubject = !selectedSubject || a.subject === selectedSubject;
        const matchesAssignmentNum = !assignmentNumFilter || String(a.assignmentNumber || '').toLowerCase().includes(assignmentNumFilter);
        
        return matchesSearch && matchesSemester && matchesSubject && matchesAssignmentNum;
      });

      // Sort filtered results
      filtered.sort((a, b) => {
        if (sortByValue === 'votes_desc') {
          return (b.votes || 0) - (a.votes || 0);
        }
        if (sortByValue === 'uploadDate_asc') {
          const aTime = a.uploadDate?.toMillis?.() || a.uploadDate?.seconds * 1000 || 0;
          const bTime = b.uploadDate?.toMillis?.() || b.uploadDate?.seconds * 1000 || 0;
          return aTime - bTime;
        }
        // Default: newest first
        const aTime = a.uploadDate?.toMillis?.() || a.uploadDate?.seconds * 1000 || 0;
        const bTime = b.uploadDate?.toMillis?.() || b.uploadDate?.seconds * 1000 || 0;
        return bTime - aTime;
      });

      console.log('Filtered assignments:', filtered);
      renderAssignments(filtered);
    }

    function resetAllFilters() {
      searchInput.value = '';
      semesterFilter.value = '';
      subjectFilter.value = '';
      assignmentNumberFilter.value = '';
      sortSelect.value = 'uploadDate_desc';
      applyCurrentFilters();
    }

    async function fetchUploaderName(uploaderId, fallbackName = 'Anonymous') {
      if (userNamesCache[uploaderId]) {
        return userNamesCache[uploaderId];
      }
      
      if (!uploaderId) {
        return fallbackName;
      }
      
      try {
        const userDocRef = doc(db, 'profiles', uploaderId);
        const docSnap = await getFirestoreDoc(userDocRef);
        
        if (docSnap.exists() && docSnap.data().name) {
          const displayName = docSnap.data().name;
          userNamesCache[uploaderId] = displayName;
          return displayName;
        }
        
        return fallbackName;
      } catch (error) {
        console.warn('fetchUploaderName failed:', error);
        return fallbackName;
      }
    }

    // Profile functions
    async function loadProfile(uid) {
      if (profileCache.has(uid)) {
        return profileCache.get(uid);
      }
      
      try {
        const profileRef = doc(db, 'profiles', uid);
        const profileSnap = await getFirestoreDoc(profileRef);
        
        if (profileSnap.exists()) {
          const profileData = { id: profileSnap.id, ...profileSnap.data() };
          profileCache.set(uid, profileData);
          return profileData;
        } else {
          console.error('Profile not found for UID:', uid);
          return null;
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        return null;
      }
    }

    async function openProfileModal(uid) {
      try {
        const profile = await loadProfile(uid);
        if (!profile) {
          alert('Could not load profile.');
          return;
        }

        profileModalTitle.textContent = profile.name || 'User Profile';
        profileAvatar.textContent = profile.name ? profile.name[0].toUpperCase() : '?';

        profileInfo.innerHTML = '';
        
        // Create profile fields
        const fields = [
          { label: 'Name', value: profile.name || 'N/A' },
          { label: 'College', value: profile.college || 'N/A' },
          { label: 'Semester', value: profile.semester ? getOrdinalSuffix(profile.semester) : 'N/A' }
        ];

        fields.forEach(field => {
          const fieldEl = document.createElement('div');
          fieldEl.className = 'profile-field';
          fieldEl.innerHTML = `
            <span class="label">${field.label}</span>
            <span class="value">${escapeHtml(field.value)}</span>
          `;
          profileInfo.appendChild(fieldEl);
        });

        // Add social links
        const links = document.createElement('div');
        links.className = 'profile-links';
        
        if (profile.instagram) {
          const instagramLink = document.createElement('a');
          instagramLink.className = 'profile-link';
          instagramLink.href = `https://instagram.com/${profile.instagram}`;
          instagramLink.target = '_blank';
          instagramLink.rel = 'noopener noreferrer';
          instagramLink.textContent = 'Instagram';
          links.appendChild(instagramLink);
        }
        
        if (profile.github) {
          const githubLink = document.createElement('a');
          githubLink.className = 'profile-link';
          githubLink.href = profile.github;
          githubLink.target = '_blank';
          githubLink.rel = 'noopener noreferrer';
          githubLink.textContent = 'GitHub';
          links.appendChild(githubLink);
        }
        
        if (profile.linkedin) {
          const linkedinLink = document.createElement('a');
          linkedinLink.className = 'profile-link';
          linkedinLink.href = profile.linkedin;
          linkedinLink.target = '_blank';
          linkedinLink.rel = 'noopener noreferrer';
          linkedinLink.textContent = 'LinkedIn';
          links.appendChild(linkedinLink);
        }

        if (links.children.length > 0) {
          profileInfo.appendChild(links);
        }

        profileModal.showModal();
      } catch (error) {
        console.error('Error opening profile modal:', error);
        alert('Failed to open profile.');
      }
    }

    // Utility functions
    function getOrdinalSuffix(nStr) {
      const n = parseInt(nStr);
      if (isNaN(n)) return typeof nStr === 'string' ? nStr : '';
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    // OneSignal and notification functions
    function initializeOneSignal() {
      if (typeof OneSignal !== 'undefined') {
        OneSignal.init({
          appId: ONESIGNAL_APP_ID,
          allowLocalhostAsSecureOrigin: true,
          notifyButton: { enable: false }
        });

        OneSignal.on('subscriptionChange', function(isSubscribed) {
          console.log('OneSignal subscription changed:', isSubscribed);
          if (isSubscribed && currentUser && currentProfile) {
            tagUserWithSemester();
          }
        });

        OneSignal.isPushNotificationsEnabled().then(function(isEnabled) {
          if (isEnabled && currentUser && currentProfile) {
            tagUserWithSemester();
          } else if (currentUser && currentProfile && !localStorage.getItem('notificationBannerDismissed')) {
            showNotificationBanner();
          }
        });
      }
    }

    function showNotificationBanner() {
      if (currentUser && currentProfile && (!notificationPreferences?.enabled) && !localStorage.getItem('notificationBannerDismissed')) {
        notificationBanner.classList.add('show');
        document.body.style.paddingTop = '80px';
      }
    }

    function hideNotificationBanner() {
      notificationBanner.classList.remove('show');
      document.body.style.paddingTop = '0';
    }

    async function tagUserWithSemester() {
      try {
        if (typeof OneSignal === 'undefined' || !currentProfile) return;
        
        const playerId = await OneSignal.getPlayerId();
        if (playerId) {
          await OneSignal.sendTags({
            semester: currentProfile.semester.toString(),
            user_id: currentUser.uid,
            college: currentProfile.college || 'unknown',
            name: currentProfile.name || 'anonymous'
          });
          console.log('User tagged with semester:', currentProfile.semester);
        }
      } catch (error) {
        console.error('Error tagging user:', error);
      }
    }

    async function sendNotificationToSemester(assignmentData) {
      try {
        const uploaderName = currentProfile?.name || currentUser?.email || 'Someone';
        
        const notificationData = {
          app_id: ONESIGNAL_APP_ID,
          headings: { en: "📚 New Assignment Available!" },
          contents: { en: `${assignmentData.assignmentTitle} (${assignmentData.subject}) has been uploaded by ${uploaderName} for Semester ${assignmentData.semester}` },
          filters: [{ field: "tag", key: "semester", relation: "=", value: assignmentData.semester.toString() }],
          web_url: SITE_URL + "assignments.html",
          chrome_web_icon: SITE_URL + "HummingBird (1).png",
          chrome_web_badge: SITE_URL + "HummingBird (1).png",
          web_buttons: [{ id: "view-assignment", text: "View Assignment", url: SITE_URL + "assignments.html" }],
          data: { type: "assignment", semester: assignmentData.semester, subject: assignmentData.subject, assignmentId: assignmentData.id }
        };

        const response = await fetch('https://onesignal.com/api/v1/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Basic ${ONESIGNAL_REST_API_KEY}` },
          body: JSON.stringify(notificationData)
        });

        const result = await response.json();
        
        if (response.ok) {
          console.log('Notification sent successfully:', result);
          return { success: true, id: result.id, recipients: result.recipients };
        } else {
          console.error('Failed to send notification:', result);
          return { success: false, error: result };
        }
      } catch (error) {
        console.error('Error sending notification:', error);
        return { success: false, error: error.message };
      }
    }

    // Notification preferences functions
    async function loadNotificationPreferences() {
      if (!currentUser) return;
      
      try {
        const prefsRef = doc(db, 'userNotificationPreferences', currentUser.uid);
        const prefsSnap = await getFirestoreDoc(prefsRef);
        
        if (prefsSnap.exists()) {
          notificationPreferences = prefsSnap.data();
          updateNotificationButtonUI(notificationPreferences.enabled || false);
        } else {
          notificationPreferences = {
            enabled: false,
            semester: currentProfile?.semester || null,
            college: currentProfile?.college || null,
            name: currentProfile?.name || null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };
          await setDoc(prefsRef, notificationPreferences);
          updateNotificationButtonUI(false);
        }
      } catch (error) {
        console.error('Error loading notification preferences:', error);
        updateNotificationButtonUI(false);
      }
    }

    function updateNotificationButtonUI(isEnabled) {
      if (isEnabled) {
        notificationToggleBtn.classList.add('enabled');
        notificationStatus.textContent = 'Enabled';
        notificationToggleBtn.title = 'Disable Push Notifications';
      } else {
        notificationToggleBtn.classList.remove('enabled');
        notificationStatus.textContent = 'Enable';
        notificationToggleBtn.title = 'Enable Push Notifications';
      }
    }

    async function saveNotificationPreferences(enabled, playerId = null) {
      if (!currentUser || !currentProfile) return;
      
      try {
        const prefsRef = doc(db, 'userNotificationPreferences', currentUser.uid);
        const prefsData = {
          enabled: enabled,
          semester: currentProfile.semester,
          college: currentProfile.college || null,
          name: currentProfile.name || null,
          email: currentUser.email,
          userId: currentUser.uid,
          updatedAt: serverTimestamp()
        };
        
        if (playerId) {
          prefsData.oneSignalPlayerId = playerId;
        }
        
        if (!notificationPreferences) {
          prefsData.createdAt = serverTimestamp();
        }
        
        await setDoc(prefsRef, prefsData, { merge: true });
        notificationPreferences = { ...notificationPreferences, ...prefsData };
        
        console.log('Notification preferences saved:', prefsData);
        return true;
      } catch (error) {
        console.error('Error saving notification preferences:', error);
        return false;
      }
    }

    async function subscribeUserToNotifications() {
      try {
        if (typeof OneSignal === 'undefined') {
          alert('OneSignal is not loaded. Please refresh the page and try again.');
          return;
        }

        const permission = await OneSignal.showNativePrompt();
        if (!permission) {
          alert('Please allow notifications to get updates about new assignments!');
          return;
        }

        const playerId = await OneSignal.getPlayerId();
        if (playerId && currentProfile) {
          await tagUserWithSemester();
          await saveNotificationPreferences(true, playerId);
          updateNotificationButtonUI(true);
          hideNotificationBanner();
          localStorage.setItem('notificationBannerDismissed', 'true');
          alert('🎉 Notifications enabled! You\'ll get notified when new assignments for your semester are uploaded.');
        }
      } catch (error) {
        console.error('Error subscribing to notifications:', error);
        alert('Failed to enable notifications. Please try again.');
      }
    }

    async function handleNotificationToggle() {
      if (!currentUser || !currentProfile) {
        alert('Please complete your profile first.');
        return;
      }
      
      const currentlyEnabled = notificationPreferences?.enabled || false;
      
      if (!currentlyEnabled) {
        try {
          if (typeof OneSignal === 'undefined') {
            alert('OneSignal is not loaded. Please refresh the page and try again.');
            return;
          }
          
          const isSubscribed = await OneSignal.isPushNotificationsEnabled();
          
          if (!isSubscribed) {
            const permission = await OneSignal.showNativePrompt();
            if (!permission) {
              alert('Please allow notifications to enable this feature!');
              return;
            }
          }
          
          const playerId = await OneSignal.getPlayerId();
          if (playerId) {
            await tagUserWithSemester();
            await saveNotificationPreferences(true, playerId);
            updateNotificationButtonUI(true);
            hideNotificationBanner();
            localStorage.setItem('notificationBannerDismissed', 'true');
            
            const successMsg = document.createElement('div');
            successMsg.className = 'message success';
            successMsg.style.cssText = 'position: fixed; top: 100px; right: 20px; z-index: 1001; max-width: 300px;';
            successMsg.textContent = '🎉 Push notifications enabled! You\'ll get notified about new assignments for your semester.';
            document.body.appendChild(successMsg);
            
            setTimeout(() => successMsg.remove(), 4000);
          }
        } catch (error) {
          console.error('Error enabling notifications:', error);
          alert('Failed to enable notifications. Please try again.');
        }
      } else {
        try {
          await saveNotificationPreferences(false);
          updateNotificationButtonUI(false);
          
          if (typeof OneSignal !== 'undefined') {
            await OneSignal.setSubscription(false);
          }
          
          const disabledMsg = document.createElement('div');
          disabledMsg.className = 'message';
          disabledMsg.style.cssText = 'position: fixed; top: 100px; right: 20px; z-index: 1001; max-width: 300px; background: rgba(255, 93, 93, 0.1); color: var(--danger); border: 1px solid rgba(255, 93, 93, 0.2);';
          disabledMsg.textContent = '🔕 Push notifications disabled.';
          document.body.appendChild(disabledMsg);
          
          setTimeout(() => disabledMsg.remove(), 3000);
        } catch (error) {
          console.error('Error disabling notifications:', error);
          alert('Failed to disable notifications. Please try again.');
        }
      }
    }

    // Mobile functions
    function toggleMobileFilters() {
      const isCollapsed = mobileFiltersToggle.classList.contains('collapsed');
      
      if (isCollapsed) {
        mobileFiltersToggle.classList.remove('collapsed');
        filtersSection.classList.add('expanded');
      } else {
        mobileFiltersToggle.classList.add('collapsed');
        filtersSection.classList.remove('expanded');
      }
    }

    function initializeMobileFilters() {
      if (window.innerWidth <= 768) {
        mobileFiltersToggle.classList.add('collapsed');
        filtersSection.classList.remove('expanded');
      }
    }

    // Auth functions
    function updateAuthUI() {
      if (currentUser) {
        const displayName = currentProfile?.name || currentUser.email;
        const avatar = currentProfile?.name ? currentProfile.name[0].toUpperCase() : currentUser.email[0].toUpperCase();
        
        userAvatar.textContent = avatar;
        userName.textContent = displayName;
        loginLink.style.display = 'none';
        logoutBtn.classList.remove('hidden');
        notificationToggleBtn.classList.remove('hidden');
        
        loadNotificationPreferences();
      } else {
        userAvatar.textContent = '?';
        userName.textContent = 'Guest';
        loginLink.style.display = 'inline-flex';
        logoutBtn.classList.add('hidden');
        notificationToggleBtn.classList.add('hidden');
      }
    }

    // Make functions globally available
    window.openProfileModal = openProfileModal;
    window.handleVote = handleVote;
    window.fetchAssignments = fetchAssignments;

    // Event listeners
    logoutBtn.addEventListener('click', signOutUser);
    applyFiltersBtn.addEventListener('click', applyCurrentFilters);
    resetFiltersBtn.addEventListener('click', resetAllFilters);
    sortSelect.addEventListener('change', applyCurrentFilters);
    mobileFiltersToggle.addEventListener('click', toggleMobileFilters);
    enableNotificationsBtn.addEventListener('click', subscribeUserToNotifications);
    dismissBannerBtn.addEventListener('click', () => {
      hideNotificationBanner();
      localStorage.setItem('notificationBannerDismissed', 'true');
    });
    notificationToggleBtn.addEventListener('click', handleNotificationToggle);
    uploadBtn.addEventListener('click', () => {
      if (!currentUser) {
        redirectToLogin();
        return;
      }
      resetUploadForm();
      uploadModal.showModal();
    });
    uploadForm.addEventListener('submit', handleUploadSubmit);
    cancelUpload.addEventListener('click', () => uploadModal.close());

    // Initialize auth and load data
    initAuth({
      onAuthStateChanged: async (user, profile) => {
        console.log('Auth state changed:', { user: !!user, profile: !!profile });
        currentUser = user;
        currentProfile = profile;
        updateAuthUI();
        
        if (user && profile) {
          await loadNotificationPreferences();
          setTimeout(() => {
            initializeOneSignal();
            setTimeout(() => showNotificationBanner(), 1000);
          }, 1000);
        }
        
        // Always try to fetch assignments (works for guests too)
        fetchAssignments();
      }
    });

    // Initialize mobile filters and OneSignal
    initializeMobileFilters();
    
    setTimeout(() => {
      initializeOneSignal();
    }, 2000);

    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        filtersSection.classList.remove('expanded');
        mobileFiltersToggle.classList.add('collapsed');
      } else {
        initializeMobileFilters();
      }
    });

    // Initial load for guests
    console.log('Page loaded, attempting to fetch assignments...');
    fetchAssignments();
</script>
