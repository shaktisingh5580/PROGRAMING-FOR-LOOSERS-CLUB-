<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Programming for Losers — Chat</title>
    <meta name="color-scheme" content="dark light" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #0f0f10;
        --elev: #151517;
        --elev-2: #1b1b1e;
        --muted: #d9d9db;
        --soft: #a9a9ad;
        --line: #2a2a2e;
        --accent: #ffffff;
        --danger: #ff5d5d;
        --ok: #43d17a;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--muted);
      }
      a { color: var(--muted); text-decoration: none; }
      a:hover { text-decoration: underline; }
      button, input, select, textarea {
        font: inherit;
        color: var(--muted);
        background: var(--elev);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px;
        outline: none;
      }
      input::placeholder, textarea::placeholder { color: var(--soft); }
      button {
        cursor: pointer;
        background: transparent;
        border: 1px solid var(--muted);
        color: var(--muted);
      }
      button:hover { background: var(--elev); }
      button[disabled] { opacity: .6; cursor: not-allowed; }
      .btn-primary { background: var(--muted); color: #0b0b0c; border-color: var(--muted); }
      .btn-primary:hover { filter: brightness(.95); }
      .btn-ghost { background: transparent; border-color: var(--line); }
      .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
      .btn-danger:hover { background: #e04545; }
      header {
        position: sticky;
        top: 0;
        z-index: 40;
        background: linear-gradient(180deg, #0f0f10, #0f0f10f0 70%, transparent);
        border-bottom: 1px solid var(--line);
      }
      .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
      .brand {
        display: flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: .2px;
      }
      .badge {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 6px 10px; border: 1px solid var(--line); border-radius: 999px;
        color: var(--soft); font-size: 12px;
      }
      .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
      .grow { flex: 1; }
      .toolbar { display: flex; gap: 8px; align-items: center; }
      .tabs {
        margin-top: 10px; display: flex; gap: 8px; border-bottom: 1px solid var(--line);
      }
      .tab {
        padding: 10px 14px; border: 1px solid var(--line);
        border-bottom: none; border-radius: 10px 10px 0 0;
        background: var(--elev);
        color: var(--muted);
      }
      .tab[aria-selected="true"] { background: var(--elev-2); font-weight: 600; }
      main { padding: 16px; }
      .grid {
        display: grid; gap: 16px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 1024px) {
        .grid-2 { grid-template-columns: 280px 1fr; }
      }
      .panel {
        background: var(--elev-2);
        border: 1px solid var(--line);
        border-radius: 16px; overflow: clip;
        display: flex; flex-direction: column; min-height: 360px;
      }
      .panel-header {
        padding: 12px 14px; border-bottom: 1px solid var(--line);
        display: flex; justify-content: space-between; align-items: center; gap: 8px;
      }
      .panel-body { padding: 12px; overflow: auto; height: 420px; }
      .panel-footer { padding: 12px; border-top: 1px solid var(--line); display: flex; gap: 8px; }
      .msg {
        display: grid; grid-template-columns: 1fr auto; gap: 6px;
        padding: 10px 12px; border: 1px solid var(--line); border-radius: 12px; background: #121214;
        position: relative;
      }
      .msg + .msg { margin-top: 8px; }
      .msg .meta { color: var(--soft); font-size: 12px; }
      .msg.me { background: #14161a; border-color: #2c3238; }
      .msg .text { white-space: pre-wrap; word-wrap: break-word; }
      .msg .username {
        color: var(--accent);
        cursor: pointer;
        text-decoration: underline;
        text-decoration-color: transparent;
        transition: text-decoration-color 0.2s;
      }
      .msg .username:hover {
        text-decoration-color: var(--accent);
      }
      .msg-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        display: none;
        gap: 4px;
      }
      .msg:hover .msg-actions {
        display: flex;
      }
      .msg-action-btn {
        background: var(--elev);
        border: 1px solid var(--line);
        color: var(--soft);
        padding: 4px 6px;
        font-size: 10px;
        border-radius: 4px;
        cursor: pointer;
      }
      .msg-action-btn:hover {
        background: var(--elev-2);
        color: var(--muted);
      }
      .reply-indicator {
        background: var(--line);
        border-left: 3px solid var(--accent);
        padding: 6px 8px;
        margin-bottom: 6px;
        border-radius: 0 6px 6px 0;
        font-size: 11px;
        color: var(--soft);
      }
      .editing-input {
        background: var(--elev);
        border: 1px solid var(--accent);
        color: var(--muted);
        padding: 8px;
        border-radius: 6px;
        width: 100%;
        margin-top: 6px;
      }
      .edit-actions {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }
      .edit-actions button {
        padding: 4px 8px;
        font-size: 11px;
      }
      .reply-bar {
        background: var(--elev);
        border: 1px solid var(--line);
        padding: 8px 12px;
        display: none;
        align-items: center;
        gap: 8px;
        border-radius: 8px 8px 0 0;
      }
      .reply-bar.active {
        display: flex;
      }
      .reply-preview {
        flex: 1;
        font-size: 12px;
        color: var(--soft);
      }
      .reply-close {
        background: none;
        border: none;
        color: var(--soft);
        cursor: pointer;
        padding: 2px;
      }
      .hint {
        display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--soft);
        padding: 10px 12px; border: 1px dashed var(--line); border-radius: 12px; background: #101012;
      }
      .error { color: var(--danger); font-size: 13px; }
      .success { color: var(--ok); font-size: 13px; }
      .list {
        display: flex; flex-direction: column; gap: 8px; padding: 10px;
      }
      .list-item {
        display: flex; align-items: center; justify-content: space-between;
        gap: 10px; padding: 10px 12px; border: 1px solid var(--line); border-radius: 12px; background: #121214;
      }
      .list-item .title { font-weight: 600; }
      .list-item .sub { color: var(--soft); font-size: 12px; }
      .search { display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--line); }
      /* Modal */
      dialog {
        border: 1px solid var(--line);
        border-radius: 16px; background: var(--elev-2); color: var(--muted);
        padding: 0; max-width: 480px; width: calc(100% - 24px);
      }
      dialog::backdrop { background: #0008; }
      .modal-header { padding: 16px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; }
      .modal-body { padding: 16px; display: grid; gap: 12px; }
      .field { display: grid; gap: 6px; }
      .field label { color: var(--soft); font-size: 13px; }
      .muted-link { color: var(--soft); text-decoration: underline; cursor: pointer; }
      .pill { padding: 4px 10px; border: 1px solid var(--line); border-radius: 999px; color: var(--soft); font-size: 12px; }
      .pill.ok { color: var(--ok); border-color: #2b6f51; }
      .pill.warn { border-style: dashed; }
      
      /* Profile modal styles */
      .profile-info {
        display: grid;
        gap: 12px;
      }
      .profile-field {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--line);
      }
      .profile-field:last-child {
        border-bottom: none;
      }
      .profile-field .label {
        color: var(--soft);
        font-size: 13px;
      }
      .profile-field .value {
        color: var(--muted);
        font-weight: 500;
      }
      .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--elev);
        border: 2px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
        color: var(--accent);
        margin: 0 auto 16px;
      }
      .profile-links {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .profile-link {
        padding: 4px 8px;
        border: 1px solid var(--line);
        border-radius: 999px;
        color: var(--muted);
        text-decoration: none;
        font-size: 12px;
      }
      .profile-link:hover {
        background: var(--elev);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="row">
          <div class="brand">
            <span class="badge" aria-hidden="true">PFL</span>
            <div>
              <div>Programming for Losers</div>
              <div style="font-size:12px;color:var(--soft)">College community chat · matte black & white</div>
            </div>
          </div>
          <div class="grow"></div>
          <nav class="toolbar" aria-label="Global">
            <a href="./profile.html" class="pill warn" id="profile-badge">Complete profile</a>
            <span class="pill" id="auth-state">Guest</span>
            <a href="login.html" class="btn-ghost" id="login-link" style="display:none">Sign in</a>
            <button class="btn-ghost" id="sign-out" style="display:none">Sign out</button>
          </nav>
        </div>
        <div class="tabs" role="tablist" aria-label="Modes">
          <button role="tab" id="tab-community" aria-controls="panel-community" aria-selected="true" class="tab">Community</button>
          <button role="tab" id="tab-dm" aria-controls="panel-dm" aria-selected="false" class="tab">Direct Messages</button>
        </div>
      </div>
    </header>

    <main class="container">
      <!-- Community Chat -->
      <section id="panel-community" role="tabpanel" aria-labelledby="tab-community">
        <div class="panel" aria-label="Community chat">
          <div class="panel-header">
            <div class="row">
              <strong>Community</strong>
              <span class="pill" id="community-count">0 online</span>
            </div>
            <div class="hint" id="send-hint">
              <span>Viewing is open. Sign in to send messages.</span>
            </div>
          </div>
          <div class="panel-body" id="community-messages" aria-live="polite" aria-busy="true"></div>
          <div class="reply-bar" id="reply-bar">
            <div class="reply-preview" id="reply-preview"></div>
            <button class="reply-close" id="reply-close">×</button>
          </div>
          <form class="panel-footer" id="community-form">
            <input id="community-input" type="text" placeholder="Say something to everyone..." autocomplete="off" maxlength="1000" class="grow" />
            <button class="btn-primary" id="community-send" type="submit">Send</button>
          </form>
        </div>
      </section>

      <!-- Direct Messages -->
      <section id="panel-dm" role="tabpanel" aria-labelledby="tab-dm" hidden>
        <div class="grid grid-2">
          <aside class="panel" aria-label="People">
            <div class="panel-header row">
              <strong>People</strong>
              <a href="./profile.html" class="pill">My profile</a>
            </div>
            <div class="search">
              <input id="search-users" placeholder="Search by name or college..." class="grow" />
            </div>
            <div class="list" id="users-list" aria-live="polite"></div>
            <div class="panel-header row">
              <strong>Recent</strong>
            </div>
            <div class="list" id="recent-conversations" aria-live="polite"></div>
          </aside>

          <section class="panel" aria-label="Direct messages">
            <div class="panel-header">
              <div class="row" id="dm-header">
                <strong>No conversation</strong>
                <span class="pill">Select a person</span>
              </div>
            </div>
            <div class="panel-body" id="dm-messages" aria-live="polite"></div>
            <div class="reply-bar" id="dm-reply-bar">
              <div class="reply-preview" id="dm-reply-preview"></div>
              <button class="reply-close" id="dm-reply-close">×</button>
            </div>
            <form class="panel-footer" id="dm-form">
              <input id="dm-input" type="text" placeholder="Message..." autocomplete="off" maxlength="1000" class="grow" />
              <button class="btn-primary" id="dm-send" type="submit">Send</button>
            </form>
          </section>
        </div>
        <div class="hint" id="dm-hint" style="margin-top:12px">
          Sign in to use personal chats.
        </div>
      </section>
    </main>

    <!-- Profile Modal -->
    <dialog id="profile-modal">
      <form method="dialog">
        <div class="modal-header">
          <strong id="profile-modal-title">User Profile</strong>
          <button class="btn-ghost" value="cancel" aria-label="Close">Close</button>
        </div>
        <div class="modal-body" id="profile-modal-body">
          <div class="profile-avatar" id="profile-avatar"></div>
          <div class="profile-info" id="profile-info"></div>
        </div>
      </form>
    </dialog>

    <script type="module">
      import { auth, db, initAuth, signOutUser, redirectToLogin, requireAuth } from './js/auth.js';
      import {
        collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where,
        doc, setDoc, getDoc, getDocs, limit, updateDoc, deleteDoc, Timestamp
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      // UI elements
      const tabs = {
        community: document.getElementById('tab-community'),
        dm: document.getElementById('tab-dm'),
      };
      const panels = {
        community: document.getElementById('panel-community'),
        dm: document.getElementById('panel-dm'),
      };
      const authStateEl = document.getElementById('auth-state');
      const loginLink = document.getElementById('login-link');
      const signOutBtn = document.getElementById('sign-out');
      const profileBadge = document.getElementById('profile-badge');

      // Community chat elements
      const communityMessagesEl = document.getElementById('community-messages');
      const communityForm = document.getElementById('community-form');
      const communityInput = document.getElementById('community-input');
      const communitySend = document.getElementById('community-send');
      const sendHint = document.getElementById('send-hint');
      const replyBar = document.getElementById('reply-bar');
      const replyPreview = document.getElementById('reply-preview');
      const replyClose = document.getElementById('reply-close');

      // DM elements
      const usersList = document.getElementById('users-list');
      const searchUsers = document.getElementById('search-users');
      const dmMessagesEl = document.getElementById('dm-messages');
      const dmForm = document.getElementById('dm-form');
      const dmInput = document.getElementById('dm-input');
      const dmSend = document.getElementById('dm-send');
      const dmHeader = document.getElementById('dm-header');
      const dmHint = document.getElementById('dm-hint');
      const dmReplyBar = document.getElementById('dm-reply-bar');
      const dmReplyPreview = document.getElementById('dm-reply-preview');
      const dmReplyClose = document.getElementById('dm-reply-close');
      const recentConversationsEl = document.getElementById('recent-conversations');

      const communityCount = document.getElementById('community-count');

      // State
      let currentUser = null;
      let currentProfile = null;
      let communityUnsub = null;
      let dmUnsub = null;
      let selectedPeer = null;
      let allProfiles = [];
      const profileCache = new Map();
      let replyingTo = null;
      let editingMessage = null;

      // Utility functions
      function el(tag, attrs = {}, children = []) {
        const e = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === 'class') e.className = v;
          else if (k.startsWith('on') && typeof v === 'function') e.addEventListener(k.slice(2), v);
          else if (v !== null && v !== undefined) e.setAttribute(k, v);
        }
        for (const c of children) e.append(c);
        return e;
      }

      function formatTime(ts) {
        try {
          if (!ts) return '';
          const d = ts.toDate ? ts.toDate() : new Date(ts);
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } catch { return ''; }
      }

      function threadIdFor(a, b) {
        return [a, b].sort().join('_');
      }

      function displayNameFromProfile(profile, fallbackEmail) {
        return (profile && profile.name) || (fallbackEmail || 'Unknown');
      }

      function switchTab(which) {
        const isCommunity = which === 'community';
        tabs.community.setAttribute('aria-selected', String(isCommunity));
        tabs.dm.setAttribute('aria-selected', String(!isCommunity));
        panels.community.hidden = !isCommunity;
        panels.dm.hidden = isCommunity;
      }

      function setAuthUI() {
        if (currentUser) {
          authStateEl.textContent = displayNameFromProfile(currentProfile, currentUser.email);
          loginLink.style.display = 'none';
          signOutBtn.style.display = '';
          sendHint.style.display = 'none';
          communityInput.disabled = false;
          communitySend.disabled = false;
          dmInput.disabled = false;
          dmSend.disabled = false;
          dmHint.style.display = 'none';
          if (!currentProfile) {
            profileBadge.style.display = '';
          } else {
            profileBadge.style.display = 'none';
          }
        } else {
          authStateEl.textContent = 'Guest';
          loginLink.style.display = '';
          signOutBtn.style.display = 'none';
          sendHint.style.display = '';
          communityInput.disabled = true;
          communitySend.disabled = true;
          dmInput.disabled = true;
          dmSend.disabled = true;
          dmHint.style.display = '';
          profileBadge.style.display = 'none';
        }
      }

      // Reply functionality
      function setReplyTo(messageData, isForDM = false) {
        replyingTo = messageData;
        const bar = isForDM ? dmReplyBar : replyBar;
        const preview = isForDM ? dmReplyPreview : replyPreview;
        
        bar.classList.add('active');
        preview.textContent = `Replying to ${messageData.displayName || 'Unknown'}: ${messageData.text.substring(0, 50)}${messageData.text.length > 50 ? '...' : ''}`;
      }

      function clearReply(isForDM = false) {
        replyingTo = null;
        const bar = isForDM ? dmReplyBar : replyBar;
        bar.classList.remove('active');
      }

      // Edit functionality
      function startEdit(messageId, currentText, messageElement) {
        if (editingMessage) return; // Only one edit at a time
        
        editingMessage = { id: messageId, element: messageElement, originalText: currentText };
        
        const textEl = messageElement.querySelector('.text');
        const editInput = el('input', { 
          class: 'editing-input', 
          value: currentText,
          maxlength: '1000'
        });
        
        const saveBtn = el('button', { 
          class: 'btn-primary',
          onclick: () => saveEdit(messageId, editInput.value, messageElement)
        }, [document.createTextNode('Save')]);
        
        const cancelBtn = el('button', { 
          class: 'btn-ghost',
          onclick: () => cancelEdit(messageElement, currentText)
        }, [document.createTextNode('Cancel')]);
        
        const editActions = el('div', { class: 'edit-actions' }, [saveBtn, cancelBtn]);
        
        textEl.innerHTML = '';
        textEl.appendChild(editInput);
        textEl.appendChild(editActions);
        
        editInput.focus();
        editInput.select();
      }

      async function saveEdit(messageId, newText, messageElement) {
        if (!newText.trim()) return;
        
        try {
          await updateDoc(doc(db, 'messages', messageId), {
            text: newText.trim(),
            edited: true,
            editedAt: serverTimestamp()
          });
          
          cancelEdit(messageElement, newText);
        } catch (error) {
          console.error('Error editing message:', error);
          alert('Failed to edit message');
        }
      }

      function cancelEdit(messageElement, text) {
        const textEl = messageElement.querySelector('.text');
        textEl.innerHTML = '';
        textEl.appendChild(document.createTextNode(text));
        editingMessage = null;
      }

      // Delete functionality
      async function deleteMessage(messageId, messageElement) {
        if (!confirm('Delete this message?')) return;
        
        try {
          await deleteDoc(doc(db, 'messages', messageId));
          messageElement.remove();
        } catch (error) {
          console.error('Error deleting message:', error);
          alert('Failed to delete message');
        }
      }

      // Auto-delete messages after 48 hours
      async function cleanupOldMessages() {
        try {
          const twoDaysAgo = new Date();
          twoDaysAgo.setHours(twoDaysAgo.getHours() - 48);
          
          const oldMessagesQuery = query(
            collection(db, 'messages'),
            where('createdAt', '<', Timestamp.fromDate(twoDaysAgo))
          );
          
          const snapshot = await getDocs(oldMessagesQuery);
          const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
          await Promise.all(deletePromises);
          
          console.log(`Cleaned up ${snapshot.size} old messages`);
        } catch (error) {
          console.error('Error cleaning up old messages:', error);
        }
      }

      // Run cleanup every hour
      setInterval(cleanupOldMessages, 60 * 60 * 1000);

      // Event listeners
      tabs.community.addEventListener('click', () => switchTab('community'));
      tabs.dm.addEventListener('click', () => switchTab('dm'));
      signOutBtn.addEventListener('click', signOutUser);

      replyClose.addEventListener('click', () => clearReply(false));
      dmReplyClose.addEventListener('click', () => clearReply(true));

      // Community form
      communityForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = communityInput.value.trim();
        if (!currentUser) {
          redirectToLogin();
          return;
        }
        if (!text) return;
        if (text.length > 1000) return;
        
        try {
          const messageData = {
            text,
            uid: currentUser.uid,
            userId: currentUser.uid,
            displayName: displayNameFromProfile(currentProfile, currentUser.email),
            createdAt: serverTimestamp(),
          };
          
          if (replyingTo) {
            messageData.replyTo = {
              id: replyingTo.id,
              text: replyingTo.text,
              displayName: replyingTo.displayName
            };
          }
          
          await addDoc(collection(db, 'messages'), messageData);
          communityInput.value = '';
          clearReply(false);
        } catch (e) {
          alert('Failed to send message.');
        }
      });

      // DM form
      dmForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) { redirectToLogin(); return; }
        if (!selectedPeer) return;
        const text = dmInput.value.trim();
        if (!text) return;
        
        try {
          const ref = await ensureThread(selectedPeer.id);
          const messageData = {
            text,
            senderUid: currentUser.uid,
            createdAt: serverTimestamp(),
          };
          
          if (replyingTo) {
            messageData.replyTo = {
              text: replyingTo.text,
              senderUid: replyingTo.senderUid
            };
          }
          
          await addDoc(collection(ref, 'messages'), messageData);
          dmInput.value = '';
          clearReply(true);
        } catch (e) {
          alert('Failed to send DM.');
        }
      });

      // Initialize auth
      initAuth({
        onAuthStateChanged: (user, profile) => {
          currentUser = user;
          currentProfile = profile;
          setAuthUI();
          setupCommunityListener();
          refreshUsersList();
          clearDm();
          loadRecentConversations();
        }
      });

      // Community chat
      function setupCommunityListener() {
        if (communityUnsub) communityUnsub();
        communityMessagesEl.innerHTML = '';
        const qy = query(collection(db, 'messages'), orderBy('createdAt', 'asc'), limit(200));
        communityUnsub = onSnapshot(qy, (snap) => {
          communityMessagesEl.setAttribute('aria-busy', 'true');
          communityMessagesEl.innerHTML = '';
          snap.forEach((docSnap) => {
            const m = { id: docSnap.id, ...docSnap.data() };
            const isMe = currentUser && m.uid === currentUser.uid;
            const who = m.displayName || 'Anonymous';
            
            const msgEl = el('div', { class: 'msg' + (isMe ? ' me' : '') });
            
            // Reply indicator
            if (m.replyTo) {
              const replyEl = el('div', { class: 'reply-indicator' }, [
                document.createTextNode(`↳ ${m.replyTo.displayName}: ${m.replyTo.text.substring(0, 30)}${m.replyTo.text.length > 30 ? '...' : ''}`)
              ]);
              msgEl.appendChild(replyEl);
            }
            
            const textEl = el('div', { class: 'text' }, [
              document.createTextNode(m.text || '')
            ]);
            
            if (m.edited) {
              textEl.appendChild(el('span', { style: 'color: var(--soft); font-size: 10px; margin-left: 8px;' }, [
                document.createTextNode('(edited)')
              ]));
            }
            
            const metaEl = el('div', { class: 'meta' }, [
              el('span', { class: 'username', onclick: () => openProfileModal(m.userId) }, [document.createTextNode(who)]),
              document.createTextNode(' • ' + (formatTime(m.createdAt) || ''))
            ]);
            
            msgEl.appendChild(textEl);
            msgEl.appendChild(metaEl);
            
            // Message actions for own messages
            if (isMe) {
              const actionsEl = el('div', { class: 'msg-actions' }, [
                el('button', { 
                  class: 'msg-action-btn',
                  onclick: () => startEdit(m.id, m.text, msgEl)
                }, [document.createTextNode('Edit')]),
                el('button', { 
                  class: 'msg-action-btn btn-danger',
                  onclick: () => deleteMessage(m.id, msgEl)
                }, [document.createTextNode('Delete')])
              ]);
              msgEl.appendChild(actionsEl);
            }
            
            // Reply action for all messages
            if (currentUser) {
              const replyBtn = el('button', { 
                class: 'msg-action-btn',
                onclick: () => setReplyTo(m, false)
              }, [document.createTextNode('Reply')]);
              
              if (msgEl.querySelector('.msg-actions')) {
                msgEl.querySelector('.msg-actions').appendChild(replyBtn);
              } else {
                const actionsEl = el('div', { class: 'msg-actions' }, [replyBtn]);
                msgEl.appendChild(actionsEl);
              }
            }
            
            communityMessagesEl.appendChild(msgEl);
          });
          communityMessagesEl.setAttribute('aria-busy', 'false');
          communityMessagesEl.scrollTop = communityMessagesEl.scrollHeight;
        }, (err) => {
          console.error(err);
        });
      }

      // Users list for DMs
      async function refreshUsersList() {
        try {
          const qy = query(collection(db, 'profiles'), limit(100));
          const snap = await getDocs(qy);
          allProfiles = [];
          snap.forEach((docSnap) => {
            const p = { id: docSnap.id, ...docSnap.data() };
            allProfiles.push(p);
          });
          renderUsersList();
        } catch (e) {
          console.error(e);
        }
      }

      function renderUsersList() {
        const queryStr = (searchUsers.value || '').toLowerCase();
        usersList.innerHTML = '';
        const filtered = allProfiles.filter((p) => {
          if (currentUser && p.id === currentUser.uid) return false;
          const hay = [p.name, p.college, p.semester, p.instagram, p.github, p.linkedin]
            .filter(Boolean).join(' ').toLowerCase();
          return hay.includes(queryStr);
        });
        communityCount.textContent = filtered.length + ' online';
        for (const p of filtered) {
          const right = el('div', {}, [
            el('button', { class: 'btn-ghost', onclick: () => openDmWith(p) }, [document.createTextNode('Message')]),
          ]);
          const left = el('div', {}, [
            el('div', { class: 'title' }, [document.createTextNode(p.name || 'Unknown')]),
            el('div', { class: 'sub' }, [document.createTextNode((p.college || '') + (p.semester ? ' · Sem ' + p.semester : ''))])
          ]);
          const row = el('div', { class: 'list-item' }, [left, right]);
          usersList.appendChild(row);
        }
      }
      searchUsers.addEventListener('input', renderUsersList);

      async function ensureThread(peerUid) {
        if (!currentUser) return null;
        const id = threadIdFor(currentUser.uid, peerUid);
        const ref = doc(db, 'dmThreads', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(ref, { users: [currentUser.uid, peerUid], createdAt: serverTimestamp() }, { merge: true });
        }
        return ref;
      }

      function clearDm() {
        if (dmUnsub) dmUnsub();
        dmMessagesEl.innerHTML = '';
        dmHeader.innerHTML = '';
        dmHeader.append(el('strong', {}, [document.createTextNode('No conversation')]));
        dmHeader.append(el('span', { class: 'pill' }, [document.createTextNode('Select a person')]));
      }

      async function openDmWith(peerProfile) {
        if (!currentUser) {
          redirectToLogin();
          return;
        }
        selectedPeer = peerProfile;
        dmHeader.innerHTML = '';
        dmHeader.append(el('strong', {}, [document.createTextNode(peerProfile.name || 'Unknown')]));
        dmHeader.append(el('span', { class: 'pill' }, [document.createTextNode(peerProfile.college || '')]));
        if (dmUnsub) dmUnsub();
        const ref = await ensureThread(peerProfile.id);
        const msgsRef = collection(ref, 'messages');
        dmUnsub = onSnapshot(query(msgsRef, orderBy('createdAt', 'asc'), limit(500)), (snap) => {
          dmMessagesEl.innerHTML = '';
          snap.forEach((d) => {
            const m = { id: d.id, ...d.data() };
            const isMe = currentUser && m.senderUid === currentUser.uid;
            const who = isMe ? 'You' : (peerProfile.name || 'Them');
            
            const msgEl = el('div', { class: 'msg' + (isMe ? ' me' : '') });
            
            // Reply indicator for DMs
            if (m.replyTo) {
              const replyEl = el('div', { class: 'reply-indicator' }, [
                document.createTextNode(`↳ ${m.replyTo.senderUid === currentUser.uid ? 'You' : peerProfile.name}: ${m.replyTo.text.substring(0, 30)}${m.replyTo.text.length > 30 ? '...' : ''}`)
              ]);
              msgEl.appendChild(replyEl);
            }
            
            const textEl = el('div', { class: 'text' }, [document.createTextNode(m.text || '')]);
            const metaEl = el('div', { class: 'meta' }, [document.createTextNode(who + ' • ' + (formatTime(m.createdAt) || ''))]);
            
            msgEl.appendChild(textEl);
            msgEl.appendChild(metaEl);
            
            // Reply action for DMs
            if (currentUser) {
              const replyBtn = el('button', { 
                class: 'msg-action-btn',
                onclick: () => setReplyTo(m, true)
              }, [document.createTextNode('Reply')]);
              
              const actionsEl = el('div', { class: 'msg-actions' }, [replyBtn]);
              msgEl.appendChild(actionsEl);
            }
            
            dmMessagesEl.appendChild(msgEl);
          });
          dmMessagesEl.scrollTop = dmMessagesEl.scrollHeight;
        });
      }

      // Profile Modal
      async function loadProfile(uid) {
        if (profileCache.has(uid)) {
          return profileCache.get(uid);
        }
        try {
          const profileRef = doc(db, 'profiles', uid);
          const profileSnap = await getDoc(profileRef);
          if (profileSnap.exists()) {
            const profileData = { id: profileSnap.id, ...profileSnap.data() };
            profileCache.set(uid, profileData);
            return profileData;
          } else {
            console.error('Profile not found');
            return null;
          }
        } catch (error) {
          console.error('Error loading profile:', error);
          return null;
        }
      }

      const profileModal = document.getElementById('profile-modal');
      const profileModalTitle = document.getElementById('profile-modal-title');
      const profileAvatar = document.getElementById('profile-avatar');
      const profileInfo = document.getElementById('profile-info');

      async function openProfileModal(uid) {
        try {
          const profile = await loadProfile(uid);
          if (!profile) {
            alert('Could not load profile.');
            return;
          }

          profileModalTitle.textContent = profile.name || 'User Profile';
          profileAvatar.textContent = profile.name ? profile.name[0].toUpperCase() : '?';

          profileInfo.innerHTML = '';
          profileInfo.append(
            el('div', { class: 'profile-field' }, [
              el('span', { class: 'label' }, [document.createTextNode('College')]),
              el('span', { class: 'value' }, [document.createTextNode(profile.college || 'N/A')])
            ]),
            el('div', { class: 'profile-field' }, [
              el('span', { class: 'label' }, [document.createTextNode('Semester')]),
              el('span', { class: 'value' }, [document.createTextNode(profile.semester || 'N/A')])
            ])
          );

          const links = el('div', { class: 'profile-links' });
          if (profile.instagram) {
            links.append(el('a', { class: 'profile-link', href: `https://instagram.com/${profile.instagram}`, target: '_blank' }, [document.createTextNode('Instagram')]));
          }
          if (profile.github) {
            links.append(el('a', { class: 'profile-link', href: profile.github, target: '_blank' }, [document.createTextNode('GitHub')]));
          }
          if (profile.linkedin) {
            links.append(el('a', { class: 'profile-link', href: profile.linkedin, target: '_blank' }, [document.createTextNode('LinkedIn')]));
          }
          profileInfo.append(links);

          profileModal.showModal();
        } catch (error) {
          console.error('Error opening profile modal:', error);
          alert('Failed to open profile.');
        }
      }

      async function loadRecentConversations() {
        if (!currentUser) return;

        recentConversationsEl.innerHTML = '';

        const threadsQuery = query(
          collection(db, 'dmThreads'),
          where('users', 'array-contains', currentUser.uid),
          limit(5)
        );

        const threadsSnap = await getDocs(threadsQuery);

        threadsSnap.forEach(async (threadDoc) => {
          const threadData = threadDoc.data();
          const peerUid = threadData.users.find(uid => uid !== currentUser.uid);

          if (!peerUid) return;

          const peerProfile = await loadProfile(peerUid);
          if (!peerProfile) return;

          const conversationItem = el(
            'div',
            { class: 'list-item', onclick: () => openDmWith(peerProfile) },
            [
              el('div', { class: 'title' }, [document.createTextNode(peerProfile.name || 'Unknown')]),
              el('div', { class: 'sub' }, [document.createTextNode(peerProfile.college || '')])
            ]
          );
          recentConversationsEl.appendChild(conversationItem);
        });
      }

      // Run initial cleanup
      setTimeout(cleanupOldMessages, 5000);
    </script>
  </body>
</html>
