<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Programming for Losers — Chat</title>
    <meta name="color-scheme" content="dark light" />
    
    <!-- Added for new navigation -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Styles for the new navigation bar -->
    <style>
        @keyframes shine { 0% { transform: translateX(-100%); } 50% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-12px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(8px); } }
        @keyframes glow { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.03); } }
        @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.2); } }
        
        .anime-nav { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .glow-effect { animation: glow 2s ease-in-out infinite; }
        .shine-effect { animation: shine 3s ease-in-out infinite; }
        .float-animation { animation: float 2s ease-in-out infinite; }
        .bounce-animation { animation: bounce 1s ease-in-out infinite 0.5s; }
        .blink-animation { animation: blink 3s ease-in-out infinite; }
        
        .mascot-container { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-item { transition: all 0.3s ease; }
        .nav-item:hover { transform: scale(1.05); }
    </style>

    <!-- Original CSS from chat.html -->
    <style>
      :root {
  color-scheme: dark;
  --bg: #0f0f10;
  --elev: #151517;
  --elev-2: #1b1b1e;
  --muted: #d9d9db;
  --soft: #a9a9ad;
  --line: #2a2a2e;
  --accent: #ffffff;
  --ok: #43d17a;
  --warn: #e7c74f;
  --danger: #ff5d5d;
  --primary: #4f46e5;
  --primary-hover: #4338ca;
}
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
        background: var(--bg);
        color: var(--muted);
        display: flex;
        flex-direction: column;
      }
      
      /* Buttons */
      .btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-hover));
  color: white;
  box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

.btn-outline {
  background: transparent;
  color: var(--muted);
  border: 1px solid var(--line);
}

.btn-outline:hover {
  background: var(--elev);
  border-color: var(--primary);
  color: var(--accent);
  transform: translateY(-1px);
}

@media (max-width: 768px) {
  .btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
}
      
      /* Main Content - Adjusted for new nav */
      main {
        flex: 1;
        padding: 1rem;
        padding-top: 120px; /* Added space for the fixed nav bar */
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      
      /* Tabs */
      .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--line);
        padding-bottom: 0.5rem;
      }
      .tab {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: 1px solid var(--line);
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        color: var(--soft);
        cursor: pointer;
        transition: all 0.2s;
      }
      .tab.active {
        background: var(--elev-2);
        color: var(--accent);
        border-color: var(--line);
      }
      
      @media (max-width: 768px) {
        .tab {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
        }
      }
      
      /* Chat Panel */
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--elev-2);
        border: 1px solid var(--line);
        border-radius: 12px;
        overflow: hidden;
        min-height: 500px;
      }
      .chat-header {
        padding: 1rem;
        border-bottom: 1px solid var(--line);
        background: var(--elev);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .chat-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        max-height: 400px;
      }
      .chat-footer {
        padding: 1rem;
        border-top: 1px solid var(--line);
        background: var(--elev);
      }
      .chat-form {
        display: flex;
        gap: 0.5rem;
      }
      .chat-input {
        flex: 1;
        padding: 0.75rem;
        background: var(--bg);
        border: 1px solid var(--line);
        border-radius: 8px;
        color: var(--muted);
        outline: none;
      }
      .chat-input:focus {
        border-color: var(--accent);
      }
      .chat-input::placeholder {
        color: var(--soft);
      }
      
      /* Messages */
      .msg {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: var(--bg);
        border: 1px solid var(--line);
        border-radius: 8px;
        position: relative;
      }
      .msg.me {
        background: var(--elev);
        border-color: var(--accent);
      }
      .msg .meta {
        font-size: 0.8rem;
        color: var(--soft);
        margin-bottom: 0.25rem;
      }
      .msg .username {
        color: var(--accent);
        cursor: pointer;
        font-weight: 500;
      }
      .msg .username:hover {
        text-decoration: underline;
      }
      .msg .text {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      
      /* Message Actions */
      .msg-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: none;
        gap: 0.25rem;
      }
      .msg:hover .msg-actions {
        display: flex;
      }
      .msg-action-btn {
        background: var(--elev);
        border: 1px solid var(--line);
        color: var(--soft);
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        border-radius: 4px;
        cursor: pointer;
      }
      .msg-action-btn:hover {
        background: var(--elev-2);
        color: var(--muted);
      }
      
      /* Reply Bar */
      .reply-bar {
        background: var(--elev);
        border: 1px solid var(--line);
        padding: 0.5rem 1rem;
        display: none;
        align-items: center;
        gap: 0.5rem;
        border-radius: 8px 8px 0 0;
      }
      .reply-bar.active {
        display: flex;
      }
      .reply-preview {
        flex: 1;
        font-size: 0.8rem;
        color: var(--soft);
      }
      .reply-close {
        background: none;
        border: none;
        color: var(--soft);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
      }
      .reply-close:hover {
        background: var(--line);
      }
      
      /* Reply Indicator */
      .reply-indicator {
        background: var(--line);
        border-left: 3px solid var(--accent);
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 0 6px 6px 0;
        font-size: 0.8rem;
        color: var(--soft);
      }
      
      /* Edit Mode */
      .editing-input {
        background: var(--elev);
        border: 1px solid var(--accent);
        color: var(--muted);
        padding: 0.5rem;
        border-radius: 6px;
        width: 100%;
        margin-top: 0.5rem;
      }
      .edit-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .edit-actions button {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }
      
      /* DM Section */
      .dm-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 1rem;
        height: 500px;
      }
      @media (max-width: 768px) {
        .dm-container {
          grid-template-columns: 1fr;
          height: auto;
        }
      }
      
      .users-panel {
        background: var(--elev-2);
        border: 1px solid var(--line);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .users-header {
        padding: 1rem;
        border-bottom: 1px solid var(--line);
        background: var(--elev);
        font-weight: 600;
      }
      .users-list {
        flex: 1;
        padding: 0.5rem;
        overflow-y: auto;
      }
      .user-item {
        padding: 0.75rem;
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
      }

      .user-item.has-unread {
        border-left: 4px solid var(--danger);
        background: rgba(255, 93, 93, 0.05);
      }

      .user-item:hover {
        background: var(--elev);
      }

      .user-item.has-unread:hover {
        background: rgba(255, 93, 93, 0.1);
      }

      .user-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .unread-badge {
        background: var(--danger);
        color: white;
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        border-radius: 10px;
        font-weight: 600;
        min-width: 18px;
        text-align: center;
      }

      .last-message {
        font-size: 0.75rem;
        color: var(--soft);
        margin-top: 0.25rem;
        opacity: 0.8;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .last-message-time {
        font-size: 0.7rem;
        color: var(--soft);
        opacity: 0.6;
        margin-top: 0.15rem;
      }

      .user-item.has-unread .last-message {
        color: var(--muted);
        font-weight: 500;
      }
      .user-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
      }
      .user-info {
        font-size: 0.8rem;
        color: var(--soft);
      }
      
      /* Status Messages */
      .status-msg {
        text-align: center;
        padding: 2rem;
        color: var(--soft);
        font-style: italic;
      }
      
      /* Hidden */
      .hidden {
        display: none !important;
      }
      
      /* Profile Modal */
      dialog {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: var(--elev-2);
        color: var(--muted);
        padding: 0;
        max-width: 400px;
        width: calc(100% - 2rem);
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.8);
      }
      .modal-header {
        padding: 1rem;
        border-bottom: 1px solid var(--line);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
      }
      .modal-body {
        padding: 1rem;
      }
      .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--elev);
        border: 2px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
        color: var(--accent);
        margin: 0 auto 1rem;
      }
      .profile-info {
        display: grid;
        gap: 0.75rem;
      }
      .profile-field {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--line);
      }
      .profile-field:last-child {
        border-bottom: none;
      }
      .profile-field .label {
        color: var(--soft);
        font-size: 0.9rem;
      }
      .profile-field .value {
        color: var(--muted);
        font-weight: 500;
      }
      .profile-links {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      .profile-link {
        padding: 0.5rem 1rem;
        border: 1px solid var(--line);
        border-radius: 20px;
        color: var(--muted);
        text-decoration: none;
        font-size: 0.8rem;
        transition: all 0.2s;
      }
      .profile-link:hover {
        background: var(--elev);
        text-decoration: none;
      }

/* Mobile DM Modal */
.dm-modal {
  border: 1px solid var(--line);
  border-radius: 12px;
  background: var(--elev-2);
  color: var(--muted);
  padding: 0;
  max-width: 100%;
  width: 100%;
  height: 100%;
  max-height: 100vh;
  margin: 0;
}

@media (min-width: 769px) {
  .dm-modal {
    max-width: 500px;
    width: calc(100% - 2rem);
    height: auto;
    max-height: 80vh;
    margin: auto;
  }
}

.dm-modal::backdrop {
  background: rgba(0, 0, 0, 0.9);
}

.dm-modal-header {
  padding: 1rem;
  border-bottom: 1px solid var(--line);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  background: var(--elev);
}

.dm-modal-body {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 120px);
}

@media (min-width: 769px) {
  .dm-modal-body {
    height: 400px;
  }
}

.dm-modal-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  background: var(--bg);
}

.dm-modal-footer {
  padding: 1rem;
  border-top: 1px solid var(--line);
  background: var(--elev);
}

.dm-modal-form {
  display: flex;
  gap: 0.5rem;
}

.dm-modal-input {
  flex: 1;
  padding: 0.75rem;
  background: var(--bg);
  border: 1px solid var(--line);
  border-radius: 8px;
  color: var(--muted);
  outline: none;
}

.dm-modal-input:focus {
  border-color: var(--accent);
}

.dm-modal-input::placeholder {
  color: var(--soft);
}

/* Hide desktop DM on mobile */
@media (max-width: 768px) {
  .dm-container {
    display: none;
  }
  
  .mobile-dm-hint {
    text-align: center;
    padding: 2rem;
    color: var(--soft);
  }
}

@media (min-width: 769px) {
  .mobile-dm-hint {
    display: none;
  }
}
    </style>
  </head>
  <body class="bg-black">
    
    <!-- NEW: Fixed Anime Navigation Bar -->
    <div class="fixed top-5 left-0 right-0 z-50">
      <div class="flex justify-center pt-6">
          <div class="anime-nav flex items-center gap-3 bg-gray-900/80 border border-gray-700/50 py-2 px-2 rounded-full shadow-2xl relative">
              
              <!-- Home -->
              <a href="index.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="Home">
                  <span class="hidden md:inline relative">Home</span>
                  <svg class="md:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                  </svg>
              </a>
              
              
              <!-- Chat -->
              <a href="chat.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-white active-tab" data-tab="Chat">
                  <span class="hidden md:inline relative">Chat</span>
                  <svg class="md:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
              </a>
              
              
              <a href="assignment.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="Assignments">
                  <span class="hidden md:inline relative">Assignments</span>
                  <svg class="md:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
              </a>
              
              <!-- Profile -->
              <a href="profile.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="Profile">
                  <span class="hidden md:inline relative">Profile</span>
                  <svg class="md:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
              </a>

              <!-- PYQ's -->
              <a href="pyqs.html" class="nav-item relative cursor-pointer text-sm font-semibold px-6 py-3 rounded-full text-gray-400 hover:text-white" data-tab="PYQs">
                  <span class="hidden md:inline relative">PYQ's</span>
                  <svg class="md:hidden relative w-5 h-5 mobile-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
              </a>
  
   <!-- Active Tab Glow Effect -->
              <div class="glow-container absolute inset-0 rounded-full -z-10 overflow-hidden opacity-0">
                  <div class="absolute inset-0 bg-white/20 rounded-full blur-md glow-effect"></div>
                  <div class="absolute inset-[-4px] bg-white/15 rounded-full blur-xl glow-effect"></div>
                  <div class="absolute inset-[-8px] bg-white/10 rounded-full blur-2xl glow-effect"></div>
                  <div class="absolute inset-[-12px] bg-white/5 rounded-full blur-3xl glow-effect"></div>
                  <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/15 to-white/0 shine-effect"></div>
              </div>
              
              <!-- Hover Effect -->
              <div class="hover-effect absolute inset-0 bg-white/5 rounded-full -z-10 opacity-0 transition-opacity duration-300"></div>
          </div>
      </div>
  </div>
  
  <!-- Anime Mascot -->
  <div class="mascot-container fixed top-0 left-1/2 transform -translate-x-1/2 pointer-events-none z-[60] opacity-0" style="top: 35px;">
      <div class="relative w-12 h-12">
          <!-- Main Head -->
          <div class="mascot-head absolute w-10 h-10 bg-white rounded-full left-1/2 transform -translate-x-1/2 float-animation shadow-lg">
              <!-- Left Eye -->
              <div class="mascot-eye-left absolute transition-all duration-300" style="left: 20%; top: 35%;">
                  <div class="w-3 h-3 bg-black rounded-full relative blink-animation">
                      <!-- Eye shine -->
                      <div class="absolute w-1 h-1 bg-white rounded-full" style="top: 20%; right: 20%;"></div>
                      <div class="absolute w-0.5 h-0.5 bg-white rounded-full" style="bottom: 30%; left: 30%;"></div>
                  </div>
              </div>
              
              <!-- Right Eye -->
              <div class="mascot-eye-right absolute transition-all duration-300" style="right: 20%; top: 35%;">
                  <div class="w-3 h-3 bg-black rounded-full relative blink-animation">
                      <!-- Eye shine -->
                      <div class="absolute w-1 h-1 bg-white rounded-full" style="top: 20%; left: 20%;"></div>
                      <div class="absolute w-0.5 h-0.5 bg-white rounded-full" style="bottom: 30%; right: 30%;"></div>
                  </div>
              </div>
              
              <!-- Mouth -->
              <div class="mascot-mouth absolute left-1/2 transform -translate-x-1/2 transition-all duration-300 opacity-0" style="top: 60%;">
                  <div class="w-4 h-2 border-2 border-black border-t-0 rounded-b-full"></div>
              </div>
              
              <!-- Sparkles -->
              <div class="sparkle-1 absolute -top-1 -right-1 w-2 h-2 text-yellow-300 opacity-0 transition-all duration-300">✨</div>
              <div class="sparkle-2 absolute -top-2 left-0 w-2 h-2 text-yellow-300 opacity-0 transition-all duration-300">✨</div>
              <div class="sparkle-3 absolute -bottom-1 -left-1 w-2 h-2 text-blue-300 opacity-0 transition-all duration-300">💫</div>
          </div>
          
          <!-- Speech Bubble Tail -->
          <div class="absolute -bottom-1 left-1/2 w-4 h-4 transform -translate-x-1/2 bounce-animation">
              <div class="w-full h-full bg-white rotate-45 transform origin-center shadow-lg"></div>
          </div>
      </div>
  </div>


    <main>
      <div class="tabs">
        <button class="tab active" id="tab-community">Community Chat</button>
        <button class="tab" id="tab-dm">Direct Messages</button>
      </div>

      <!-- Community Chat -->
      <section id="panel-community">
        <div class="chat-container">
          <div class="chat-header">
            <div>
              <strong>Community Chat</strong>
              <span style="color: var(--soft); font-size: 0.9rem; margin-left: 0.5rem;" id="community-count">0 online</span>
            </div>
            <div id="send-hint" style="font-size: 0.8rem; color: var(--soft);">
              Sign in to send messages
            </div>
          </div>
          <div class="chat-messages" id="community-messages"></div>
          <div class="reply-bar" id="reply-bar">
            <div class="reply-preview" id="reply-preview"></div>
            <button class="reply-close" id="reply-close">×</button>
          </div>
          <div class="chat-footer">
            <form class="chat-form" id="community-form">
              <input class="chat-input" id="community-input" type="text" placeholder="Say something to everyone..." maxlength="1000" />
              <button class="btn" id="community-send" type="submit">Send</button>
            </form>
          </div>
        </div>
      </section>

      <!-- Direct Messages -->
      <section id="panel-dm" class="hidden">
        <!-- Desktop DM Interface -->
        <div class="dm-container">
          <div class="users-panel">
            <div class="users-header">People</div>
            <div class="users-list" id="users-list"></div>
          </div>
          
          <div class="chat-container">
            <div class="chat-header" id="dm-header">
              <strong>Select a person to chat</strong>
            </div>
            <div class="chat-messages" id="dm-messages">
              <div class="status-msg">Choose someone to start chatting</div>
            </div>
            <div class="reply-bar" id="dm-reply-bar">
              <div class="reply-preview" id="dm-reply-preview"></div>
              <button class="reply-close" id="dm-reply-close">×</button>
            </div>
            <div class="chat-footer">
              <form class="chat-form" id="dm-form">
                <input class="chat-input" id="dm-input" type="text" placeholder="Message..." maxlength="1000" />
                <button class="btn" id="dm-send" type="submit">Send</button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Mobile DM Interface -->
        <div class="mobile-dm-hint">
          <div class="users-panel">
            <div class="users-header">People</div>
            <div class="users-list" id="mobile-users-list"></div>
          </div>
          <div style="margin-top: 1rem; text-align: center; color: var(--soft); font-size: 0.9rem;" id="mobile-dm-hint">
            Sign in to use direct messages
          </div>
        </div>
      </section>
    </main>

    <!-- Profile Modal -->
    <dialog id="profile-modal">
      <form method="dialog">
        <div class="modal-header">
          <strong id="profile-modal-title">User Profile</strong>
          <button class="btn btn-outline" value="cancel">Close</button>
        </div>
        <div class="modal-body">
          <div class="profile-avatar" id="profile-avatar"></div>
          <div class="profile-info" id="profile-info"></div>
        </div>
      </form>
    </dialog>

    <!-- DM Modal for Mobile -->
    <dialog id="dm-modal" class="dm-modal">
      <div class="dm-modal-header">
        <strong id="dm-modal-title">Chat</strong>
        <button class="btn btn-outline" id="dm-modal-close">Close</button>
      </div>
      <div class="dm-modal-body">
        <div class="dm-modal-messages" id="dm-modal-messages">
          <div class="status-msg">Start your conversation</div>
        </div>
        <div class="reply-bar" id="dm-modal-reply-bar">
          <div class="reply-preview" id="dm-modal-reply-preview"></div>
          <button class="reply-close" id="dm-modal-reply-close">×</button>
        </div>
      </div>
      <div class="dm-modal-footer">
        <form class="dm-modal-form" id="dm-modal-form">
          <input class="dm-modal-input" id="dm-modal-input" type="text" placeholder="Type a message..." maxlength="1000" />
          <button class="btn" id="dm-modal-send" type="submit">Send</button>
        </form>
      </div>
    </dialog>

    <!-- Navigation Bar JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mascotContainer = document.querySelector('.mascot-container');
            const glowContainer = document.querySelector('.glow-container');
            const hoverEffect = document.querySelector('.hover-effect');
            const activeTabName = 'Chat';

            function updateActiveElementPosition() {
                const activeItem = document.querySelector(`[data-tab="${activeTabName}"]`);
                if (activeItem) {
                    const rect = activeItem.getBoundingClientRect();
                    const containerRect = activeItem.closest('.anime-nav').getBoundingClientRect();
                    mascotContainer.style.left = `${rect.left + rect.width / 2}px`;
                    mascotContainer.style.opacity = '1';
                    glowContainer.style.left = `${rect.left - containerRect.left}px`;
                    glowContainer.style.width = `${rect.width}px`;
                    glowContainer.style.opacity = '1';
                }
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    if (this.dataset.tab !== activeTabName) {
                        const rect = this.getBoundingClientRect();
                        const containerRect = this.closest('.anime-nav').getBoundingClientRect();
                        hoverEffect.style.left = `${rect.left - containerRect.left}px`;
                        hoverEffect.style.width = `${rect.width}px`;
                        hoverEffect.style.opacity = '1';
                    }
                });
                item.addEventListener('mouseleave', () => { hoverEffect.style.opacity = '0'; });
            });

            window.addEventListener('resize', updateActiveElementPosition);
            setTimeout(updateActiveElementPosition, 100);
        });
    </script>
    
    <!-- Original Chat Logic Script -->
    <script type="module">
      // First, let's add comprehensive error handling and logging
      console.log('🚀 Starting chat application...');

      // Import Firebase modules with error handling
      let auth, db, initAuth, signOutUser, redirectToLogin, requireAuth;
      
      try {
        const authModule = await import('./js/auth.js');
        auth = authModule.auth;
        db = authModule.db;
        initAuth = authModule.initAuth;
        signOutUser = authModule.signOutUser;
        redirectToLogin = authModule.redirectToLogin;
        requireAuth = authModule.requireAuth;
        console.log('✅ Auth module loaded successfully');
      } catch (error) {
        console.error('❌ Failed to load auth module:', error);
        alert('Failed to load authentication. Please refresh the page.');
      }

      // Import Firestore functions with error handling
      let collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where,
          doc, setDoc, getDoc, getDocs, limit, updateDoc, deleteDoc, Timestamp;
      
      try {
        const firestoreModule = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
        collection = firestoreModule.collection;
        addDoc = firestoreModule.addDoc;
        onSnapshot = firestoreModule.onSnapshot;
        query = firestoreModule.query;
        orderBy = firestoreModule.orderBy;
        serverTimestamp = firestoreModule.serverTimestamp;
        where = firestoreModule.where;
        doc = firestoreModule.doc;
        setDoc = firestoreModule.setDoc;
        getDoc = firestoreModule.getDoc;
        getDocs = firestoreModule.getDocs;
        limit = firestoreModule.limit;
        updateDoc = firestoreModule.updateDoc;
        deleteDoc = firestoreModule.deleteDoc;
        Timestamp = firestoreModule.Timestamp;
        console.log('✅ Firestore module loaded successfully');
      } catch (error) {
        console.error('❌ Failed to load Firestore module:', error);
        alert('Failed to load database functions. Please refresh the page.');
      }

      // UI elements
      const tabs = {
        community: document.getElementById('tab-community'),
        dm: document.getElementById('tab-dm'),
      };
      const panels = {
        community: document.getElementById('panel-community'),
        dm: document.getElementById('panel-dm'),
      };
      // Note: The new nav doesn't have these IDs, so they won't be used.
      // const authStateEl = document.getElementById('auth-state');
      // const loginLink = document.getElementById('login-link');
      // const signOutBtn = document.getElementById('sign-out');

      // Community chat elements
      const communityMessagesEl = document.getElementById('community-messages');
      const communityForm = document.getElementById('community-form');
      const communityInput = document.getElementById('community-input');
      const communitySend = document.getElementById('community-send');
      const sendHint = document.getElementById('send-hint');
      const replyBar = document.getElementById('reply-bar');
      const replyPreview = document.getElementById('reply-preview');
      const replyClose = document.getElementById('reply-close');

      // DM elements
      const usersList = document.getElementById('users-list');
      const dmMessagesEl = document.getElementById('dm-messages');
      const dmForm = document.getElementById('dm-form');
      const dmInput = document.getElementById('dm-input');
      const dmSend = document.getElementById('dm-send');
      const dmHeader = document.getElementById('dm-header');
      const dmReplyBar = document.getElementById('dm-reply-bar');
      const dmReplyPreview = document.getElementById('dm-reply-preview');
      const dmReplyClose = document.getElementById('dm-reply-close');

      const communityCount = document.getElementById('community-count');

      // Mobile DM elements
      const mobileUsersList = document.getElementById('mobile-users-list');
      const mobileDmHint = document.getElementById('mobile-dm-hint');
      const dmModal = document.getElementById('dm-modal');
      const dmModalTitle = document.getElementById('dm-modal-title');
      const dmModalMessages = document.getElementById('dm-modal-messages');
      const dmModalForm = document.getElementById('dm-modal-form');
      const dmModalInput = document.getElementById('dm-modal-input');
      const dmModalSend = document.getElementById('dm-modal-send');
      const dmModalClose = document.getElementById('dm-modal-close');
      const dmModalReplyBar = document.getElementById('dm-modal-reply-bar');
      const dmModalReplyPreview = document.getElementById('dm-modal-reply-preview');
      const dmModalReplyClose = document.getElementById('dm-modal-reply-close');

      let dmModalUnsub = null;
      let currentModalPeer = null;

      // State
      let currentUser = null;
      let currentProfile = null;
      let communityUnsub = null;
      let dmUnsub = null;
      let selectedPeer = null;
      let allProfiles = [];
      const profileCache = new Map();
      let replyingTo = null;
      let editingMessage = null;

      // New state for conversation tracking
      let conversationData = new Map(); // userId -> { lastMessage, lastMessageTime, unreadCount, lastSeen }
      let conversationListeners = new Map(); // userId -> unsubscribe function

      // Utility functions
      function el(tag, attrs = {}, children = []) {
        const e = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === 'class') e.className = v;
          else if (k.startsWith('on') && typeof v === 'function') e.addEventListener(k.slice(2), v);
          else if (v !== null && v !== undefined) e.setAttribute(k, v);
        }
        for (const c of children) e.append(c);
        return e;
      }

      function formatTime(ts) {
        try {
          if (!ts) return '';
          const d = ts.toDate ? ts.toDate() : new Date(ts);
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } catch { return ''; }
      }

      function formatRelativeTime(ts) {
        try {
          if (!ts) return '';
          const d = ts.toDate ? ts.toDate() : new Date(ts);
          const now = new Date();
          const diffMs = now - d;
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

          if (diffMins < 1) return 'now';
          if (diffMins < 60) return `${diffMins}m`;
          if (diffHours < 24) return `${diffHours}h`;
          if (diffDays < 7) return `${diffDays}d`;
          return d.toLocaleDateString();
        } catch { return ''; }
      }

      function threadIdFor(a, b) {
        return [a, b].sort().join('_');
      }

      function displayNameFromProfile(profile, fallbackEmail) {
        return (profile && profile.name) || (fallbackEmail || 'Unknown');
      }

      function switchTab(which) {
        const isCommunity = which === 'community';
        tabs.community.classList.toggle('active', isCommunity);
        tabs.dm.classList.toggle('active', !isCommunity);
        panels.community.classList.toggle('hidden', !isCommunity);
        panels.dm.classList.toggle('hidden', isCommunity);
      }

      function setAuthUI() {
        console.log('🔄 Setting auth UI, currentUser:', !!currentUser, 'currentProfile:', !!currentProfile);
        
        // This function is kept, but the elements it tries to update
        // no longer exist in the new navigation. It will fail gracefully.
        const userAvatar = document.getElementById('user-avatar');
        const authState = document.getElementById('auth-state');
        const loginLink = document.getElementById('login-link');
        const signOutBtn = document.getElementById('sign-out');

        if (currentUser) {
            const displayName = displayNameFromProfile(currentProfile, currentUser.email);
            const avatar = currentProfile?.name ? currentProfile.name[0].toUpperCase() : currentUser.email[0].toUpperCase();
            
            if (userAvatar) userAvatar.textContent = avatar;
            if (authState) authState.textContent = displayName;
            if (loginLink) loginLink.style.display = 'none';
            if (signOutBtn) signOutBtn.style.display = 'inline-flex';
            
            sendHint.style.display = 'none';
            communityInput.disabled = false;
            communitySend.disabled = false;
            dmInput.disabled = false;
            dmSend.disabled = false;
            mobileDmHint.textContent = 'Tap on a person to start chatting';
            console.log('✅ Auth UI set for user:', displayName);
        } else {
            if (userAvatar) userAvatar.textContent = '?';
            if (authState) authState.textContent = 'Guest';
            if (loginLink) loginLink.style.display = 'inline-flex';
            if (signOutBtn) signOutBtn.style.display = 'none';
            
            sendHint.style.display = '';
            communityInput.disabled = true;
            communitySend.disabled = true;
            dmInput.disabled = true;
            dmSend.disabled = true;
            mobileDmHint.textContent = 'Sign in to use direct messages';
            console.log('🔄 Auth UI set for guest');
        }
    }


      // Reply functionality
      function setReplyTo(messageData, isForDM = false, isMobile = false) {
        replyingTo = messageData;
        let bar, preview;
        
        if (isMobile && isForDM) {
          bar = dmModalReplyBar;
          preview = dmModalReplyPreview;
        } else if (isForDM) {
          bar = dmReplyBar;
          preview = dmReplyPreview;
        } else {
          bar = replyBar;
          preview = replyPreview;
        }
        
        bar.classList.add('active');
        preview.textContent = `Replying to ${messageData.displayName || messageData.senderUid === currentUser?.uid ? 'You' : 'Unknown'}: ${messageData.text.substring(0, 50)}${messageData.text.length > 50 ? '...' : ''}`;
      }

      function clearReply(isForDM = false, isMobile = false) {
        replyingTo = null;
        let bar;
        
        if (isMobile && isForDM) {
          bar = dmModalReplyBar;
        } else if (isForDM) {
          bar = dmReplyBar;
        } else {
          bar = replyBar;
        }
        
        bar.classList.remove('active');
      }

      // Conversation tracking functions
      async function setupConversationListener(peerProfile) {
        if (!currentUser) return;
        
        const threadId = threadIdFor(currentUser.uid, peerProfile.id);
        
        // Clean up existing listener
        if (conversationListeners.has(peerProfile.id)) {
          conversationListeners.get(peerProfile.id)();
        }
        
        try {
          const threadRef = doc(db, 'dmThreads', threadId);
          const messagesRef = collection(threadRef, 'messages');
          
          const unsubscribe = onSnapshot(
            query(messagesRef, orderBy('createdAt', 'desc'), limit(1)),
            (snapshot) => {
              if (!snapshot.empty) {
                const lastMessage = snapshot.docs[0].data();
                const isFromPeer = lastMessage.senderUid === peerProfile.id;
                
                // Get current conversation data
                const currentData = conversationData.get(peerProfile.id) || {
                  unreadCount: 0,
                  lastSeen: null
                };
                
                // Update conversation data
                const newData = {
                  lastMessage: lastMessage.text,
                  lastMessageTime: lastMessage.createdAt,
                  lastSender: lastMessage.senderUid,
                  unreadCount: isFromPeer ? (currentData.unreadCount || 0) + 1 : 0,
                  lastSeen: currentData.lastSeen
                };
                
                conversationData.set(peerProfile.id, newData);
                
                // Re-render users list to update order and unread indicators
                renderUsersList();
              }
            },
            (error) => {
              console.error('Error in conversation listener:', error);
            }
          );
          
          conversationListeners.set(peerProfile.id, unsubscribe);
        } catch (error) {
          console.error('Error setting up conversation listener:', error);
        }
      }

      function markConversationAsRead(peerUserId) {
        if (!currentUser) return;
        
        const currentData = conversationData.get(peerUserId) || {};
        currentData.unreadCount = 0;
        currentData.lastSeen = new Date();
        conversationData.set(peerUserId, currentData);
        
        // Re-render to remove unread indicators
        renderUsersList();
      }

      // Community chat setup
      function setupCommunityListener() {
        console.log('🔄 Setting up community listener...');
        
        if (communityUnsub) {
          console.log('🔄 Unsubscribing from previous community listener');
          communityUnsub();
        }
        
        communityMessagesEl.innerHTML = '<div class="status-msg">Loading messages...</div>';

        try {
          const qy = query(collection(db, 'messages'), orderBy('createdAt', 'asc'), limit(200));
          console.log('📡 Starting community messages listener...');
          
          communityUnsub = onSnapshot(qy, (snap) => {
            console.log('📨 Community messages received:', snap.size, 'messages');
            communityMessagesEl.innerHTML = '';
            
            if (snap.empty) {
              communityMessagesEl.innerHTML = '<div class="status-msg">No messages yet. Be the first to say something!</div>';
              return;
            }
            
            snap.forEach((docSnap) => {
              const m = { id: docSnap.id, ...docSnap.data() };
              console.log('💬 Message:', m);
              
              const isMe = currentUser && (m.uid === currentUser.uid || m.userId === currentUser.uid);
              const who = m.displayName || 'Anonymous';
              
              const msgEl = el('div', { class: 'msg' + (isMe ? ' me' : '') });
              
              // Reply indicator
              if (m.replyTo) {
                const replyEl = el('div', { class: 'reply-indicator' }, [
                  document.createTextNode(`↳ ${m.replyTo.displayName}: ${m.replyTo.text.substring(0, 30)}${m.replyTo.text.length > 30 ? '...' : ''}`)
                ]);
                msgEl.appendChild(replyEl);
              }
              
              const metaEl = el('div', { class: 'meta' }, [
                el('span', { class: 'username', onclick: () => openProfileModal(m.userId || m.uid) }, [document.createTextNode(who)]),
                document.createTextNode(' • ' + (formatTime(m.createdAt) || ''))
              ]);
              
              const textEl = el('div', { class: 'text' }, [
                document.createTextNode(m.text || '')
              ]);
              
              if (m.edited) {
                textEl.appendChild(el('span', { style: 'color: var(--soft); font-size: 0.8rem; margin-left: 0.5rem;' }, [
                  document.createTextNode('(edited)')
                ]));
              }
              
              msgEl.appendChild(metaEl);
              msgEl.appendChild(textEl);
              
              // Message actions
              const actionsEl = el('div', { class: 'msg-actions' });
              
              if (currentUser) {
                const replyBtn = el('button', { 
                  class: 'msg-action-btn',
                  onclick: () => setReplyTo(m, false)
                }, [document.createTextNode('Reply')]);
                actionsEl.appendChild(replyBtn);
              }
              
              if (isMe) {
                const editBtn = el('button', { 
                  class: 'msg-action-btn',
                  onclick: () => startEdit(m.id, m.text, msgEl)
                }, [document.createTextNode('Edit')]);
                
                const deleteBtn = el('button', { 
                  class: 'msg-action-btn btn-danger',
                  onclick: () => deleteMessage(m.id, msgEl)
                }, [document.createTextNode('Delete')]);
                
                actionsEl.appendChild(editBtn);
                actionsEl.appendChild(deleteBtn);
              }
              
              if (actionsEl.children.length > 0) {
                msgEl.appendChild(actionsEl);
              }
              
              communityMessagesEl.appendChild(msgEl);
            });
            
            communityMessagesEl.scrollTop = communityMessagesEl.scrollHeight;
            console.log('✅ Community messages rendered');
          }, (error) => {
            console.error('❌ Community messages listener error:', error);
            communityMessagesEl.innerHTML = '<div class="status-msg">Error loading messages. Please refresh the page.</div>';
          });
          
        } catch (error) {
          console.error('❌ Failed to setup community listener:', error);
          communityMessagesEl.innerHTML = '<div class="status-msg">Failed to connect to chat. Please refresh the page.</div>';
        }
      }

      // Users list for DMs
      async function refreshUsersList() {
        console.log('🔄 Refreshing users list...');
        
        try {
          const qy = query(collection(db, 'profiles'), limit(100));
          const snap = await getDocs(qy);
          allProfiles = [];
          
          snap.forEach((docSnap) => {
            const p = { id: docSnap.id, ...docSnap.data() };
            allProfiles.push(p);
          });
          
          console.log('👥 Loaded profiles:', allProfiles.length);
          
          // Set up conversation listeners for all users
          if (currentUser) {
            allProfiles.forEach(profile => {
              if (profile.id !== currentUser.uid) {
                setupConversationListener(profile);
              }
            });
          }
          
          renderUsersList();
        } catch (error) {
          console.error('❌ Error refreshing users list:', error);
        }
      }

      function renderUsersList() {
        usersList.innerHTML = '';
        mobileUsersList.innerHTML = '';
        
        const filtered = allProfiles.filter((p) => {
          if (currentUser && p.id === currentUser.uid) return false;
          return true;
        });
        
        // Sort by recent activity (users with recent messages first)
        filtered.sort((a, b) => {
          const aData = conversationData.get(a.id);
          const bData = conversationData.get(b.id);
          
          // Users with conversations come first
          if (aData && !bData) return -1;
          if (!aData && bData) return 1;
          if (!aData && !bData) return a.name?.localeCompare(b.name || '') || 0;
          
          // Sort by last message time
          const aTime = aData.lastMessageTime?.toMillis?.() || 0;
          const bTime = bData.lastMessageTime?.toMillis?.() || 0;
          return bTime - aTime;
        });
        
        communityCount.textContent = filtered.length + ' people';
        console.log('👥 Rendering', filtered.length, 'users');
        
        for (const p of filtered) {
          const convData = conversationData.get(p.id);
          const hasUnread = convData && convData.unreadCount > 0;
          
          // Create user elements for both desktop and mobile
          [usersList, mobileUsersList].forEach(container => {
            const userEl = el('div', { 
              class: 'user-item' + (hasUnread ? ' has-unread' : ''),
              onclick: () => {
                // Mark as read when clicked
                if (hasUnread) {
                  markConversationAsRead(p.id);
                }
                
                if (container === mobileUsersList || isMobile()) {
                  openMobileDm(p);
                } else {
                  openDmWith(p);
                }
              }
            });
            
            // User name with unread badge
            const nameEl = el('div', { class: 'user-name' }, [
              document.createTextNode(p.name || 'Unknown')
            ]);
            
            if (hasUnread) {
              const badge = el('span', { class: 'unread-badge' }, [
                document.createTextNode(convData.unreadCount.toString())
              ]);
              nameEl.appendChild(badge);
            }
            
            userEl.appendChild(nameEl);
            
            // User info
            const infoEl = el('div', { class: 'user-info' }, [
              document.createTextNode((p.college || '') + (p.semester ? ' • Sem ' + p.semester : ''))
            ]);
            userEl.appendChild(infoEl);
            
            // Last message preview
            if (convData && convData.lastMessage) {
              const lastMsgEl = el('div', { class: 'last-message' }, [
                document.createTextNode(
                  (convData.lastSender === currentUser?.uid ? 'You: ' : '') + 
                  convData.lastMessage.substring(0, 40) + 
                  (convData.lastMessage.length > 40 ? '...' : '')
                )
              ]);
              userEl.appendChild(lastMsgEl);
              
              // Last message time
              const timeEl = el('div', { class: 'last-message-time' }, [
                document.createTextNode(formatRelativeTime(convData.lastMessageTime))
              ]);
              userEl.appendChild(timeEl);
            }
            
            container.appendChild(userEl);
          });
        }
      }

      function isMobile() {
        return window.innerWidth <= 768;
      }

      async function ensureThread(peerUid) {
        if (!currentUser) {
          console.error('❌ No current user for thread creation');
          return null;
        }
        
        const id = threadIdFor(currentUser.uid, peerUid);
        const ref = doc(db, 'dmThreads', id);
        
        console.log('🔄 Ensuring thread exists:', id);
        
        try {
          const snap = await getDoc(ref);
          if (!snap.exists()) {
            console.log('📝 Creating new thread:', id);
            await setDoc(ref, { 
              users: [currentUser.uid, peerUid], 
              createdAt: serverTimestamp() 
            });
            console.log('✅ Thread created successfully');
          } else {
            console.log('✅ Thread already exists');
          }
          return ref;
        } catch (error) {
          console.error('❌ Error ensuring thread:', error);
          throw error;
        }
      }

      async function openMobileDm(peerProfile) {
        if (!currentUser) {
          console.log('❌ No user signed in for mobile DM');
          redirectToLogin();
          return;
        }
        
        console.log('📱 Opening mobile DM with:', peerProfile.name);
        currentModalPeer = peerProfile;
        dmModalTitle.innerHTML = `
  <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
    <span>Chat with ${peerProfile.name || 'Unknown'}</span>
    <button class="btn btn-outline" onclick="openProfileModal('${peerProfile.id}')" style="padding: 0.2rem 0.4rem; font-size: 0.7rem; margin-left: auto;">
      Profile
    </button>
  </div>
`;
        dmModalMessages.innerHTML = '<div class="status-msg">Loading messages...</div>';
        
        // Mark conversation as read
        markConversationAsRead(peerProfile.id);
        
        try {
          if (dmModalUnsub) {
            dmModalUnsub();
            dmModalUnsub = null;
          }
          
          const ref = await ensureThread(peerProfile.id);
          console.log('📡 Setting up mobile DM listener for thread:', ref.path);
          
          const msgsRef = collection(ref, 'messages');
          
          dmModalUnsub = onSnapshot(query(msgsRef, orderBy('createdAt', 'asc'), limit(500)), (snap) => {
            console.log('📨 Mobile DM messages received:', snap.size);
            dmModalMessages.innerHTML = '';
            
            if (snap.empty) {
              dmModalMessages.innerHTML = '<div class="status-msg">Start your conversation</div>';
            } else {
              snap.forEach((d) => {
                const m = { id: d.id, ...d.data() };
                const isMe = currentUser && m.senderUid === currentUser.uid;
                const who = isMe ? 'You' : (peerProfile.name || 'Them');
                
                const msgEl = el('div', { class: 'msg' + (isMe ? ' me' : '') });
                
                if (m.replyTo) {
                  const replyEl = el('div', { class: 'reply-indicator' }, [
                    document.createTextNode(`↳ ${m.replyTo.senderUid === currentUser.uid ? 'You' : peerProfile.name}: ${m.replyTo.text.substring(0, 30)}${m.replyTo.text.length > 30 ? '...' : ''}`)
                  ]);
                  msgEl.appendChild(replyEl);
                }
                
                const metaEl = el('div', { class: 'meta' }, [document.createTextNode(who + ' • ' + (formatTime(m.createdAt) || ''))]);
                const textEl = el('div', { class: 'text' }, [document.createTextNode(m.text || '')]);
                
                msgEl.appendChild(metaEl);
                msgEl.appendChild(textEl);
                
                if (currentUser) {
                  const replyBtn = el('button', { 
                    class: 'msg-action-btn',
                    onclick: () => setReplyTo(m, true, true)
                  }, [document.createTextNode('Reply')]);
                  
                  const actionsEl = el('div', { class: 'msg-actions' }, [replyBtn]);
                  msgEl.appendChild(actionsEl);
                }
                
                dmModalMessages.appendChild(msgEl);
              });
              dmModalMessages.scrollTop = dmModalMessages.scrollHeight;
            }
            
            dmModal.showModal();
            console.log('✅ Mobile DM modal opened');
          }, (error) => {
            console.error('❌ Mobile DM listener error:', error);
            dmModalMessages.innerHTML = '<div class="status-msg">Error loading messages</div>';
            dmModal.showModal();
          });
          
        } catch (error) {
          console.error('❌ Error opening mobile DM:', error);
          dmModalMessages.innerHTML = '<div class="status-msg">Failed to load chat</div>';
          dmModal.showModal();
        }
      }

      // Add this function after the openMobileDm function:
async function openDmWith(peerProfile) {
  if (!currentUser) {
    console.log('❌ No user signed in for DM');
    redirectToLogin();
    return;
  }
  
  console.log('💻 Opening desktop DM with:', peerProfile.name);
  selectedPeer = peerProfile;
  
  // Update header with profile button
  dmHeader.innerHTML = `
    <div style="display: flex; align-items: center; gap: 1rem;">
      <strong>Chat with ${peerProfile.name || 'Unknown'}</strong>
      <button class="btn btn-outline" onclick="openProfileModal('${peerProfile.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
        View Profile
      </button>
    </div>
  `;
  
  dmMessagesEl.innerHTML = '<div class="status-msg">Loading messages...</div>';
  
  // Mark conversation as read
  markConversationAsRead(peerProfile.id);
  
  try {
    if (dmUnsub) {
      dmUnsub();
      dmUnsub = null;
    }
    
    const ref = await ensureThread(peerProfile.id);
    console.log('📡 Setting up desktop DM listener for thread:', ref.path);
    
    const msgsRef = collection(ref, 'messages');
    
    dmUnsub = onSnapshot(query(msgsRef, orderBy('createdAt', 'asc'), limit(500)), (snap) => {
      console.log('📨 Desktop DM messages received:', snap.size);
      dmMessagesEl.innerHTML = '';
      
      if (snap.empty) {
        dmMessagesEl.innerHTML = '<div class="status-msg">Start your conversation</div>';
      } else {
        snap.forEach((d) => {
          const m = { id: d.id, ...d.data() };
          const isMe = currentUser && m.senderUid === currentUser.uid;
          const who = isMe ? 'You' : (peerProfile.name || 'Them');
          
          const msgEl = el('div', { class: 'msg' + (isMe ? ' me' : '') });
          
          if (m.replyTo) {
            const replyEl = el('div', { class: 'reply-indicator' }, [
              document.createTextNode(`↳ ${m.replyTo.senderUid === currentUser.uid ? 'You' : peerProfile.name}: ${m.replyTo.text.substring(0, 30)}${m.replyTo.text.length > 30 ? '...' : ''}`)
            ]);
            msgEl.appendChild(replyEl);
          }
          
          const metaEl = el('div', { class: 'meta' }, [
            el('span', { class: 'username', onclick: () => openProfileModal(peerProfile.id) }, [document.createTextNode(who)]),
            document.createTextNode(' • ' + (formatTime(m.createdAt) || ''))
          ]);
          const textEl = el('div', { class: 'text' }, [document.createTextNode(m.text || '')]);
          
          msgEl.appendChild(metaEl);
          msgEl.appendChild(textEl);
          
          if (currentUser) {
            const replyBtn = el('button', { 
              class: 'msg-action-btn',
              onclick: () => setReplyTo(m, true, false)
            }, [document.createTextNode('Reply')]);
            
            const actionsEl = el('div', { class: 'msg-actions' }, [replyBtn]);
            msgEl.appendChild(actionsEl);
          }
          
          dmMessagesEl.appendChild(msgEl);
        });
        dmMessagesEl.scrollTop = dmMessagesEl.scrollHeight;
      }
      
      console.log('✅ Desktop DM messages rendered');
    }, (error) => {
      console.error('❌ Desktop DM listener error:', error);
      dmMessagesEl.innerHTML = '<div class="status-msg">Error loading messages</div>';
    });
    
  } catch (error) {
    console.error('❌ Error opening desktop DM:', error);
    dmMessagesEl.innerHTML = '<div class="status-msg">Failed to load chat</div>';
  }
}

      function closeMobileDm() {
        if (dmModalUnsub) {
          dmModalUnsub();
          dmModalUnsub = null;
        }
        dmModal.close();
        currentModalPeer = null;
        clearReply(true, true);
        dmModalInput.value = '';
      }

      // Event listeners
      tabs.community.addEventListener('click', () => switchTab('community'));
      tabs.dm.addEventListener('click', () => switchTab('dm'));
      
      // signOutBtn is no longer available in the new nav
      // signOutBtn.addEventListener('click', signOutUser);

      replyClose.addEventListener('click', () => clearReply(false));
      dmReplyClose.addEventListener('click', () => clearReply(true));
      dmModalReplyClose.addEventListener('click', () => clearReply(true, true));
      dmModalClose.addEventListener('click', closeMobileDm);

      // Community form
      communityForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('📝 Community form submitted');
        
        const text = communityInput.value.trim();
        if (!currentUser) {
          console.log('❌ No user signed in');
          redirectToLogin();
          return;
        }
        if (!text) {
          console.log('❌ Empty message');
          return;
        }
        if (text.length > 1000) {
          console.log('❌ Message too long');
          return;
        }
        
        try {
          const messageData = {
            text,
            uid: currentUser.uid,
            userId: currentUser.uid,
            displayName: displayNameFromProfile(currentProfile, currentUser.email),
            createdAt: serverTimestamp(),
          };
          
          if (replyingTo) {
            messageData.replyTo = {
              id: replyingTo.id,
              text: replyingTo.text,
              displayName: replyingTo.displayName
            };
          }
          
          console.log('📤 Sending community message:', messageData);
          const docRef = await addDoc(collection(db, 'messages'), messageData);
          console.log('✅ Community message sent with ID:', docRef.id);
          
          communityInput.value = '';
          clearReply(false);
        } catch (error) {
          console.error('❌ Failed to send community message:', error);
          alert('Failed to send message: ' + error.message);
        }
      });

      // Mobile DM form
      dmModalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('📝 Mobile DM form submitted');
        
        if (!currentUser || !currentModalPeer) {
          console.log('❌ Missing user or peer');
          alert('Please sign in to send messages');
          return;
        }
        
        const text = dmModalInput.value.trim();
        if (!text) return;
        if (text.length > 1000) {
          alert('Message too long');
          return;
        }
        
        try {
          const ref = await ensureThread(currentModalPeer.id);
          const messageData = {
            text,
            senderUid: currentUser.uid,
            createdAt: serverTimestamp(),
          };
          
          if (replyingTo) {
            messageData.replyTo = {
              text: replyingTo.text,
              senderUid: replyingTo.senderUid
            };
          }
          
          console.log('📤 Sending mobile DM:', messageData);
          const docRef = await addDoc(collection(ref, 'messages'), messageData);
          console.log('✅ Mobile DM sent with ID:', docRef.id);
          
          dmModalInput.value = '';
          clearReply(true, true);
        } catch (error) {
          console.error('❌ Failed to send mobile DM:', error);
          alert('Failed to send message: ' + error.message);
        }
      });

// Add this event listener after the mobile DM form handler:
// Desktop DM form
dmForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  console.log('📝 Desktop DM form submitted');
  
  if (!currentUser || !selectedPeer) {
    console.log('❌ Missing user or peer');
    alert('Please sign in and select someone to message');
    return;
  }
  
  const text = dmInput.value.trim();
  if (!text) return;
  if (text.length > 1000) {
    alert('Message too long');
    return;
  }
  
  try {
    const ref = await ensureThread(selectedPeer.id);
    const messageData = {
      text,
      senderUid: currentUser.uid,
      createdAt: serverTimestamp(),
    };
    
    if (replyingTo) {
      messageData.replyTo = {
        text: replyingTo.text,
        senderUid: replyingTo.senderUid
      };
    }
    
    console.log('📤 Sending desktop DM:', messageData);
    const docRef = await addDoc(collection(ref, 'messages'), messageData);
    console.log('✅ Desktop DM sent with ID:', docRef.id);
    
    dmInput.value = '';
    clearReply(true, false);
  } catch (error) {
    console.error('❌ Failed to send desktop DM:', error);
    alert('Failed to send message: ' + error.message);
  }
});

      // Initialize auth with comprehensive logging
      console.log('🔄 Initializing authentication...');
      
      initAuth({
        onAuthStateChanged: (user, profile) => {
          console.log('🔄 Auth state changed:', { user: !!user, profile: !!profile });
          currentUser = user;
          currentProfile = profile;
          setAuthUI();
          setupCommunityListener();
          refreshUsersList();
        }
      });

      // Profile Modal functions (simplified for debugging)
      async function loadProfile(uid) {
        if (profileCache.has(uid)) {
          return profileCache.get(uid);
        }
        try {
          const profileRef = doc(db, 'profiles', uid);
          const profileSnap = await getDoc(profileRef);
          if (profileSnap.exists()) {
            const profileData = { id: profileSnap.id, ...profileSnap.data() };
            profileCache.set(uid, profileData);
            return profileData;
          }
          return null;
        } catch (error) {
          console.error('Error loading profile:', error);
          return null;
        }
      }

      const profileModal = document.getElementById('profile-modal');
      const profileModalTitle = document.getElementById('profile-modal-title');
      const profileAvatar = document.getElementById('profile-avatar');
      const profileInfo = document.getElementById('profile-info');

      async function openProfileModal(uid) {
        try {
          const profile = await loadProfile(uid);
          if (!profile) {
            alert('Could not load profile.');
            return;
          }

          profileModalTitle.textContent = profile.name || 'User Profile';
          profileAvatar.textContent = profile.name ? profile.name[0].toUpperCase() : '?';

          profileInfo.innerHTML = '';
          profileInfo.append(
            el('div', { class: 'profile-field' }, [
              el('span', { class: 'label' }, [document.createTextNode('College')]),
              el('span', { class: 'value' }, [document.createTextNode(profile.college || 'N/A')])
            ]),
            el('div', { class: 'profile-field' }, [
              el('span', { class: 'label' }, [document.createTextNode('Semester')]),
              el('span', { class: 'value' }, [document.createTextNode(profile.semester || 'N/A')])
            ])
          );

          const links = el('div', { class: 'profile-links' });
          if (profile.instagram) {
            links.append(el('a', { class: 'profile-link', href: `https://instagram.com/${profile.instagram}`, target: '_blank' }, [document.createTextNode('Instagram')]));
          }
          if (profile.github) {
            links.append(el('a', { class: 'profile-link', href: profile.github, target: '_blank' }, [document.createTextNode('GitHub')]));
          }
          if (profile.linkedin) {
            links.append(el('a', { class: 'profile-link', href: profile.linkedin, target: '_blank' }, [document.createTextNode('LinkedIn')]));
          }
          profileInfo.append(links);

          profileModal.showModal();
        } catch (error) {
          console.error('Error opening profile modal:', error);
          alert('Failed to open profile.');
        }
      }

      // Make functions global
      window.openProfileModal = openProfileModal;

      console.log('✅ Chat application initialized');
    </script>
  </body>
</html>